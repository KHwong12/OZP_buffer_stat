import{n as St}from"./deduplicate.2ecff305.js";import{T as b}from"./InterleavedLayout.3edb4805.js";import{y as Et,u as yt,i as vt,c as Lt,l as Dt,p as Tt,o as Vt,m as Pt,T as xt,h as Mt,a as bt,b as Ft,d as Rt,A as Ut,O as Bt,x as Ct,g as kt,w as Wt,E as Ht,L as zt,B as Xt,F as Gt,I as Kt,U as jt,j as qt,V as Jt,M as _t,S as Qt,k as Yt,q as Zt,v as te,z as ee,C as ne,D as se,G as oe,H as re}from"./BufferView.4090ce60.js";import{bX as ie,eM as ae,dj as pt,aD as E,eS as rt,mo as ce,mp as le,aF as H,e8 as it,dh as G,fd as ue,eK as fe,dk as mt,di as at,eh as ge}from"./index.4188ada5.js";import{O as f}from"./VertexAttribute.5551e0d8.js";import{o as Z}from"./glUtil.345a77b1.js";import"./types.1cdd5066.js";import"./enums.de935fa5.js";import"./VertexElementDescriptor.d386088d.js";function ct(t,e,n){const o=e/3,r=new Uint32Array(n+1),i=new Uint32Array(n+1),p=(s,a)=>{s<a?r[s+1]++:i[a+1]++};for(let s=0;s<o;s++){const a=t[3*s],g=t[3*s+1],d=t[3*s+2];p(a,g),p(g,d),p(d,a)}let c=0,m=0;for(let s=0;s<n;s++){const a=r[s+1],g=i[s+1];r[s+1]=c,i[s+1]=m,c+=a,m+=g}const l=new Uint32Array(6*o),u=r[n],I=(s,a,g)=>{if(s<a){const d=r[s+1]++;l[2*d]=a,l[2*d+1]=g}else{const d=i[a+1]++;l[2*u+2*d]=s,l[2*u+2*d+1]=g}};for(let s=0;s<o;s++){const a=t[3*s],g=t[3*s+1],d=t[3*s+2];I(a,g,s),I(g,d,s),I(d,a,s)}const $=(s,a)=>{const g=2*s,d=a-s;for(let A=1;A<d;A++){const S=l[g+2*A],L=l[g+2*A+1];let w=A-1;for(;w>=0&&l[g+2*w]>S;w--)l[g+2*w+2]=l[g+2*w],l[g+2*w+3]=l[g+2*w+1];l[g+2*w+2]=S,l[g+2*w+3]=L}};for(let s=0;s<n;s++)$(r[s],r[s+1]),$(u+i[s],u+i[s+1]);const h=new Int32Array(3*o),y=(s,a)=>s===t[3*a]?0:s===t[3*a+1]?1:s===t[3*a+2]?2:-1,N=(s,a)=>{const g=y(s,a);h[3*a+g]=-1},v=(s,a,g,d)=>{const A=y(s,a);h[3*a+A]=d;const S=y(g,d);h[3*d+S]=a};for(let s=0;s<n;s++){let a=r[s];const g=r[s+1];let d=i[s];const A=i[s+1];for(;a<g&&d<A;){const S=l[2*a],L=l[2*u+2*d];S===L?(v(s,l[2*a+1],L,l[2*u+2*d+1]),a++,d++):S<L?(N(s,l[2*a+1]),a++):(N(L,l[2*u+2*d+1]),d++)}for(;a<g;)N(s,l[2*a+1]),a++;for(;d<A;)N(l[2*u+2*d],l[2*u+2*d+1]),d++}return h}function C(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:de(t.layout)}}function de(t){const e=new Array;return t.fields.forEach((n,o)=>{const r={...n,constructor:ht(n.constructor)};e.push([o,r])}),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const pe=[Et,yt,vt,Lt,Dt,Tt,Vt,Pt,xt,Mt,bt,Ft,Rt,Ut,Bt,Ct,kt,Wt,Ht,zt,Xt,Gt,Kt,jt,qt,Jt,_t,Qt,Yt,Zt,te,ee,ne,se,oe,re];function ht(t){return`${t.ElementType}_${t.ElementCount}`}const me=new Map;pe.forEach(t=>me.set(ht(t),t));const It=b().vec3f(f.POSITION).u16(f.COMPONENTINDEX).u16(f.U16PADDING),he=b().vec2u8(f.SIDENESS);Z(he);const $t=b().vec3f(f.POSITION0).vec3f(f.POSITION1).u16(f.COMPONENTINDEX).u8(f.VARIANTOFFSET,{glNormalized:!0}).u8(f.VARIANTSTROKE).u8(f.VARIANTEXTENSION,{glNormalized:!0}).u8(f.U8PADDING,{glPadding:!0}).u16(f.U16PADDING,{glPadding:!0}),K=$t.clone().vec3f(f.NORMAL),j=$t.clone().vec3f(f.NORMALA).vec3f(f.NORMALB);f.POSITION0,f.POSITION1,f.COMPONENTINDEX,f.VARIANTOFFSET,f.VARIANTSTROKE,f.VARIANTEXTENSION,f.NORMAL,f.NORMALA,f.NORMALB,f.SIDENESS;class Nt{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?$e:Ie}write(e,n,o){const r=this.edgeHashFunction(o);B.seed=r;const i=B.getIntRange(0,255),p=B.getIntRange(0,this.settings.variants-1),c=.7,m=B.getFloat(),l=255*(.5*Ne(-(1-Math.min(m/c,1))+Math.max(0,m-c)/(1-c),1.2)+.5);e.position0.setVec(n,o.position0),e.position1.setVec(n,o.position1),e.componentIndex.set(n,o.componentIndex),e.variantOffset.set(n,i),e.variantStroke.set(n,p),e.variantExtension.set(n,l)}trim(e,n){return e.slice(0,n)}}const tt=new Float32Array(6),k=new Uint32Array(tt.buffer),D=new Uint32Array(1);function Ie(t){const e=tt;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],D[0]=5381;for(let n=0;n<k.length;n++)D[0]=31*D[0]+k[n];return D[0]}function $e(t){const e=tt;e[0]=x(t.position0[0]),e[1]=x(t.position0[1]),e[2]=x(t.position0[2]),e[3]=x(t.position1[0]),e[4]=x(t.position1[1]),e[5]=x(t.position1[2]),D[0]=5381;for(let n=0;n<k.length;n++)D[0]=31*D[0]+k[n];return D[0]}const lt=1e4;function x(t){return Math.round(t*lt)/lt}function Ne(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}class q{constructor(){this.commonWriter=new Nt}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return K.createBuffer(e)}write(e,n,o){this.commonWriter.write(e,n,o),ae(U,o.faceNormal0,o.faceNormal1),pt(U,U),e.normal.setVec(n,U)}trim(e,n){return this.commonWriter.trim(e,n)}}q.Layout=K,q.glLayout=Z(K,1);class J{constructor(){this.commonWriter=new Nt}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return j.createBuffer(e)}write(e,n,o){this.commonWriter.write(e,n,o),e.normalA.setVec(n,o.faceNormal0),e.normalB.setVec(n,o.faceNormal1)}trim(e,n){return this.commonWriter.trim(e,n)}}J.Layout=j,J.glLayout=Z(j,1);const U=E(),B=new ie,T=-1;var ut;function _(t,e,n,o=ye){const r=t.vertices.position,i=t.vertices.componentIndex,p=rt(o.anglePlanar),c=rt(o.angleSignificantEdge),m=Math.cos(c),l=Math.cos(p),u=Q.edge,I=u.position0,$=u.position1,h=u.faceNormal0,y=u.faceNormal1,N=Ee(t),v=Se(t),s=v.length/4,a=e.allocate(s);let g=0;const d=s,A=n.allocate(d);let S=0,L=0,w=0;const et=ce(0,s),F=new Float32Array(s);le(F,(V,O,M)=>{r.getVec(v[4*O+0],I),r.getVec(v[4*O+1],$),M[O]=ge(I,$)}),et.sort((V,O)=>F[O]-F[V]);const nt=new Array,st=new Array;for(let V=0;V<s;V++){const O=et[V],M=F[O],W=v[4*O+0],Ot=v[4*O+1],P=v[4*O+2],R=v[4*O+3],ot=R===T;if(r.getVec(W,I),r.getVec(Ot,$),ot)H(h,N[3*P+0],N[3*P+1],N[3*P+2]),it(y,h),u.componentIndex=i.get(W),u.cosAngle=G(h,y);else{if(H(h,N[3*P+0],N[3*P+1],N[3*P+2]),H(y,N[3*R+0],N[3*R+1],N[3*R+2]),u.componentIndex=i.get(W),u.cosAngle=G(h,y),we(u,l))continue;u.cosAngle<-.9999&&it(y,h)}L+=M,w++,ot||Ae(u,m)?(e.write(a,g++,u),nt.push(M)):Oe(u,p)&&(n.write(A,S++,u),st.push(M))}const At=new Float32Array(nt.reverse()),wt=new Float32Array(st.reverse());return{regular:{instancesData:e.trim(a,g),lodInfo:{lengths:At}},silhouette:{instancesData:n.trim(A,S),lodInfo:{lengths:wt}},averageEdgeLength:L/w}}function Ae(t,e){return t.cosAngle<e}function we(t,e){return t.cosAngle>e}function Oe(t,e){const n=ue(t.cosAngle),o=Q.fwd,r=Q.ortho;return fe(o,t.position1,t.position0),n*(G(mt(r,t.faceNormal0,t.faceNormal1),o)>0?-1:1)>e}function Se(t){const e=t.faces.length/3,n=t.faces,o=t.neighbors;let r=0;for(let c=0;c<e;c++){const m=o[3*c+0],l=o[3*c+1],u=o[3*c+2],I=n[3*c+0],$=n[3*c+1],h=n[3*c+2];r+=m===T||I<$?1:0,r+=l===T||$<h?1:0,r+=u===T||h<I?1:0}const i=new Int32Array(4*r);let p=0;for(let c=0;c<e;c++){const m=o[3*c+0],l=o[3*c+1],u=o[3*c+2],I=n[3*c+0],$=n[3*c+1],h=n[3*c+2];(m===T||I<$)&&(i[p++]=I,i[p++]=$,i[p++]=c,i[p++]=m),(l===T||$<h)&&(i[p++]=$,i[p++]=h,i[p++]=c,i[p++]=l),(u===T||h<I)&&(i[p++]=h,i[p++]=I,i[p++]=c,i[p++]=u)}return i}function Ee(t){const e=t.faces.length/3,n=t.vertices.position,o=t.faces,r=z.v0,i=z.v1,p=z.v2,c=new Float32Array(3*e);for(let m=0;m<e;m++){const l=o[3*m+0],u=o[3*m+1],I=o[3*m+2];n.getVec(l,r),n.getVec(u,i),n.getVec(I,p),at(i,i,r),at(p,p,r),mt(r,i,p),pt(r,r),c[3*m+0]=r[0],c[3*m+1]=r[1],c[3*m+2]=r[2]}return c}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(ut||(ut={}));const Q={edge:{position0:E(),position1:E(),faceNormal0:E(),faceNormal1:E(),componentIndex:0,cosAngle:0},ortho:E(),fwd:E()},z={v0:E(),v1:E(),v2:E()},ye={anglePlanar:4,angleSignificantEdge:35};class ve{async extract(e){const n=X(e),o=Le(n),r=[n.data.buffer];return{result:De(o,r),transferList:r}}async extractComponentsEdgeLocations(e){const n=X(e),o=Y(n.data,n.skipDeduplicate,n.indices,n.indicesLength),r=_(o,xe,dt),i=[];return{result:C(r.regular.instancesData,i),transferList:i}}async extractEdgeLocations(e){const n=X(e),o=Y(n.data,n.skipDeduplicate,n.indices,n.indicesLength),r=_(o,Pe,dt),i=[];return{result:C(r.regular.instancesData,i),transferList:i}}}function Le(t){const e=Y(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return ft.updateSettings(t.writerSettings),gt.updateSettings(t.writerSettings),_(e,ft,gt)}function X(t){return{data:It.createView(t.dataBuffer),indices:t.indicesType==="Uint32Array"?new Uint32Array(t.indicesBuffer):t.indicesType==="Uint16Array"?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}function De(t,e){return e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:C(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:C(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}function Y(t,e,n,o){if(e)return{faces:n,facesLength:o,neighbors:ct(n,o,t.count),vertices:t};const r=St(t.buffer,t.stride/4,{originalIndices:n,originalIndicesLength:o}),i=ct(r.indices,o,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:i,vertices:It.createView(r.buffer)}}const ft=new q,gt=new J;class Te{allocate(e){return Me.createBuffer(e)}trim(e,n){return e.slice(0,n)}write(e,n,o){e.position0.setVec(n,o.position0),e.position1.setVec(n,o.position1)}}class Ve{allocate(e){return be.createBuffer(e)}trim(e,n){return e.slice(0,n)}write(e,n,o){e.position0.setVec(n,o.position0),e.position1.setVec(n,o.position1),e.componentIndex.set(n,o.componentIndex)}}const Pe=new Te,xe=new Ve,dt={allocate:()=>null,write:()=>{},trim:()=>null},Me=b().vec3f(f.POSITION0).vec3f(f.POSITION1),be=b().vec3f(f.POSITION0).vec3f(f.POSITION1).u16(f.COMPONENTINDEX).u16(f.U16PADDING,{glPadding:!0});function Xe(){return new ve}export{ve as EdgeProcessingWorker,Xe as default,Le as extract,be as extractComponentsEdgeLocationsLayout,Me as extractEdgeLocationsLayout};
