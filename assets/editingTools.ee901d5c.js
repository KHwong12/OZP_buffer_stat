import{I as h,J as u,K as k,N as Ii,bk as xo,fr as Eo,ay as Oo,aU as L,e as c,fs as Ao,d6 as Vt,h as m,eR as To,dq as Po,ft as mr,fu as fr,dY as Ro,aA as ne,eP as ca,fv as ei,ez as Do,bb as St,aO as da,bd as zt,b9 as Me,fw as $o,aD as b,fx as pa,_ as Gi,aF as Z,di as P,eS as rt,eE as Ss,e8 as B,ao as ks,fy as js,ff as Ee,eh as Ka,dj as re,dk as Se,eM as z,fz as vr,fc as ua,fA as yr,bj as lt,aN as N,ar as R,e7 as ga,f8 as ze,eI as Fe,aP as W,eL as Co,dc as ws,aV as qe,eF as ot,aY as _a,fB as Lo,e6 as ma,fC as es,fD as ts,fE as Vi,fF as be,c8 as he,da as ee,fG as pi,eC as bt,fH as Io,fI as Ha,eH as Et,bH as Go,eV as br,aM as Ue,b4 as Q,eW as Mr,f1 as Vo,fJ as zo,fK as Sr,fL as No,fM as Fo,fN as Uo,eo as Pa,ep as Je,ey as ge,fO as Bs,d8 as U,fP as is,bh as qs,b6 as ti,fQ as ae,fR as as,fS as Ho,fT as fa,i as ko,fU as Ys,fV as Ws,fW as Zs,fX as ss,fi as wr,e2 as jo,fY as ns,fZ as Bo,f_ as E,f$ as qo,g0 as Ze,g1 as Yo,g2 as Wo,g3 as Zo,g4 as rs,g5 as Xo,g6 as X,g7 as xr,g8 as Qo,g9 as Jo,ga as Er,gb as Xs,et as Or,b3 as Pe,dh as Ei,gc as xs,fe as Ar,gd as va,ge as Ko,gf as Tr,P as Pr,b7 as si,a$ as Rr,j as el,gg as tl,gh as Dr,er as il,d$ as Es,eK as $r,fg as al,en as Os,dH as Tt,gi as Qs,gj as Js,cU as os,db as sl,gk as nl,gl as rl,gm as ya,aS as ol,gn as Ks,go as ll,fl as Oi,gp as hl,dC as ls,gq as cl,es as dl,d2 as en,gr as tn,gs as an,d3 as pl,gt as ul,a6 as gl,gu as sn,gv as nn,eU as rn,eQ as on,gw as _l,gx as ml,gy as Lt,eg as fl,gz as vl}from"./index.9da382e4.js";import{a as yl,x as bl,_ as Ml,F as Sl,G as wl,n as xl,r as El,b as As,d as Ol,w as Al,p as Ne,C as Si,e as Tl,f as li,D as Zt,g as ht,y as xt,h as Ra,i as ba,R as Pl,M as Rl,j as Ai,k as Ma,m as zi,v as Dl,l as $l,o as Cl,q as Ll,s as Ti,t as ka,u as ln,z as Xi,A as Il}from"./drawSurfaces.e22da837.js";import{r as Ut,t as Cr}from"./vec4f32.8f10672a.js";import{s as Lr,p as Ir,m as Gr,l as Vr,v as zr}from"./Octree.5f16cd20.js";import{v as Pi,h as Sa,j as $t,m as Gl,l as wi,b as Vl,B as zl}from"./lineSegment.901d4e43.js";import{_ as Nl,j as hs,d as Ni,p as ja,e as Fl,h as hn,i as Ul}from"./sphere.f1597b20.js";import{p as hi,_ as Ht,q as ni,Z as Fi,J as Hl}from"./plane.f3b639d8.js";import{o as kl}from"./glUtil.345a77b1.js";import{T as Nr}from"./InterleavedLayout.e9290885.js";import{O as A}from"./VertexAttribute.5551e0d8.js";import{a as jl,o as Oe,e as cs,c as Fr,b as It,n as $,i as Ui,d as ds,f as Hi,g as ki,t as ji,h as H,j as Bl,k as ql,E as Ts,S as Yl,l as Ae,B as Wl,u as Zl,m as D,p as Xl,L as Ur,q as Hr,r as Ql,s as q,v as kr,w as jr,x as Br,y as Ps,z as wa,A as qr,C as Jl,D as Yr,F as Wr,G as ps,H as Kl,I as Zr,J as eh,K as th,M as cn,N as ih,O as ah,P as sh,Q as nh}from"./Matrix4Uniform.b7dc351c.js";import{e as _e,t as rh,o as oh}from"./mat4f64.84d5c445.js";import{n as lh,s as hh,o as ch,a as Ba,r as dn,l as Rs,O as Ds,H as ri,T as V,b as dh,J as ph,m as $s,h as Bi,c as uh,d as Ye,e as us,f as gh,E as pn,g as _h,P as Qi,i as mh,j as un,R as fh,k as Xr,p as vh,K as yh,Z as gn,q as qa,w as bh,t as Mh,u as Sh,v as wh,W as Cs}from"./NativeLineMaterial.2ca4252c.js";import{R as We,E as Qr,F as xh,I as la}from"./enums.de935fa5.js";import{W as qi,s as Ls,c as Yi,o as Da,O as Qe,n as K,b as Eh,E as Jr,h as Kr,d as eo,S as to,f as Oh,l as Ah,e as Th,i as Ph,_ as Rh}from"./requestImageUtils.4ea1aefd.js";import{f as Dh,c as $h}from"./VertexArrayObject.4198c73f.js";import{c as M,f as se,t as Mt,o as _n}from"./vectorStacks.f85d4a03.js";import{r as Ch,e as xa,S as $a,T as mn,X as Lh,E as st,t as Ih,a as Gh,s as Vh,c as zh,b as fn}from"./SnappingContext.24f379b6.js";import{y as Nh,p as Fh,q as Uh}from"./colorUtils.9445c15b.js";import{v as Wi}from"./dehydratedFeatures.98692fb8.js";import{h as Hh}from"./geometryDataUtils.337d3a34.js";import{i as kh}from"./BufferView.9de22bcf.js";import{a as jh}from"./quatf64.ddec7ef6.js";import{G as Xt,H as Bh,X as gt}from"./boundedPlane.2500e48f.js";import{C as qh}from"./GraphicManipulator.81a13ed3.js";import{l as Yh,v as Wh}from"./axisAngleDegrees.16b78055.js";import{w as ui}from"./persistable.1aa521e0.js";import{Q as vn}from"./quat.2f83a288.js";let Zh=t=>({vnodeSelector:"",properties:void 0,children:void 0,text:t.toString(),domNode:null}),io=(t,e,i)=>{for(let a=0,s=e.length;a<s;a++){let n=e[a];Array.isArray(n)?io(t,n,i):n!=null&&n!==!1&&(typeof n=="string"&&(n=Zh(n)),i.push(n))}};function Xh(t,e,i){if(Array.isArray(e))i=e,e=void 0;else if(e&&(typeof e=="string"||e.hasOwnProperty("vnodeSelector"))||i&&(typeof i=="string"||i.hasOwnProperty("vnodeSelector")))throw new Error("h called with invalid arguments");let a,s;return i&&i.length===1&&typeof i[0]=="string"?a=i[0]:i&&(s=[],io(t,i,s),s.length===0&&(s=void 0)),{vnodeSelector:t,properties:e,children:s,text:a===""?void 0:a,domNode:null}}const yn={bottom:"esri-text-overlay-item-anchor-bottom","bottom-right":"esri-text-overlay-item-anchor-bottom-right","bottom-left":"esri-text-overlay-item-anchor-bottom-left",top:"esri-text-overlay-item-anchor-top","top-right":"esri-text-overlay-item-anchor-top-right","top-left":"esri-text-overlay-item-anchor-top-left",center:"esri-text-overlay-item-anchor-center",right:"esri-text-overlay-item-anchor-right",left:"esri-text-overlay-item-anchor-left"};let te=class extends Ii{constructor(t){super(t),this.x=0,this.y=0,this.text="-",this.fontSize=14,this.anchor="center",this.visible=!0,this._backgroundColor="rgba(0, 0, 0, 0.6)",this._textColor="white",this._textShadowColor=[0,0,0],this._textShadowSize=1}get position(){return[this.x,this.y]}set position(t){this._set("x",t[0]),this._set("y",t[1])}get _textShadow(){const[t,e,i]=this._textColor;return`0 0 ${this._textShadowSize}px rgb(${t}, ${e}, ${i})`}get _padding(){return .5*this.fontSize}get _borderRadius(){return this._padding}render(){return Xh("div",{classes:this._cssClasses(),styles:{left:Math.floor(this.x)+"px",top:Math.floor(this.y)+"px",visibility:this.visible?"visible":"hidden",fontSize:this.fontSize+"px",lineHeight:this.fontSize+"px",backgroundColor:this._backgroundColor,color:this._textColor,padding:this._padding+"px",borderRadius:this._borderRadius+"px",textShadow:this._textShadow}},[this.text])}renderCanvas(t){if(!this.visible)return;const e=t.font.replace(/^(.*?)px/,"");t.font=`${this.fontSize}px ${e}`;const i=this._padding,a=this._borderRadius,s=t.measureText(this.text).width,n=this.fontSize,r=Qh[this.anchor];t.textAlign="center",t.textBaseline="middle";const o=s+2*i,l=n+2*i,d=this.x+r.x*o,p=this.y+r.y*l;this._roundedRect(t,d,p,o,l,a),t.fillStyle=this._backgroundColor,t.fill();const g=this.x+(r.x+.5)*o,_=this.y+(r.y+.5)*l;this._renderTextShadow(t,this.text,g,_),t.fillStyle=this._textColor,t.fillText(this.text,g,_)}_renderTextShadow(t,e,i,a){t.lineJoin="miter",t.fillStyle=`rgba(${this._textShadowColor[0]}, ${this._textShadowColor[1]}, ${this._textShadowColor[2]}, ${1/gs.length})`;const s=this._textShadowSize;for(const[n,r]of gs)t.fillText(e,i+s*n,a+s*r)}_roundedRect(t,e,i,a,s,n){t.beginPath(),t.moveTo(e,i+n),t.arcTo(e,i,e+n,i,n),t.lineTo(e+a-n,i),t.arcTo(e+a,i,e+a,i+n,n),t.lineTo(e+a,i+s-n),t.arcTo(e+a,i+s,e+a-n,i+s,n),t.lineTo(e+n,i+s),t.arcTo(e,i+s,e,i+s-n,n),t.closePath()}_cssClasses(){const t={"esri-text-overlay-item":!0};for(const e in yn)t[yn[e]]=this.anchor===e;return t}};h([u()],te.prototype,"x",void 0),h([u()],te.prototype,"y",void 0),h([u()],te.prototype,"position",null),h([u()],te.prototype,"text",void 0),h([u()],te.prototype,"fontSize",void 0),h([u()],te.prototype,"anchor",void 0),h([u()],te.prototype,"visible",void 0),h([u()],te.prototype,"_backgroundColor",void 0),h([u()],te.prototype,"_textColor",void 0),h([u()],te.prototype,"_textShadowColor",void 0),h([u()],te.prototype,"_textShadowSize",void 0),h([u()],te.prototype,"_textShadow",null),h([u()],te.prototype,"_padding",null),h([u()],te.prototype,"_borderRadius",null),te=h([k("esri.views.overlay.TextOverlayItem")],te);const Qh={bottom:{x:-.5,y:-1,textAlign:"center",textBaseline:"bottom"},"bottom-left":{x:0,y:-1,textAlign:"left",textBaseline:"bottom"},"bottom-right":{x:-1,y:-1,textAlign:"right",textBaseline:"bottom"},center:{x:-.5,y:-.5,textAlign:"center",textBaseline:"middle"},left:{x:0,y:-.5,textAlign:"left",textBaseline:"middle"},right:{x:-1,y:-.5,textAlign:"right",textBaseline:"middle"},top:{x:-.5,y:0,textAlign:"center",textBaseline:"top"},"top-left":{x:0,y:0,textAlign:"left",textBaseline:"top"},"top-right":{x:-1,y:0,textAlign:"right",textBaseline:"top"}},gs=[];for(let e=0;e<360;e+=360/16)gs.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);const Jh=te,Kh=3025,ec={default:15,far:25};let je=class extends Ii{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=xo(async i=>{const a=await Eo("esri/core/t9n/Units");Oo(i),this._messagesUnits=a}),e=()=>da(this.context,i=>i.editGeometryOperations);this.own([L(()=>[c(this.context)&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(i=>Ao(e,i,()=>this._update())),Vt(()=>t.abort())])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return m(this._messagesUnits)}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map(t=>t.label.text)}}get _edgeDistancePixels(){return ec[this.edgeDistance]}_update(){this._nextLabelIndex=0;const t=this.context;if(m(t))return void this._destroyUnusedLabels();const{components:e,geometry:i,coordinateHelper:a}=t.editGeometryOperations.data;if(!i)return void this._destroyUnusedLabels();const s=e.length;for(let n=0;n<s;++n){const r=[];if(e[n].iterateVertices(_=>{r.push(a.toXYZ(_.pos))}),n===0&&c(this.stagedVertex)&&r.push(a.toXYZ(this.stagedVertex)),r.length<2)continue;const o=r[0],l=r[r.length-1];i.type==="polygon"&&r.length>2&&!To(o,l)&&r.push(o);const d=s===1&&!Po(r,!1,!1);let p=tc,g=ic;this.toScreenPointArray(t,o,p);for(let _=1;_<r.length;++_){const v=r[_-1],f=r[_];this.toScreenPointArray(t,f,g),this._addLabel(t,v,p,f,g,d),[p,g]=[g,p]}}this._destroyUnusedLabels()}_addLabel(t,e,i,a,s,n){const{label:r}=this._getOrCreateLabel(t);if(!this.visible||mr(i,s)<Kh)return void(r.visible=!1);const o=c(t.graphicState)?t.graphicState.isDraped?"on-the-ground":"absolute-height":fr(t.editGeometryOperations.data.geometry,t.elevationInfo),{spatialReference:l}=t.editGeometryOperations.data,d=yl(e,a,l,o),p=this._messagesUnits,g=Ro(t.view);r.text=c(p)&&c(d)?bl(p,d,g):"",r.visible=!0;const _=s[0]-i[0],v=s[1]-i[1];n?ne(De,-v,_):ne(De,v,-_),ca(De,De),ei(De,De,this._edgeDistancePixels),Do(gi,i,s,.5),St(gi,gi,De),r.position=[gi[0],gi[1]],Math.abs(De[0])>Math.abs(De[1])?r.anchor=De[0]>0?"left":"right":r.anchor=-De[1]<0?"top":"bottom"}_getOrCreateLabel(t){if(this._labelInfos.length>this._nextLabelIndex)return this._labelInfos[this._nextLabelIndex++];const e=new Jh({fontSize:10,anchor:"center"});t.view.overlay.items.add(e);const i={label:e};return this._labelInfos.push(i),this._nextLabelIndex=this._labelInfos.length,i}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){da(this.context,e=>e.view.overlay.items.remove(t)),t.destroy()}};h([u()],je.prototype,"context",void 0),h([u()],je.prototype,"stagedVertex",void 0),h([u()],je.prototype,"visible",void 0),h([u()],je.prototype,"edgeDistance",void 0),h([u()],je.prototype,"updating",null),h([u()],je.prototype,"_messagesUnits",void 0),h([u()],je.prototype,"_edgeDistancePixels",null),je=h([k("esri.views.interactive")],je);const De=zt(),gi=zt(),tc=Me(),ic=Me();let Ea=class extends je{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},a,s=Me()){const{spatialReference:n}=i.data.coordinateHelper;return $o(a,n,e,t,bn),t.state.camera.projectToScreen(bn,s),s}};Ea=h([k("esri.views.3d.interactive.SegmentLabels3D")],Ea);const bn=b();class ao{constructor(e){this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e,this._handle=L(()=>this.view.ready,i=>{this._resourcesCreated&&(i?this._createResources():this._destroyResources())})}applyProps(e){let i=!1;for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.attached=!1,this._handle.remove()}get attached(){return this._attached}set attached(e){e!==this._attached&&this.view._stage&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources())}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.visible||this.updateVisibility(!1)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}}function so(t,e){t.extensions.add("GL_OES_standard_derivatives");const i=t.fragment;i.include(jl),t.include(lh),i.uniforms.add([new Oe("globalAlpha",a=>a.globalAlpha),new cs("glowColor",a=>a.glowColor),new Oe("glowWidth",(a,s)=>a.glowWidth*s.camera.pixelRatio),new Oe("glowFalloff",a=>a.glowFalloff),new cs("innerColor",a=>a.innerColor),new Oe("innerWidth",(a,s)=>a.innerWidth*s.camera.pixelRatio),new Fr("depthMap",(a,s)=>s.linearDepthTexture),new It("nearFar",(a,s)=>s.camera.nearFar),new hh("frameColor")]),i.code.add($`vec4 blendPremultiplied(vec4 source, vec4 dest) {
float oneMinusSourceAlpha = 1.0 - source.a;
return vec4(
source.rgb + dest.rgb * oneMinusSourceAlpha,
source.a + dest.a * oneMinusSourceAlpha
);
}`),i.code.add($`vec4 premultipliedColor(vec3 rgb, float alpha) {
return vec4(rgb * alpha, alpha);
}`),i.code.add($`vec4 laserlineProfile(float dist) {
if (dist > glowWidth) {
return vec4(0.0);
}
float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);
return blendPremultiplied(
premultipliedColor(innerColor, innerAlpha),
premultipliedColor(glowColor, glowAlpha)
);
}`),i.code.add($`bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float depthDiscontinuityAlpha) {
float depth = linearDepthFromTexture(depthMap, uv, nearFar);
if (-depth == nearFar[0]) {
return false;
}
pos = reconstructPosition(gl_FragCoord.xy, depth);
normal = normalize(cross(dFdx(pos), dFdy(pos)));
float ddepth = fwidth(depth);
depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / depth);
return true;
}`),e.contrastControlEnabled?(i.uniforms.add(new Oe("globalAlphaContrastBoost",a=>c(a.globalAlphaContrastBoost)?a.globalAlphaContrastBoost:1)),i.code.add($`float rgbToLuminance(vec3 color) {
return dot(vec3(0.2126, 0.7152, 0.0722), color);
}
vec4 laserlineOutput(vec4 color) {
float backgroundLuminance = rgbToLuminance(texture2D(frameColor, uv).rgb);
float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);
return color * alpha;
}`)):i.code.add($`vec4 laserlineOutput(vec4 color) {
return color * globalAlpha;
}`)}function ac(t){const e=new Ui;e.include(so,t);const{vertex:i,fragment:a}=e;return i.uniforms.add([new ds("modelView",(s,n)=>pa(nc,n.camera.viewMatrix,s.origin)),new ds("proj",(s,n)=>n.camera.projectionMatrix),new Oe("glowWidth",(s,n)=>s.glowWidth*n.camera.pixelRatio),new It("pixelToNDC",(s,n)=>ne(sc,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3]))]),e.attributes.add(A.START,"vec3"),e.attributes.add(A.END,"vec3"),e.attributes.add(A.UP,"vec3"),e.attributes.add(A.EXTRUDE,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vViewStart","vec3"),e.varyings.add("vViewEnd","vec3"),e.varyings.add("vViewPlane","vec4"),i.code.add($`void main() {
vec3 pos = mix(start, end, extrude.x);
vec4 viewPos = modelView * vec4(pos, 1);
vec4 projPos = proj * viewPos;
vec2 ndcPos = projPos.xy / projPos.w;
vec3 viewUp = (modelView * vec4(extrude.y * up, 0)).xyz;
vec4 projPosUp = proj * vec4(viewPos.xyz + viewUp, 1);
vec2 projExtrudeDir = normalize(projPosUp.xy / projPosUp.w - ndcPos);
vec2 lxy = abs(sign(projExtrudeDir) - ndcPos);
ndcPos += length(lxy) * projExtrudeDir;
vec3 worldPlaneNormal = normalize(cross(up, normalize(end - start)));
vec3 viewPlaneNormal = (modelView * vec4(worldPlaneNormal, 0)).xyz;
vViewStart = (modelView * vec4(start, 1)).xyz;
vViewEnd = (modelView * vec4(end, 1)).xyz;
vViewPlane = vec4(viewPlaneNormal, -dot(viewPlaneNormal, vViewStart));
float xPaddingPixels = sign(dot(viewPlaneNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
ndcPos.x += xPaddingPixels * pixelToNDC.x;
uv = ndcPos * 0.5 + 0.5;
gl_Position = vec4(ndcPos, 0, 1);
}`),a.uniforms.add(new Oe("perScreenPixelRatio",(s,n)=>n.camera.perScreenPixelRatio)),a.code.add($`float planeDistancePixels(vec4 plane, vec3 pos, vec3 start, vec3 end) {
vec3 origin = mix(start, end, 0.5);
vec3 basis = end - origin;
vec3 posAtOrigin = pos - origin;
float x = dot(normalize(basis), posAtOrigin);
float y = dot(plane.xyz, posAtOrigin);
float dx = max(abs(x) - length(basis), 0.0);
float dy = y;
float dist = length(vec2(dx, dy));
float width = fwidth(y);
float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
float pixelDist = dist / min(width, maxPixelDistance);
return abs(pixelDist);
}
void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
float distance = planeDistancePixels(vViewPlane, pos, vViewStart, vViewEnd);
vec4 color = laserlineProfile(distance);
float alpha = 1.0 - smoothstep(0.995, 0.999, abs(dot(normal, vViewPlane.xyz)));
gl_FragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);
}`),e}const sc=zt(),nc=_e(),rc=Object.freeze(Object.defineProperty({__proto__:null,build:ac},Symbol.toStringTag,{value:"Module"}));class kt extends Hi{initializeProgram(e){const i=kt.shader.get().build(this.configuration);return new ki(e.rctx,i,kt.attributeLocations)}initializePipeline(){return qi({blending:Ls(We.ONE,We.ONE_MINUS_SRC_ALPHA),colorWrite:Yi})}}kt.shader=new ji(rc,()=>Gi(()=>import("./LaserlinePath.glsl.6fbc5fa0.js"),["assets/LaserlinePath.glsl.6fbc5fa0.js","assets/index.9da382e4.js","assets/index.313b6d72.css","assets/mat4f64.84d5c445.js","assets/Matrix4Uniform.b7dc351c.js","assets/enums.de935fa5.js","assets/Texture.599541db.js","assets/requestImageUtils.4ea1aefd.js","assets/geometryDataUtils.337d3a34.js","assets/triangle.70405bec.js","assets/vectorStacks.f85d4a03.js","assets/quatf64.ddec7ef6.js","assets/lineSegment.901d4e43.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.4198c73f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.9de22bcf.js","assets/quat.2f83a288.js","assets/vec3f32.0772c8d8.js","assets/sphere.f1597b20.js","assets/drawSurfaces.e22da837.js","assets/SnappingContext.24f379b6.js","assets/PointSnappingHint.427009a4.js","assets/plane.f3b639d8.js","assets/drawUtils.fc519f2d.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.98692fb8.js","assets/vec4f32.8f10672a.js","assets/Octree.5f16cd20.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.e9290885.js","assets/types.28f12cac.js","assets/NativeLineMaterial.2ca4252c.js","assets/floatRGBA.b2358e75.js","assets/triangulationUtils.27ba054b.js","assets/deduplicate.c1f3fafb.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.2500e48f.js","assets/colorUtils.9445c15b.js","assets/GraphicManipulator.81a13ed3.js","assets/drapedUtils.765e9a9c.js","assets/axisAngleDegrees.16b78055.js","assets/persistable.1aa521e0.js"])),kt.attributeLocations=new Map([[A.START,0],[A.END,1],[A.UP,2],[A.EXTRUDE,3]]);class Mn{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=b(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const i=new Float64Array(3*e.length);let a=0;for(const s of e)i[a++]=s[0],i[a++]=s[1],i[a++]=s[2];this.buffers=[i]}set buffers(e){if(this._buffers=e,this._buffers.length>0){const i=this._buffers[0],a=3*Math.floor(i.length/3/2);Z(this._origin,i[a+0],i[a+1],i[a+2])}else Z(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const i=this._ensureVAO(e);c(i)&&(e.bindVAO(i),e.drawArrays(Qr.TRIANGLES,0,this._count))}dispose(){c(this._vao)&&this._vao.dispose()}_ensureVAO(e){return m(this._buffers)?null:(m(this._vao)&&(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,i){const a=this._createDataBuffer(i);return this._dirty=!1,new Dh(e,kt.attributeLocations,{data:kl(wn)},{data:$h.createVertex(e,xh.STATIC_DRAW,a)})}_ensureVertexData(e,i){if(!this._dirty)return;const a=this._createDataBuffer(i);e.vertexBuffers.data.setData(a),this._dirty=!1}_numberOfRenderVertices(e){return 3*(2*(e.length/3-1))}_createDataBuffer(e){const i=e.reduce((o,l)=>o+this._numberOfRenderVertices(l),0);this._count=i;const a=wn.createBuffer(i),s=this._origin;let n=0,r=0;for(const o of e){for(let l=0;l<o.length;l+=3){const d=Z(Sn,o[l+0],o[l+1],o[l+2]);l===0?r=this._renderCoordsHelper.getAltitude(d):this._renderCoordsHelper.setAltitude(d,r);const p=this._renderCoordsHelper.worldUpAtPosition(d,oc),g=n+2*l,_=P(Sn,d,s);if(l<o.length-3){a.up.setVec(g,p),a.up.setVec(g+3,p),a.up.setVec(g+5,p);for(let v=0;v<6;v++)a.start.setVec(g+v,_);a.extrude.setValues(g+0,0,-1),a.extrude.setValues(g+1,1,-1),a.extrude.setValues(g+2,1,1),a.extrude.setValues(g+3,0,-1),a.extrude.setValues(g+4,1,1),a.extrude.setValues(g+5,0,1)}if(l>0){a.up.setVec(g-2,p),a.up.setVec(g-4,p),a.up.setVec(g-5,p);for(let v=-6;v<0;v++)a.end.setVec(g+v,_)}}n+=this._numberOfRenderVertices(o)}return a.buffer}}const oc=b(),Sn=b(),wn=Nr().vec3f(A.START).vec3f(A.END).vec3f(A.UP).vec2f(A.EXTRUDE);class Is extends Bl{constructor(){super(...arguments),this.contrastControlEnabled=!1}}h([H()],Is.prototype,"contrastControlEnabled",void 0);class _i extends ql{constructor(e){super(e,"vec3")}}const Gs=rt(6);function lc(t){const e=new Ui;e.extensions.add("GL_OES_standard_derivatives"),e.include(ch),e.include(so,t);const i=e.fragment;return t.heightManifoldEnabled&&i.uniforms.add(new Ba("heightPlane")),t.pointDistanceEnabled&&i.uniforms.add(new Ba("pointDistanceSphere")),t.lineVerticalPlaneEnabled&&(i.uniforms.add(new Ba("lineVerticalPlane")),i.uniforms.add(new _i("lineVerticalStart")),i.uniforms.add(new _i("lineVerticalEnd"))),(t.heightManifoldEnabled||t.pointDistanceEnabled||t.lineVerticalPlaneEnabled)&&i.uniforms.add(new dn("maxPixelDistance")),(t.lineVerticalPlaneEnabled||t.heightManifoldEnabled)&&i.code.add($`float planeDistancePixels(vec4 plane, vec3 pos) {
float dist = dot(plane.xyz, pos) + plane.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),t.pointDistanceEnabled&&i.code.add($`float sphereDistancePixels(vec4 sphere, vec3 pos) {
float dist = distance(sphere.xyz, pos) - sphere.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),t.intersectsLineEnabled&&(i.uniforms.add(new _i("intersectsLineStart")),i.uniforms.add(new _i("intersectsLineEnd")),i.uniforms.add(new _i("intersectsLineDirection")),i.uniforms.add(new dn("intersectsLineRadius")),i.uniforms.add(new Oe("perScreenPixelRatio",(a,s)=>s.camera.perScreenPixelRatio)),i.code.add($`float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
return abs(dist) - radius;
}`)),(t.lineVerticalPlaneEnabled||t.intersectsLineEnabled)&&i.code.add($`bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
vec3 dir = end - start;
float t2 = dot(dir, pos - start);
float l2 = dot(dir, dir);
return t2 >= 0.0 && t2 <= l2;
}`),i.code.add($`void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
vec4 color = vec4(0, 0, 0, 0);`),t.heightManifoldEnabled&&(i.uniforms.add(new It("angleCutoff",a=>Ji(a))),i.code.add($`{
float heightManifoldAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, heightPlane.xyz)));
vec4 heightManifoldColor = laserlineProfile(planeDistancePixels(heightPlane, pos));
color = max(color, heightManifoldColor * heightManifoldAlpha);
}`)),t.pointDistanceEnabled&&(i.uniforms.add(new It("angleCutoff",a=>Ji(a))),i.code.add($`{
float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));
color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);
}`)),t.lineVerticalPlaneEnabled&&(i.uniforms.add(new It("angleCutoff",a=>Ji(a))),i.code.add($`{
if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);
vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));
color = max(color, lineVerticalColor * lineVerticalAlpha);
}
}`)),t.intersectsLineEnabled&&(i.uniforms.add(new It("angleCutoff",a=>Ji(a))),i.code.add($`{
if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));
color = max(color, intersectsLineColor * intersectsLineAlpha);
}
}`)),i.code.add($`gl_FragColor = laserlineOutput(color * depthDiscontinuityAlpha);
}`),e}function Ji(t){const e=c(t.angleCutoff)?t.angleCutoff:Gs;return ne(hc,Math.cos(e),Math.cos(Math.max(0,e-rt(2))))}const hc=zt(),cc=Object.freeze(Object.defineProperty({__proto__:null,defaultAngleCutoff:Gs,build:lc},Symbol.toStringTag,{value:"Module"}));class Ca extends Hi{initializeProgram(e){const i=Ca.shader.get().build(this.configuration);return new ki(e.rctx,i,Ts)}initializePipeline(){return qi({blending:Ls(We.ONE,We.ONE_MINUS_SRC_ALPHA),colorWrite:Yi})}}Ca.shader=new ji(cc,()=>Gi(()=>import("./Laserlines.glsl.621ce51b.js"),["assets/Laserlines.glsl.621ce51b.js","assets/index.9da382e4.js","assets/index.313b6d72.css","assets/Matrix4Uniform.b7dc351c.js","assets/enums.de935fa5.js","assets/Texture.599541db.js","assets/requestImageUtils.4ea1aefd.js","assets/geometryDataUtils.337d3a34.js","assets/triangle.70405bec.js","assets/vectorStacks.f85d4a03.js","assets/quatf64.ddec7ef6.js","assets/mat4f64.84d5c445.js","assets/lineSegment.901d4e43.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.4198c73f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.9de22bcf.js","assets/quat.2f83a288.js","assets/vec3f32.0772c8d8.js","assets/sphere.f1597b20.js","assets/drawSurfaces.e22da837.js","assets/SnappingContext.24f379b6.js","assets/PointSnappingHint.427009a4.js","assets/plane.f3b639d8.js","assets/drawUtils.fc519f2d.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.98692fb8.js","assets/vec4f32.8f10672a.js","assets/Octree.5f16cd20.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.e9290885.js","assets/types.28f12cac.js","assets/NativeLineMaterial.2ca4252c.js","assets/floatRGBA.b2358e75.js","assets/triangulationUtils.27ba054b.js","assets/deduplicate.c1f3fafb.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.2500e48f.js","assets/colorUtils.9445c15b.js","assets/GraphicManipulator.81a13ed3.js","assets/drapedUtils.765e9a9c.js","assets/axisAngleDegrees.16b78055.js","assets/persistable.1aa521e0.js"]));class yi extends Is{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1}}h([H()],yi.prototype,"heightManifoldEnabled",void 0),h([H()],yi.prototype,"pointDistanceEnabled",void 0),h([H()],yi.prototype,"lineVerticalPlaneEnabled",void 0),h([H()],yi.prototype,"intersectsLineEnabled",void 0);const dc=b(),pc=Ss(),uc={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:rt(6),globalAlphaContrastBoost:2,__tagStrict:"NoParameters"};function xn(t,e,i,a){const s=dc,n=pc;Ee(s,e,a),B(n,i),n[3]=0,vr(n,n,a),Ht(s,n,t)}class gc{constructor(e,i={},a={contrastControlEnabled:!1}){this._renderCoordsHelper=e,this._config=a,this._technique=null,this._heightManifoldEnabled=!1,this._heightManifoldTarget=b(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=b(),this._pointDistanceTarget=b(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=Pi(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=Pi(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=b(),this._tempDir=b(),this._tempUp=b(),this._tempVec3A=b(),this._tempVec3B=b(),this._tempVec4=Ss(),this._tempPlane=hi(),this._tempSphere=Nl(),this._parameters=Yl(i,uc)}get renderSlots(){return[this._config.contrastControlEnabled?Ae.LASERLINES_CONTRAST_CONTROL:Ae.LASERLINES]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(e){B(this._heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(e){B(this._pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(e){B(this._pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){Sa(e,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(e){Sa(e,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(e){e!==this._intersectsLineRadius&&(this._intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,c(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){m(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Mn(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){m(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Mn(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(e){Wl(this._parameters,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const i=e.renderContext.rctx;this._quadVAO=Zl(i),this._techniqueRepository=e.shaderTechniqueRepository,this._techniqueConfig=new yi;const a=new Is;a.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(kt,a)}uninitializeRenderContext(){this._quadVAO=ks(this._quadVAO),this._technique=js(this._technique),this._pathVerticalPlaneData=ks(this._pathVerticalPlaneData),this._pathTechnique=js(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.releaseAndAcquire(Ca,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}render(e,i){(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,i),this.pathVerticalPlaneEnabled&&this._renderPath(e)}_renderUnified(e,i){const a=e.rctx,s=a.bindTechnique(i,this._parameters,e.bindParameters);this._bindGlobalUniforms(e,s),this._bindHeightManifoldUniforms(e,s),this._bindPointDistanceUniforms(e,s),this._bindLineVerticalPlaneUniforms(e,s),this._bindIntersectsLineUniforms(e,s),a.bindVAO(this._quadVAO),a.drawArrays(Qr.TRIANGLE_STRIP,0,4)}_renderPath(e){if(m(this._pathVerticalPlaneData)||m(this._pathTechnique))return;const i=e.rctx,a=this._pathTechnique,s=i.bindTechnique(a,{...this._parameters,origin:this._pathVerticalPlaneData.origin},e.bindParameters);this._bindGlobalUniforms(e,s),this._pathVerticalPlaneData.draw(e.rctx)}_bindHeightManifoldUniforms(e,i){if(!this.heightManifoldEnabled)return;const a=this._tempVec3A,s=this._tempPlane,n=e.bindParameters.camera;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,a),xn(s,this._heightManifoldTarget,a,n.viewMatrix),i.setUniform4fv("heightPlane",s)}_bindPointDistanceUniforms(e,i){if(!this._pointDistanceEnabled)return;const a=e.bindParameters.camera,s=this._tempSphere;B(s,this._pointDistanceOrigin),Ee(s,s,a.viewMatrix),s[3]=Ka(this._pointDistanceOrigin,this._pointDistanceTarget),i.setUniform4f("pointDistanceSphere",s[0],s[1],s[2],s[3])}_bindLineVerticalPlaneUniforms(e,i){if(!this._lineVerticalPlaneEnabled)return;const a=this._renderCoordsHelper,s=e.bindParameters.camera,n=this._tempPlane,r=this._tempVec3A,o=this._tempUp,l=this._tempDir,d=this._tempNormal;$t(this._lineVerticalPlaneSegment,.5,r),a.worldUpAtPosition(r,o),re(l,this._lineVerticalPlaneSegment.vector),Se(d,o,l),re(d,d),xn(n,this._lineVerticalPlaneSegment.origin,d,s.viewMatrix),i.setUniform4fv("lineVerticalPlane",n);const p=this._tempVec3A;B(p,this._lineVerticalPlaneSegment.origin),a.setAltitude(p,0),Ee(p,p,s.viewMatrix),i.setUniform3fv("lineVerticalStart",p);const g=this._tempVec3B;z(g,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),a.setAltitude(g,0),Ee(g,g,s.viewMatrix),i.setUniform3fv("lineVerticalEnd",g)}_bindIntersectsLineUniforms(e,i){if(!this._intersectsLineEnabled)return;const a=_c,s=mc,n=e.bindParameters.camera;if(this._intersectsLineInfinite){if(Ir(hs(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),mi),mi.c0=-Number.MAX_VALUE,!Gr(n.frustum,mi))return;Vr(mi,a),zr(mi,s)}else B(a,this._intersectsLineSegment.origin),z(s,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const r=this._tempVec3A;Ee(r,a,n.viewMatrix),i.setUniform3fv("intersectsLineStart",r);const o=this._tempVec4;B(o,this._intersectsLineSegment.vector),this._tempVec4[3]=0,vr(this._tempVec4,this._tempVec4,n.viewMatrix),Ee(s,s,n.viewMatrix),i.setUniform3fv("intersectsLineEnd",s),re(o,o),i.setUniform3f("intersectsLineDirection",o[0],o[1],o[2]),i.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}_bindGlobalUniforms(e,i){const a=e.bindParameters.camera;this._heightManifoldEnabled?i.setUniform1f("maxPixelDistance",2*a.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?i.setUniform1f("maxPixelDistance",2*a.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&i.setUniform1f("maxPixelDistance",2*a.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),i.bindTexture("frameColor",e.offscreenRenderingHelper.mainColorTexture)}_requestRender(){this._context&&this._context.requestRender()}}const mi=Lr(),_c=b(),mc=b();class Ri extends ao{constructor(e){super(e.view),this._angleCutoff=Gs,this._style={},this._heightManifoldTarget=b(),this._heightManifoldEnabled=!1,this._intersectsLine=Pi(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this.renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){c(e)?(B(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(m(e))return void(this.intersectsLine=null);const i=this.view.renderCoordsHelper.worldUpAtPosition(e,fc);this.intersectsLine=Gl(e,i),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){c(e)?(Sa(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=c(e)?Sa(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=c(e)?{origin:ua(e.origin),target:ua(e.target)}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||c(this._pointDistanceLine)||c(this._pathVerticalPlaneBuffers))?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){c(this.renderer)||(this.renderer=new gc(this.view.renderCoordsHelper,void 0,{contrastControlEnabled:!0}),this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this.renderer.renderSlots,this.renderer))}_syncStyle(){m(this.renderer)||(this.renderer.setParameters(this._style),this._style.intersectsLineRadius!=null&&(this.renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){m(this.renderer)||this.renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){m(this.renderer)||(this.renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this.renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){m(this.renderer)||(this.renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this.renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){m(this.renderer)||(this.renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){m(this.renderer)||(this.renderer.pathVerticalPlaneEnabled=c(this._pathVerticalPlaneBuffers)&&this.visible,c(this._pathVerticalPlaneBuffers)&&(this.renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){m(this.renderer)||(this.renderer.lineVerticalPlaneEnabled=c(this._lineVerticalPlaneSegment)&&this.visible,c(this._lineVerticalPlaneSegment)&&(this.renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){m(this.renderer)||(this.renderer.pointDistanceEnabled=c(this._pointDistanceLine)&&this.visible,c(this._pointDistanceLine)&&(this.renderer.pointDistanceOrigin=this._pointDistanceLine.origin,this.renderer.pointDistanceTarget=this._pointDistanceLine.target))}_disposeRenderer(){c(this.renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this.renderer),this.renderer=null)}}const fc=b();class La extends ao{constructor(e){super(e.view),this._resources=null,this._transform=_e()}get object(){return c(this._resources)?this._resources.object:null}get transform(){return this._transform}set transform(e){yr(this._transform,e),c(this._resources)&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(m(this._resources))return;const e=this._resources.object,i=this.view._stage;i.removeMany(e.geometries),e.removeAllGeometries(),this.createGeometries(e),this.visible||e.setVisible(this.visible),i.addMany(e.geometries)}createResources(){this.destroyResources();const e=this.view._stage;if(!e)return;const i=new Rs({isPickable:!1,updatePolicy:Da.SYNC});e.add(i);const a=new Ds({castShadow:!1});a.transformation=this._transform,this.createExternalResources(),this.createGeometries(a),e.addMany(a.geometries),this.forEachExternalMaterial(s=>e.add(s)),e.add(a),i.add(a),this.visible||a.setVisible(!1),this._resources={layer:i,object:a}}destroyResources(){const e=this.view._stage;!m(this._resources)&&e&&(e.remove(this._resources.object),e.remove(this._resources.layer),this.forEachExternalMaterial(i=>{e.remove(i),i.dispose()}),e.removeMany(this._resources.object.geometries),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(e){m(this._resources)||this._resources.object.setVisible(e)}}class Vs extends La{constructor(e){super(e),this._ray=Ni(),this._externalResources=null,this._handles=new lt,this._isWorldDown=!1,this._start=b(),this._end=N(1,0,0),this._width=1,this._color=Ut(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Ut(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=ve.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=D.OccludeAndTransparent,this._fadedExtensions=An,this.applyProps(e)}createExternalResources(){const e=new ri(this.materialParameters);this._handles.add(L(()=>this.view.state.camera,()=>{this._updateGeometry()}));const i=new Ri({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:i}}destroyExternalResources(){c(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){c(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const i=[b(),b()],a=this.extensionType===ve.FADED;a&&i.push(b(),b());const s=a?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,n=V.createPolylineGeometry(i,null,s);e.addGeometry(n,R(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),c(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,B(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),P(this._end,e,this._end),ja(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,ga(this._start,e)||(B(this._start,e),ja(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,ga(this._end,e)||(B(this._end,e),ja(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){ze(e,this._color)||(Fe(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){ze(e,this._innerColor)||(Fe(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=c(e)!==c(this._stipplePattern);this._stipplePattern=e,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(m(e)||m(this._stippleOffColor)||!ze(e,this._stippleOffColor))&&(this._stippleOffColor=c(e)?Cr(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&c(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,c(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,c(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,c(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=W(e,An),this.recreateGeometry()}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){c(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const i=this._extensionType===ve.FADED?this._updateLineSegmentFinite(En):this._updateLineSegmentInfinite(this._extensionType,En);this._updateVertexAttributes(e,i),c(this._externalResources)&&(this._externalResources.laserline.intersectsLine=i)}_updateLineSegmentFinite(e){return wi(this._start,this._end,e)}_updateLineSegmentInfinite(e,i){const a=this.view.state.camera;switch(Ir(this._ray,_t),e){case ve.LINE:_t.c0=-Number.MAX_VALUE;break;case ve.RAY:case ve.GROUND_RAY:{const r=this._ray.origin,o=W(this.view.elevationProvider.getElevation(r[0],r[1],r[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),l=this.view.renderCoordsHelper.getAltitude(r);this._isWorldDown&&l<o&&Co(_t.ray.direction,_t.ray.direction),this._extensionType===ve.GROUND_RAY&&o!=null&&(_t.c1=Math.abs(l-o));break}}if(!Gr(a.frustum,_t))return wi(this._start,this._end,i);const s=Vr(_t,Pt),n=zr(_t,vc);return wi(s,n,i)}_updateVertexAttributes(e,i){const a=e.geometries[0].getMutableAttribute(A.POSITION).data;if(this.extensionType===ve.FADED){const s=$t(i,-this.fadedExtensions.start,Pt);a[0]=s[0],a[1]=s[1],a[2]=s[2];const n=$t(i,0,Pt);a[3]=n[0],a[4]=n[1],a[5]=n[2];const r=$t(i,1,Pt);a[6]=r[0],a[7]=r[1],a[8]=r[2];const o=$t(i,1+this.fadedExtensions.end,Pt);a[9]=o[0],a[10]=o[1],a[11]=o[2]}else{const s=$t(i,0,Pt);a[0]=s[0],a[1]=s[1],a[2]=s[2];const n=$t(i,1,Pt);a[3]=n[0],a[4]=n[1],a[5]=n[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const _t=Lr(),Pt=b(),vc=b(),En=Pi();var ve;(function(t){t[t.LINE=0]="LINE",t[t.RAY=1]="RAY",t[t.GROUND_RAY=2]="GROUND_RAY",t[t.FADED=3]="FADED"})(ve||(ve={}));const On=1/3,An={start:On,end:On};class yc extends La{constructor(e){super(e),this._handles=new lt,this._location=b(),this._direction=N(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Ut(1,0,1,1),this._renderOccluded=D.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){ga(this._location,e)||(B(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){ga(this._direction,e)||(B(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,i){re(this._direction,P(this._direction,i,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){ze(e,this._color)||(Fe(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new ri(this.materialParameters);this._handles.add(L(()=>this.view.state.camera,()=>{this._updateGeometry()})),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const i=V.createPolylineGeometry([b(),b()]),a=V.createPolylineGeometry([b(),b()]),s=R(this._externalResources).material;e.addGeometry(i,s),e.addGeometry(a,s),this._updateVertices(e)}forEachExternalMaterial(e){c(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;m(e)||this._updateVertices(e)}_updateVertices(e){const i=this.view.state.camera;i.projectToScreen(this.location,Ki),z(ke,this.location,this.direction),i.projectToScreen(ke,Bt),ca(Bt,ws(Bt,Bt,Ki)),this._updateVertexAttributes(i,e,0,Ki,Bt,1),this._updateVertexAttributes(i,e,1,Ki,Bt,-1)}_updateVertexAttributes(e,i,a,s,n,r){const o=i.geometryRecords[a],l=o.geometry.getMutableAttribute(A.POSITION).data,d=ei(Tn,ne(Tn,n[1]*r,n[0]*-r),this.offset+this.width/2),p=St(ea,St(ea,St(ea,s,ei(ea,n,this.length/2)),d),d),g=St(Pn,p,ei(Pn,n,-this.length));e.unprojectFromScreen(p,ke),l[0]=ke[0],l[1]=ke[1],l[2]=ke[2],e.unprojectFromScreen(g,ke),l[3]=ke[0],l[4]=ke[1],l[5]=ke[2],i.geometryVertexAttrsUpdated(o)}}const ke=b(),Ki=Me(),Bt=Me(),Tn=Me(),ea=Me(),Pn=Me();class no{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return c(this._resources)?this._resources.object:null}get resources(){return c(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const e=this.resourceFactory.view._stage;if(m(this._resources)||!e)return;const i=this._resources.object;this._resources.external.forEach(s=>{s.type===Xl.Geometry&&e.remove(s)}),i.removeAllGeometries();const a=this.resourceFactory.recreateGeometry(this._resources.external,i,this._resources.layer);e.addMany(a)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this.resourceFactory,i=e.view,a=i._stage;if(!a)return;const s=new Rs({isPickable:!1,updatePolicy:Da.SYNC});a.add(s);const n=new Ds({castShadow:!1}),r=e.createResources(n,s);r.forEach(l=>{a.add(l),l instanceof Ur&&a.loadImmediate(l)}),a.add(n),s.add(n);const o=e.cameraChanged?L(()=>i.state.camera,l=>e.cameraChanged(l),qe):null;this._resources={layer:s,object:n,external:r,cameraHandle:o},this._syncVisible()}_destroyResources(){if(m(this._resources))return;const e=this.resourceFactory.view._stage;e==null||e.remove(this._resources.object),e==null||e.remove(this._resources.layer),this._resources.external.forEach(i=>{e==null||e.remove(i),"dispose"in i&&i.dispose()}),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){m(this._resources)||this._resources.object.setVisible(this._visible)}}class _s{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=ot(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=ot(1,1,1,1),this._elevationInfo=null,this.resources=new no({view:e.view,createResources:a=>this._createResources(a),recreateGeometry:(a,s)=>(a.geometry=this._recreateGeometry(s,a.material),c(a.geometry)?[a.geometry]:[])});let i=!0;for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e}get attached(){return this.resources.attached}set attached(e){this.resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const i=this.preferredTextureSize;this._size=e,i<this.preferredTextureSize?c(this.resources)&&this.resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){ze(e,this._color)||(Fe(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,c(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){ze(e,this._outlineColor)||(Fe(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources&&this.resources.recreateGeometry()}_updateMaterial(){const e=this.resources.resources;m(e)||e.material.setParameters(this._materialParameters(e.texture.id))}_updateSizeAttribute(){const e=this.resources.resources,i=this.resources.object;if(m(e)||m(i))return;const a=e.geometry;if(m(a))return;const s=a.getMutableAttribute(A.SIZE).data,n=this.geometrySize;s[0]=n,s[1]=n,i.geometryVertexAttrsUpdated(i.geometryRecords[0])}_materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:bc,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/bi}_recreateGeometry(e,i){const a=this._createRenderGeometry();return c(a)&&e.addGeometry(a,i),a}_createResources(e){const i=dh(this._primitive,this.preferredTextureSize),a=new ph(this._materialParameters(i.id)),s=this._recreateGeometry(e,a);return{material:a,texture:i,geometry:s,forEach(n){n(i),n(a),c(this.geometry)&&n(this.geometry)}}}get preferredTextureSize(){return _a(Lo(2*this.geometrySize),16,128)}calculateMapBounds(e){if(m(this.resources.resources)||m(this.resources.resources.geometry))return!1;const i=this.resources.resources.geometry.vertexAttributes.get(A.POSITION);return ma(i.data,this.view.renderCoordsHelper.spatialReference,Rn,this.view.spatialReference),es(e,Rn),!0}_createRenderGeometry(){const e=this.geometry;if(m(e))return null;const{renderCoordsHelper:i,elevationProvider:a}=this.view,s=$s(e,a,Bi.fromElevationInfo(this.elevationInfo),i),n=Z(M.get(),e.x,e.y,s),r=M.get();ma(n,e.spatialReference,r,i.spatialReference);const o=this.geometrySize;return V.createPointGeometry(null,r,null,[o,o],[0,0,0,1])}}const bi=uh,bc=[bi/2,bi/2,1-bi/2,1-bi/2],Rn=b();class Mc extends La{constructor(e){super(e),this._handles=new lt,this._quadMaterial=null,this._outlineMaterial=null,this._maxSize=0,this._position=b(),this._up=b(),this._right=b(),this._renderOccluded=D.OccludeAndTransparent,this._color=Ut(1,0,0,1),this._outlineColor=Ut(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=D.Opaque,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){Fe(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){Fe(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const i=this._outlineSize===0!=(e===0);this._outlineSize=e,i?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:i,next:a}){this._maxSize=Math.min(Ka(i,e),Ka(i,a))/3,re(this._up,P(this._up,e,i)),re(this._right,P(this._right,a,i)),B(this._position,i),this.recreateGeometry()}createExternalResources(){this._quadMaterial=new Ye(this.quadMaterialParameters),this._outlineMaterial=new ri(this.outlineMaterialParameters),this._handles.add(L(()=>this.view.state.camera,()=>this._updateTransform()))}destroyExternalResources(){this._quadMaterial=null,this._outlineMaterial=null,this._handles.removeAll()}forEachExternalMaterial(e){e(this._quadMaterial),e(this._outlineMaterial)}createGeometries(e){this._createQuadGeometry(e),this._createOutlineGeometry(e),this._updateTransform(e)}_createQuadGeometry(e){const i=this._quadGeometryData(this._up,this._right);e.addGeometry(i,this._quadMaterial)}_createOutlineGeometry(e){if(this._outlineSize===0)return;const i=z(M.get(),this._up,this._right),a=V.createPolylineGeometry([this._up,i,this._right]);e.addGeometry(a,this._outlineMaterial)}_updateTransform(e=this.object){const i=this.view.state.camera,a=this._size*i.computeScreenPixelSizeAt(this._position),s=Math.min(this._maxSize,a);ts(ta,this._position),Vi(ta,ta,[s,s,s]),c(e)&&(e.transformation=ta)}_quadGeometryData(e,i){const a=z(M.get(),e,i);return new Hr([[A.POSITION,{size:3,data:[0,0,0,...i,...e,...a],exclusive:!0}]],[[A.POSITION,new Uint16Array([0,1,2,1,2,3])]])}get quadMaterialParameters(){return{color:this._color,transparent:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded}}_updateQuadMaterial(){this._quadMaterial&&this._quadMaterial.setParameters(this.quadMaterialParameters)}get outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded}}_updateOutlineMaterial(){this._outlineMaterial&&this._outlineMaterial.setParameters(this.outlineMaterialParameters)}}const ta=_e();class Di extends Ch{visualizeIntersectionPoint(e,i){const{coordinateHelper:a,view:s}=i;return be(new _s({view:s,primitive:"circle",geometry:a.vectorToPoint(e.intersectionPoint),elevationInfo:W(e.elevationInfo,i.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:he.toUnitRGBA(ee.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,i){const{coordinateHelper:a,view:s}=i;return be(new _s({view:s,primitive:"circle",geometry:a.vectorToPoint(e.point),elevationInfo:W(e.elevationInfo,i.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:he.toUnitRGBA(ee.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{coordinateHelper:a,view:s}=i;return be(this._createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,a,W(e.elevationInfo,i.elevationInfo),s,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){const{coordinateHelper:a,view:s}=i,n=W(e.elevationInfo,i.elevationInfo),r=pi(e.lineStart,a,n,i.view),o=pi(e.lineEnd,a,n,i.view),l=bt(o,r,o,.5),d=new yc({view:s,attached:!1,offset:ee.parallelLineHintOffset,length:ee.parallelLineHintLength,width:ee.parallelLineHintWidth,color:he.toUnitRGBA(ee.orange),location:l,renderOccluded:D.Opaque});return d.setDirectionFromPoints(r,l),d.attached=!0,be(d)}visualizeRightAngleQuad(e,i){const{coordinateHelper:a,view:s}=i,n=W(e.elevationInfo,i.elevationInfo);return be(new Mc({view:s,attached:!0,color:he.toUnitRGBA(ee.orange),renderOccluded:D.Transparent,outlineRenderOccluded:D.Opaque,outlineColor:he.toUnitRGBA(ee.orange),outlineSize:ee.rightAngleHintOutlineSize,size:ee.rightAngleHintSize,geometry:{previous:pi(e.previousVertex,a,n,s),center:pi(e.centerVertex,a,n,s),next:pi(e.nextVertex,a,n,s)}}))}_createLineSegmentHintFromMap(e,i,a,s,n,r,o=!0,l=!0){const d=b(),p=b();return Io(i,a,s,n,r,d,p),this._createLineSegmentHint(e,r,d,p,o,l)}_createLineSegmentHint(e,i,a,s,n=!0,r=!0){const o=new Vs({view:i,extensionType:ve.FADED,start:a,end:s,color:he.toUnitRGBA(ee.orange),renderOccluded:D.Opaque});switch(e){case Ha.TARGET:o.width=ee.lineHintWidthTarget,o.fadedExtensions={start:0,end:ee.lineHintFadedExtensions};break;case Ha.REFERENCE_EXTENSION:o.width=ee.lineHintWidthReference,o.fadedExtensions={start:0,end:0};break;case Ha.REFERENCE:o.width=ee.lineHintWidthReference,o.fadedExtensions={start:n?ee.lineHintFadedExtensions:0,end:r?ee.lineHintFadedExtensions:0}}return o.attached=!0,o}}const T={main:new he([255,127,0]),selected:new he([255,255,255]),staged:new he([12,207,255]),outline:new he([0,0,0,.5]),selectedOutline:new he([255,255,255])},ii=.3;function $i(t,e){const i=t.clone();return i.a*=e,i}function Sc(t,e){const i=t.clone(),a=Nh(i);a.s*=e;const s=Fh(a);return i.r=s.r,i.g=s.g,i.b=s.b,i}function Re(t,e){if(e)for(const i in e)t[i]=e[i]}class wc{constructor(e){this.color=T.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=D.Opaque,Re(this,e)}}class Ya{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=T.main,this.outlineColor=T.outline,this.renderOccluded=D.Opaque,this.hoverOutlineColor=T.selectedOutline,Re(this,e)}apply(e,i){const a=this[e];i.setParameters({color:wt(a),transparent:e!=="color"||a.a<1,renderOccluded:this.renderOccluded})}}class xc{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=$i(T.main,.5),this.hoverColor=T.main,this.renderOccluded=D.Transparent,this.minSquaredEdgeLength=900,Re(this,e)}apply(e,i){const a=this[e];i.setParameters({color:wt(a),transparent:a.a<1,renderOccluded:this.renderOccluded})}}class Ec{constructor(e){this.vertex=new Ya({color:T.main,outlineColor:T.outline}),this.edge=new Ya({color:Sc($i(T.main,2/3),.5),outlineColor:$i(T.outline,.5),size:8,collisionPadding:8}),this.selected=new Ya({color:T.selected,outlineColor:T.outline}),this.edgeOffset=new xc,Re(this,e)}}class ms{constructor(e){this.color=T.selected,this.width=1.5,this.stipplePattern=us(5),this.stippleOffColor=T.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=T.selected,this.renderOccluded=D.OccludeAndTransparent,Re(this,e)}apply(e){e.color=wt(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=wt(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=wt(this.innerColor),e.renderOccluded=this.renderOccluded}}class Oc{constructor(e){this.color=T.selected,this.size=4,this.outlineSize=1,this.outlineColor=T.outline,this.shape="square",Re(this,e)}apply(e){e.color=wt(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=wt(this.outlineColor),e.primitive=this.shape}}class Oa{constructor(e){this.innerColor=T.selected,this.innerWidth=1,this.glowColor=T.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=ii,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=T.main,Re(this,e)}apply(e,i=1){const a={glowColor:he.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:he.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=a:e.laserlineStyle=a}}class Ac{constructor(e){this.outline=new ms({color:T.outline,renderOccluded:D.OccludeAndTransparentStencil,stippleOffColor:T.selected,stipplePattern:us(5),width:1.5,innerWidth:0}),this.staged=new ms({color:T.selected,renderOccluded:D.OccludeAndTransparentStencil,innerColor:T.staged,stippleOffColor:T.outline,stipplePattern:us(5),width:1.5}),this.shadowStyle=new Oa({globalAlpha:ii,glowColor:T.main,glowFalloff:8,glowWidth:8,innerColor:T.selected,innerWidth:1}),Re(this,e)}}class Tc{constructor(e){this.outline=new Oc({color:T.selected,outlineColor:T.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Oa({globalAlpha:ii,glowColor:T.main,glowFalloff:1.5,glowWidth:6,innerColor:T.selected,innerWidth:1,radius:2}),Re(this,e)}}class Pc extends ms{constructor(e){super(),this.extensionType=ve.GROUND_RAY,Re(this,e)}}class Rc{constructor(e){this.lineGraphics=new Ac,this.pointGraphics=new Tc,this.heightPlane=new Oa({globalAlpha:ii,glowColor:T.main,glowFalloff:8,glowWidth:8,innerColor:T.selected,innerWidth:1}),this.heightBox=new Oa({globalAlpha:ii,glowColor:T.main,glowFalloff:8,glowWidth:8,innerColor:T.selected,innerWidth:0,heightFillColor:T.main}),this.zVerticalLine=new Pc({color:$i(T.main,5*ii/3),falloff:2,innerColor:$i(T.selected,0),renderOccluded:D.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:ve.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,Re(this,e)}}class Dc{constructor(e){this.visualElements=new Rc,this.reshapeManipulators=new Ec,this.zManipulator=new wc,Re(this,e)}colorToVec4(e){return wt(e)}}function wt(t){return Et(he.toUnitRGBA(t))}const y=new Dc;class $c{constructor(e){this.resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get resources(){return c(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){this.resourceFactory.recreateGeometry?m(this._resources)||(this._ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?m(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var s;this._destroyResources();const e=this.resourceFactory.createResources(),i=new Qt({view:this.resourceFactory.view}),a=(s=this.resourceFactory.view.basemapTerrain)==null?void 0:s.overlayManager;this._resources={layerView:new Qt({view:this.resourceFactory.view}),external:e,geometriesAdded:!1},a&&(this._resources.drapeSourceRenderer=a.registerGeometryDrapeSource(i)),this._syncGeometriesToRenderer()}_destroyResources(){var i;if(m(this._resources))return;this._ensureRenderGeometriesRemoved();const e=(i=this.resourceFactory.view.basemapTerrain)==null?void 0:i.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){m(this._resources)||m(this._resources.drapeSourceRenderer)||!this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,pn.Geometry.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){m(this._resources)||m(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,pn.Geometry.UPDATE),this._resources.geometriesAdded=!0)}}let Qt=class extends Go(Ii){constructor(t){super(t),this.drapeSourceType=gh.Features,this.updatePolicy=Da.SYNC}};h([u({constructOnly:!0})],Qt.prototype,"view",void 0),h([u({readOnly:!0})],Qt.prototype,"drapeSourceType",void 0),Qt=h([k("DrapedVisualElementLayerView")],Qt);class jt{constructor(e){this.view=null,this._attachmentOrigin=Wi(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new Ue,this._isDraped=!1,this._geometry=null,this._width=1,this._color=Ut(1,0,1,1),this._innerWidth=0,this._innerColor=Ut(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=D.OccludeAndTransparentStencil,this.resources=new no({view:e.view,createResources:a=>this._createResources(a),recreateGeometry:(a,s)=>(a.geometries.length=0,this._recreateGeometry(s,a.material,a.geometries),a.geometries)}),this._attachmentOrigin.spatialReference=e.view.spatialReference,this.drapedResources=new $c({view:e.view,createResources:()=>this._createDrapedResources(),recreateGeometry:a=>{a.geometries=this._createRenderGeometriesDraped(a.material),this._attachmentOriginChanged()}});let i=!0;this._laserline=new Ri({view:e.view});for(const a in e)a in this?a==="attached"?i=e[a]:this[a]=e[a]:console.error("Cannot set unknown property",a);this.attached=i}destroy(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this._updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}get laserlineAttached(){return this.attached&&this.visible&&c(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}get visible(){return this.resources.visible}set visible(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}get attached(){return this.resources.attached||this.drapedResources.attached}set attached(e){this._updateAttached(e)}_updateAttached(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this._attachmentOriginChanged()}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){ze(e,this._color)||(Fe(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){ze(e,this._innerColor)||(Fe(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=c(e)!==c(this._stipplePattern);this._stipplePattern=e,i?this.resources.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e&&this._stippleOffColor&&ze(e,this._stippleOffColor)||(this._stippleOffColor=e?Cr(e):null,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.resources.recreateGeometry()}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,c(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get attachmentOrigin(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;const e=c(this.resources.resources)?this.resources.resources.geometries:null;if(!e||e.length===0)return null;Z(qt,0,0,0);let i=0;for(const a of e){const s=a.vertexAttributes.get(A.POSITION),n=a.indices.get(A.POSITION),r=R(this.resources.resources).material.isClosed(s.data,n);Hh(s,n,r,Dn)&&(z(qt,qt,Dn),i++)}return i===0?null:(Q(qt,qt,1/i),this.view.renderCoordsHelper.fromRenderCoords(qt,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}_updateMaterial(){c(this.resources.resources)&&this.resources.resources.material.setParameters(this.materialParameters),c(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameters(this.materialParameters)}get isClosed(){return c(this.geometry)&&this.geometry.type==="polygon"}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:!1,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",hasPolygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}get normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===D.OccludeAndTransparentStencil?D.OccludeAndTransparent:this._renderOccluded}_recreateGeometry(e,i,a){const s=this._createRenderGeometries();for(const n of s)e.addGeometry(n,i),a.push(n);this._attachmentOriginChanged()}_attachmentOriginChanged(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}_createResources(e){const i=new ri(this.materialParameters),a=[];return this._recreateGeometry(e,i,a),{material:i,geometries:a,forEach:s=>{s(i),a.forEach(s)}}}_createDrapedResources(){const e=new ri(this.materialParameters);return{material:e,geometries:this._createRenderGeometriesDraped(e)}}_createRenderGeometriesDraped(e){const i=this.geometry;if(m(i))return[];const a=_h(i,this.view.basemapTerrain.spatialReference),s=[];for(const{position:n}of a.lines){const r={overlayInfo:{spatialReference:this.view.basemapTerrain.spatialReference,renderCoordsHelper:this.view.renderCoordsHelper},attributeData:{position:n},removeDuplicateStartEnd:this.isClosed?Qi.REMOVE:Qi.KEEP},o=new mh(un(r),e),l=Mr(Cc);es(l,n),Vo(o.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),s.push(o)}return s}calculateMapBounds(e){if(m(this.resources.resources))return!1;const i=this.view.renderCoordsHelper;for(const a of this.resources.resources.geometries){const s=a.vertexAttributes.get(A.POSITION),n=new Float64Array(s.data.length);zo(s.data,i.spatialReference,0,n,this.view.spatialReference,0,s.data.length/3),es(e,n)}return!0}_createRenderGeometries(){var n;const e=this.geometry;if(m(e))return[];const i=fh(e,this.view.elevationProvider,this.view.renderCoordsHelper,Bi.fromElevationInfo((n=this.elevationInfo)!=null?n:new Sr({mode:fr(e,null)}))),a=[],s=[];for(const{position:r,mapPosition:o}of i.lines){const l={overlayInfo:null,attributeData:{position:r,mapPosition:o},removeDuplicateStartEnd:this.isClosed?Qi.REMOVE:Qi.KEEP};a.push(un(l)),s.push(r)}return this._laserline.pathVerticalPlane=s,a}}const Cc=br(),Dn=b(),qt=b();function Lc(t,e){if(!e.screenSizeEnabled)return;const i=t.vertex;Ql(i,e),i.uniforms.add(new Oe("perScreenPixelRatio",(a,s)=>s.camera.perScreenPixelRatio)),i.uniforms.add(new Oe("screenSizeScale",a=>a.screenSizeScale)),i.code.add($`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function Ic(t){const e=new Ui,i=t.hasMultipassTerrain&&(t.output===q.Color||t.output===q.Alpha);e.include(kr),e.include(Lc,t),e.include(jr,t);const{vertex:a,fragment:s}=e;return s.include(Br),Ps(e,t),s.uniforms.add(new wa("uColor",n=>n.color)),e.attributes.add(A.POSITION,"vec3"),e.varyings.add("vWorldPosition","vec3"),i&&e.varyings.add("depth","float"),t.screenSizeEnabled&&e.attributes.add(A.OFFSET,"vec3"),t.shadingEnabled&&(a.uniforms.add(new ds("viewNormal",(n,r)=>r.camera.viewInverseTransposeMatrix)),e.attributes.add(A.NORMAL,"vec3"),e.varyings.add("vViewNormal","vec3")),a.code.add($`
    void main(void) {
      vWorldPosition = ${t.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),t.shadingEnabled&&a.code.add($`vec3 worldNormal = normal;
vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`),a.code.add($`
    ${i?"depth = (view * vec4(vWorldPosition, 1.0)).z;":""}
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),i&&e.include(qr,t),s.code.add($`
    void main() {
      discardBySlice(vWorldPosition);
      ${i?"terrainDepthTest(gl_FragCoord, depth);":""}
    `),t.shadingEnabled?(s.uniforms.add(new cs("shadingDirection",n=>n.shadingDirection)),s.uniforms.add(new wa("shadedColor",n=>Gc(n.shadingTint,n.color))),s.code.add($`vec3 viewNormalNorm = normalize(vViewNormal);
float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`)):s.code.add($`vec4 finalColor = uColor;`),s.code.add($`
      if (finalColor.a < ${$.float(Jl)}) {
        discard;
      }
      ${t.output===q.Alpha?$`gl_FragColor = vec4(finalColor.a);`:""}

      ${t.output===q.Color?$`gl_FragColor = highlightSlice(finalColor, vWorldPosition); ${t.transparencyPassType===Qe.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    }
    `),e}function Gc(t,e){const i=1-t[3],a=t[3]+e[3]*i;return a===0?(Rt[3]=a,Rt):(Rt[0]=(t[0]*t[3]+e[0]*e[3]*i)/a,Rt[1]=(t[1]*t[3]+e[1]*e[3]*i)/a,Rt[2]=(t[2]*t[3]+e[2]*e[3]*i)/a,Rt[3]=e[3],Rt)}const Rt=Ss(),Vc=Object.freeze(Object.defineProperty({__proto__:null,build:Ic},Symbol.toStringTag,{value:"Module"}));class Ia extends Hi{initializeProgram(e){const i=Ia.shader.get().build(this.configuration);return new ki(e.rctx,i,ro)}_setPipelineState(e){const i=this.configuration,a=e===Qe.NONE,s=e===Qe.FrontFace;return qi({blending:i.output!==q.Color&&i.output!==q.Alpha||!i.transparent?null:a?Eh:Jr(e),culling:Kr(i.cullFace),depthTest:{func:s?la.LESS:i.shadingEnabled?la.LEQUAL:la.LESS},depthWrite:a?i.writeDepth&&eo:to(e),colorWrite:Yi,polygonOffset:a||s?null:Oh})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}Ia.shader=new ji(Vc,()=>Gi(()=>import("./ShadedColorMaterial.glsl.32413d3a.js"),["assets/ShadedColorMaterial.glsl.32413d3a.js","assets/index.9da382e4.js","assets/index.313b6d72.css","assets/Matrix4Uniform.b7dc351c.js","assets/enums.de935fa5.js","assets/Texture.599541db.js","assets/requestImageUtils.4ea1aefd.js","assets/geometryDataUtils.337d3a34.js","assets/triangle.70405bec.js","assets/vectorStacks.f85d4a03.js","assets/quatf64.ddec7ef6.js","assets/mat4f64.84d5c445.js","assets/lineSegment.901d4e43.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.4198c73f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.9de22bcf.js","assets/quat.2f83a288.js","assets/vec3f32.0772c8d8.js","assets/sphere.f1597b20.js","assets/drawSurfaces.e22da837.js","assets/SnappingContext.24f379b6.js","assets/PointSnappingHint.427009a4.js","assets/plane.f3b639d8.js","assets/drawUtils.fc519f2d.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.98692fb8.js","assets/vec4f32.8f10672a.js","assets/Octree.5f16cd20.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.e9290885.js","assets/types.28f12cac.js","assets/NativeLineMaterial.2ca4252c.js","assets/floatRGBA.b2358e75.js","assets/triangulationUtils.27ba054b.js","assets/deduplicate.c1f3fafb.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.2500e48f.js","assets/colorUtils.9445c15b.js","assets/GraphicManipulator.81a13ed3.js","assets/drapedUtils.765e9a9c.js","assets/axisAngleDegrees.16b78055.js","assets/persistable.1aa521e0.js"]));class $e extends Yr{constructor(){super(...arguments),this.output=q.Color,this.cullFace=K.None,this.transparencyPassType=Qe.NONE,this.hasSlicePlane=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}h([H({count:q.COUNT})],$e.prototype,"output",void 0),h([H({count:K.COUNT})],$e.prototype,"cullFace",void 0),h([H({count:Qe.COUNT})],$e.prototype,"transparencyPassType",void 0),h([H()],$e.prototype,"hasSlicePlane",void 0),h([H()],$e.prototype,"transparent",void 0),h([H()],$e.prototype,"writeDepth",void 0),h([H()],$e.prototype,"screenSizeEnabled",void 0),h([H()],$e.prototype,"shadingEnabled",void 0),h([H()],$e.prototype,"hasMultipassTerrain",void 0),h([H()],$e.prototype,"cullAboveGround",void 0);const ro=new Map([[A.POSITION,0],[A.NORMAL,1],[A.OFFSET,2]]);class fs extends Wr{constructor(e){super(e,new Nc),this.supportsEdges=!0,this.techniqueConfig=new $e,this._vertexAttributeLocations=ro}getConfiguration(e,i){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.screenSizeEnabled=this.parameters.screenSizeEnabled,this.techniqueConfig.shadingEnabled=this.parameters.shadingEnabled,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this.techniqueConfig}intersect(e,i,a,s,n,r,o){if(this.parameters.screenSizeEnabled){const l=e.vertexAttributes.get(A.OFFSET);ps(e,i,s,n,r,{applyToVertex:(p,g,_,v)=>{const f=Z($n,l.data[3*v+0],l.data[3*v+1],l.data[3*v+2]),S=Z(Uc,p,g,_);return Q(f,f,this.parameters.screenSizeScale*s.camera.computeRenderPixelSizeAt(f)),z(S,S,f),[S[0],S[1],S[2]]},applyToAabb:p=>{const g=Fo(p,$n);return Uo(p,this.parameters.screenSizeScale*s.camera.computeRenderPixelSizeAt(g))}},o)}else ps(e,i,s,n,r,void 0,o)}requiresSlot(e,i){if(Xr(i)===q.Highlight)return e===Ae.OPAQUE_MATERIAL;let a=Ae.OPAQUE_MATERIAL;return this.parameters.transparent&&(a=this.parameters.writeDepth?Ae.TRANSPARENT_MATERIAL:Ae.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===a||e===Ae.DRAPED_MATERIAL}createGLMaterial(e){return e.output===q.Color||e.output===q.Alpha||e.output===q.Highlight?new zc(e):null}createBufferWriter(){return new Fc(this.parameters.screenSizeEnabled)}}class zc extends Kl{beginSlot(e){return this.ensureTechnique(Ia,e)}}class Nc extends Zr{constructor(){super(...arguments),this.color=ot(1,1,1,1),this.shadingTint=ot(0,0,0,.25),this.shadingDirection=re(b(),[.5,-.5,-.5]),this.screenSizeScale=14,this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=K.None,this.screenSizeEnabled=!1,this.shadingEnabled=!0}}class Fc{constructor(e){this.screenSizeEnabled=e;const i=Nr().vec3f(A.POSITION).vec3f(A.NORMAL);this.screenSizeEnabled&&i.vec3f(A.OFFSET),this.vertexBufferLayout=i}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(A.POSITION).length}write(e,i,a,s){if(eh(i,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,a,s),this.screenSizeEnabled){if(!i.vertexAttributes.has(A.OFFSET))throw new Error(`${A.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const n=i.vertexAttributes.get(A.OFFSET),r=i.indices.get(A.OFFSET);No(n.size===3);const o=a.getField(A.OFFSET,kh);if(!o)throw new Error("unable to acquire view for "+A.OFFSET);th(r,n.data,e.invTranspTransformation,o,s)}}}}const $n=b(),Uc=b();class Cn extends La{constructor(e){super(e),this.view=null,this._renderOccluded=D.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=y.colorToVec4(y.reshapeManipulators.vertex.color),this._size=y.reshapeManipulators.vertex.size,this._outlineColor=y.colorToVec4(y.reshapeManipulators.vertex.outlineColor),this._outlineSize=y.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){ze(e,this._color)||(Fe(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){ze(e,this._outlineColor)||(Fe(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this.vertexMaterial.setParameters(this.vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this.vertexOutlineMaterial.setParameters(this.vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(m(e)||e.length===0)return[];const i=.5,a=.5,s=vh(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Bi.fromElevationInfo(this.elevationInfo)),n=[],r=s.numVertices,o=s.position;for(let l=0;l<r;++l){const d=Z(Hc,o[3*l+0],o[3*l+1],o[3*l+2]),p=Ln(i,d),g=Ln(a,d);n.push({vertexGeometry:p,vertexOutlineGeometry:g})}return n}createGeometries(e){const i=this._createRenderGeometries();for(const{vertexGeometry:a,vertexOutlineGeometry:s}of i)e.addGeometry(a,this.vertexMaterial),e.addGeometry(s,this.vertexOutlineMaterial)}createExternalResources(){this.vertexMaterial=new fs({...this.vertexMaterialParameters,writeDepth:!0,cullFace:K.Back,screenSizeEnabled:!0}),this.vertexOutlineMaterial=new fs({...this.vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:K.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}const Hc=b();function Ln(t,e){return V.createSphereGeometry(t,16,16,{offset:e})}let ye=class extends Ue.EventedAccessor{constructor(t){super(t),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};h([u({constructOnly:!0})],ye.prototype,"graphic",void 0),h([u()],ye.prototype,"tracking",void 0),h([u()],ye.prototype,"displaying",void 0),h([u()],ye.prototype,"isDraped",void 0),ye=h([k("esri.views.3d.layers.graphics.GraphicState")],ye);let Ke=class extends Ml{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this.geometryType=null,this.labelOptions=new Pa,this.tooltipOptions=new Je,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Sr({mode:t,offset:e})}normalizeCtorArgs(t){var e;if(!t.elevationInfo){const i=(e=t.hasZ)!=null?e:!0;return{...t,elevationInfo:{mode:i?"absolute-height":"on-the-ground",offset:0}}}return t}initializeGraphic(t){const e=this._createGraphicState=new ye({graphic:t});return ge([this.view.maskOccludee(t),this.view.trackGraphicState(e),L(()=>({element:this._outlineVisualElement,isDraped:e.isDraped}),({element:i,isDraped:a})=>{da(i,s=>s.isDraped=a)},qe)])}makeDrawOperation(){const{geometryType:t}=this,e=t!=="circle"&&t!=="rectangle";return new Sl({view:this.view,manipulators:this.manipulators,geometryType:wl(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new xl(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new El(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new Di,segmentLabels:e?new Ea:null,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Bs(this.hasZ,this.elevationInfo)==="on-the-ground"})}onActiveVertexChanged(t){return c(this._activeVertexVisualElement)?(this._activeVertexVisualElement.vertices=[t],null):(this._activeVertexVisualElement=new Cn({view:this.view,spatialReference:this.view.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:y.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._activeVertexVisualElement.color=y.colorToVec4(y.reshapeManipulators.selected.color),this._activeVertexVisualElement.attached=!0,Vt(()=>{this._activeVertexVisualElement=U(this._activeVertexVisualElement)}))}onOutlineChanged(t){if(c(this._outlineVisualElement))return this._outlineVisualElement.geometry=t,null;const e=this.internalGraphicsLayer.elevationInfo;return this._outlineVisualElement=new jt({view:this.view,geometry:t,elevationInfo:e,isDraped:c(this._createGraphicState)?this._createGraphicState.isDraped:Bs(this.hasZ,e)==="on-the-ground",attached:!1}),y.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),y.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0,Vt(()=>{this._outlineVisualElement=U(this._outlineVisualElement)})}onRegularVerticesChanged(t){return c(this._verticesVisualElement)?(this._verticesVisualElement.vertices=t,null):(this._verticesVisualElement=new Cn({view:this.view,spatialReference:this.view.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,renderOccluded:y.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0,Vt(()=>{this._verticesVisualElement=U(this._verticesVisualElement)}))}};h([u({constructOnly:!0})],Ke.prototype,"elevationInfo",void 0),h([u({constructOnly:!0})],Ke.prototype,"geometryType",void 0),h([u({constructOnly:!0,type:Pa})],Ke.prototype,"labelOptions",void 0),h([u({constructOnly:!0,type:Je})],Ke.prototype,"tooltipOptions",void 0),h([u()],Ke.prototype,"type",void 0),h([u({constructOnly:!0})],Ke.prototype,"view",void 0),Ke=h([k("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Ke);function ai(t,e,i){return kc(t,t.screenToRender(e,is(M.get())),i)}function kc(t,e,i){const a=is(qs(M.get(),e));if(a[2]=0,!t.unprojectFromRenderScreen(a,i.origin))return null;const s=is(qs(M.get(),e));s[2]=1;const n=t.unprojectFromRenderScreen(s,M.get());return m(n)?null:(P(i.direction,n,i.origin),i)}class ce{constructor(e){this.camera=new yh,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=_e(),this._worldFrame=null,this._renderLocation=b(),this._renderLocationDirty=!0,this._location=new ti({x:0,y:0,z:0}),this._elevationAlignedLocation=new ti,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=ae.None,this._focused=!1,this.events=new Ue.EventEmitter,this._screenLocation={screenPointArray:Me(),renderScreenPointArray:as(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayer=null,this._materialIdReferences=null,this._location.spatialReference=e.view.spatialReference;for(const i in e)this[i]=e[i];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}destroy(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,this._noDisplayCount===1&&this._updateEngineObject(),{remove:Ho(()=>{this._noDisplayCount--,this._noDisplayCount===0&&this._updateEngineObject()})}}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){In(e)&&(this._screenLocationDirty=!0),yr(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=_e()),jc(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){gn(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){gn(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;const e=c(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,i){i?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:e===!0?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(In(this._modelTransform)){const i=this._calculateModelTransformOffset(Yc);e=z(i,i,this.renderLocation)}else e=this.renderLocation;this.camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}intersectionDistance(e,i){var r;if(!this.available)return null;const a=fa(e,Bc),s=this._getCollisionRadius(i),n=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(mr(this.screenLocation.screenPointArray,a)<s*s)return this.screenLocation.renderScreenPointArray[2]+n;break;case"line":{const o=this.collisionType.paths,l=this._getWorldToScreenObjectScale(),d=this._calculateObjectTransform(l,ia),p=s*this.screenLocation.pixelSize,g=ai(this.camera,a,Wa);if(m(g))return null;for(const _ of o){if(_.length===0)continue;const v=Ee(xi,_[0],d);for(let f=1;f<_.length;f++){const S=Ee(zn,_[f],d),w=zl(wi(v,S,Gn),g);if(w!=null&&w<p*p){const x=z(M.get(),v,S);Q(x,x,.5);const O=Zs(M.get());return this.camera.projectToRenderScreen(x,O),O[2]+n}B(v,S)}}break}case"disc":{const o=this.collisionType.direction,l=(r=this.collisionType.offset)!=null?r:ss,d=this._getWorldToScreenObjectScale(),p=this._calculateObjectTransform(d,ia),g=s*this.screenLocation.pixelSize,_=ai(this.camera,a,Wa);if(m(_))return null;const v=Ys(Vn,p),f=Ws(Fn,o,v),S=Ee(Un,l,p);Ht(S,f,aa);const w=Nn;if(ni(aa,_,w)&&wr(w,S)<g*g)return this.screenLocation.renderScreenPointArray[2]+n;break}case"ribbon":{const{paths:o,direction:l}=this.collisionType,d=this._getWorldToScreenObjectScale(),p=this._calculateObjectTransform(d,ia),g=s*this.camera.computeScreenPixelSizeAt(this.renderLocation),_=ai(this.camera,a,Wa);if(m(_))return null;const v=Ys(Vn,p),f=Ws(Fn,l,v),S=this._calculateModelTransformPosition(Un);Ht(S,f,aa);const w=Nn;if(!ni(aa,_,w))break;for(const x of o){if(x.length===0)continue;const O=Ee(xi,x[0],p);for(let j=1;j<x.length;j++){const de=Ee(zn,x[j],p),ct=Vl(wi(O,de,Gn),w);if(ct!=null&&ct<g*g){const me=z(M.get(),O,de);Q(me,me,.5);const Ot=Zs(M.get());return this.camera.projectToRenderScreen(me,Ot),Ot[2]+n}B(O,de)}}break}default:ko(this.collisionType)}return null}attach(e={manipulator3D:{}}){var a;if(!this.view._stage)return;const i=e.manipulator3D;if(m(i.engineLayerId)){const s=new Rs({isPickable:!1,updatePolicy:Da.SYNC});this.view._stage.add(s),i.engineLayerId=s.id,this._engineLayer=s}else(a=this.view._stage)!=null&&a.getObject&&(this._engineLayer=this.view._stage.getObject(i.engineLayerId));i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,m(this._materialIdReferences)&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),jo(this._location.spatialReference,this.view.spatialReference)||(this.location=new ti({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const i=e.manipulator3D;i.engineLayerReferences--;const a=i.engineLayerReferences===0;a&&(i.engineLayerId=null),this._removeResourcesFromStage(a),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){ns(this.location,Hn,e.spatialReference),Bo(e.extent,Hn)&&(this.location=this._location)}_evaluateElevationAlignment(e=this.location){if(m(this.elevationInfo))return!1;let i=null,a=0;const s=W(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":i=W(qa(this.view.elevationProvider,e,"ground"),0);break;case"relative-to-ground":a=W(qa(this.view.elevationProvider,e,"ground"),0)+s;break;case"relative-to-scene":a=W(qa(this.view.elevationProvider,e,"scene"),0)+s;break;case"absolute-height":a=s}return(a!==this._elevation.offset||i!==this._elevation.override)&&(this._elevation.offset=a,this._elevation.override=i,!0)}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),i=ia;if(this.autoScaleRenderObjects===!0){const r=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(r,i)}else this._calculateObjectTransform(e,i);const{objectsByState:a}=this._ensureEngineResources(),s=(this.focused?E.Focused:E.Unfocused)|(this.selected?E.Selected:E.Unselected),n=this._noDisplayCount>0;for(const{stateMask:r,objects:o}of a){if(n){for(const _ of o)_.setVisible(!1);continue}const l=(r&E.All)!==E.None,d=(r&ae.All)!==ae.None,p=!l||(s&r)==(r&E.All),g=!d||(this.state&r)==(r&ae.All);if(p&&g)for(const _ of o)_.setVisible(!0),_.transformation=i;else for(const _ of o)_.setVisible(!1)}}_ensureEngineResources(){if(m(this._engineResources)){const e=R(this._engineLayer),i=[],a=new Set;this.renderObjects.forEach(({material:o})=>{a.has(o)||(i.push(o),a.add(o))});const s=(o,l)=>{const{geometry:d,material:p,transform:g}=l;Array.isArray(d)?d.forEach(_=>o.addGeometry(_,p,g)):o.addGeometry(d,p,g)},n=new Map;this._renderObjects.forEach(o=>{const l=new Ds({castShadow:!1});s(l,o);const d=o.stateMask||0,p=n.get(d)||[];p.push(l),n.set(d,p)});const r=[];n.forEach((o,l)=>r.push({stateMask:l,objects:o})),this._engineResources={objectsByState:r,layer:e,materials:i}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){if(this._engineResourcesAddedToStage||m(this._engineResources))return;const{objectsByState:e,layer:i,materials:a}=this._engineResources;a.forEach(s=>{const n=R(this._materialIdReferences),r=n.get(s.id)||0;r===0&&this.view._stage.add(s),n.set(s.id,r+1)}),e.forEach(({objects:s})=>{i.addMany(s),this.view._stage.addMany(s)}),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(e=!1){if(!this._engineResourcesAddedToStage||m(this._engineResources)||!this.view._stage)return;const{objectsByState:i,layer:a,materials:s}=this._engineResources;i.forEach(({objects:n})=>{a.removeMany(n),this.view._stage.removeMany(n)}),s.forEach(n=>{const r=R(this._materialIdReferences),o=r.get(n.id);o===1?(this.view._stage.remove(n),r.delete(n.id)):r.set(n.id,o-1)}),e&&this.view._stage.remove(a),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*(e==="touch"?this.touchMultiplier:1)}_getFocusedSize(e,i){return e*(i?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const i=this._getWorldToScreenObjectScale(),a=this._calculateObjectTransform(i,qc);return Z(e,a[12],a[13],a[14])}_calculateModelTransformOffset(e){const i=this._calculateModelTransformPosition(e);return P(e,i,this.renderLocation)}_calculateObjectTransform(e,i){return qo(i,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&Ze(i,i,this._worldFrame),Ze(i,i,this._modelTransform),i[12]+=this.renderLocation[0],i[13]+=this.renderLocation[1],i[14]+=this.renderLocation[2],i[15]=1,c(this._applyObjectTransform)&&this._applyObjectTransform(i),i}get test(){let e=!1;if(c(this._engineResources))for(const i in this._engineResources.objectsByState){const a=this._engineResources.objectsByState[i];for(const s of a.objects)if(s.isVisible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}function In(t){return t[12]!==0||t[13]!==0||t[14]!==0}function jc(t,e,i){switch(t.viewingMode){case"local":return rs(i),!0;case"global":{const a=Yo(t.renderCoordsHelper.spatialReference);return Wo(e,0,xi,0,a.radius),Zo(rt(xi[0]),rt(xi[1]),i),!0}}}const Bc=Me(),Gn=Pi(),Wa=Ni(),Vn=jh(),qc=_e(),ia=_e(),aa=hi(),xi=b(),zn=b(),Nn=b(),Fn=b(),Un=b(),Yc=b(),Hn=new ti({x:0,y:0,z:0,spatialReference:null});function nt(t,e=D.OccludeAndTransparent,i=!0){const a=ot(t[0],t[1],t[2],t.length>3?t[3]:1),s=t[3]<1;return i?new fs({color:a,transparent:s,writeDepth:!0,cullFace:K.Back,renderOccluded:e}):new Ye({color:a,transparent:s,writeDepth:!0,cullFace:K.Back,renderOccluded:e})}function fi(t,e=D.OccludeAndTransparent){const i=ot(t[0],t[1],t[2],t.length===4?t[3]:1);return new Ye({color:i,transparent:!0,writeDepth:!0,cullFace:K.Front,renderOccluded:e})}function oo(t,e,i,a){const s=P(M.get(),t,i),n=lo(s,Se(M.get(),a,s),i,se.get());Xo(n,n);const r=Ee(M.get(),e,n);return Math.atan2(r[1],r[0])}function lo(t,e,i,a){const s=re(M.get(),t),n=re(M.get(),e),r=Se(M.get(),s,n);return a[0]=s[0],a[1]=s[1],a[2]=s[2],a[3]=0,a[4]=n[0],a[5]=n[1],a[6]=n[2],a[7]=0,a[8]=r[0],a[9]=r[1],a[10]=r[2],a[11]=0,a[12]=i[0],a[13]=i[1],a[14]=i[2],a[15]=1,a}function Aa(t,e){const i=t.getViewForGraphic(e);return c(i)&&"computeAttachmentOrigin"in i?i.computeAttachmentOrigin(e,t.spatialReference):null}function ho(t,e,i){const a=Aa(t,i);c(a)?e.elevationAlignedLocation=a:Wc(e,i.geometry)}function Wc(t,e){if(m(e))return;const i=e.type==="mesh"?e.anchor:bh(e);m(i)||(t.location=Mh(i))}var C;(function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"})(C||(C={}));function Nt(t,e=X(t)){return e.mode!=="on-the-ground"&&!(m(t.geometry)||!t.geometry.hasZ)}var Ge;(function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"})(Ge||(Ge={}));class co{constructor(){this.grabbingState=Ge.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(e){this.grabbingState=Ge.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((i,a)=>{if(a===C.TRANSLATE_Z&&(this.zManipulator=i),i instanceof ce&&(i.selected&&(this.numSelected===0&&(this.firstSelected=i),this.numSelected++),m(this.firstGrabbedXY)&&i.grabbing&&a===C.TRANSLATE_XY&&(this.firstGrabbedXY=i)),i.grabbing)switch(this.grabbingState|=Ge.ANY,a){case C.TRANSLATE_Z:this.grabbingState|=Ge.Z;break;case C.TRANSLATE_XY:this.grabbingState|=Ge.XY}})}}function Zc(t){const{view:e,graphic:i}=t,a=new ye({graphic:i}),s=Xc(t,a),n=[s,Qc(t,s.visualElement,a),e.maskOccludee(i),e.trackGraphicState(a)];return{visualElement:s.visualElement,remove:()=>ge(n).remove()}}function Xc(t,e){const{view:i,graphic:a}=t,s=new jt({view:i,geometry:vs(a)?a.geometry:null,elevationInfo:X(a),attached:!1});y.visualElements.lineGraphics.shadowStyle.apply(s);const n=()=>{s.attached=e.displaying};y.visualElements.lineGraphics.outline.apply(s);const r=[L(()=>e.displaying,n),L(()=>e.isDraped,o=>{s.isDraped=o}),e.on("changed",()=>s.geometry=vs(a)?a.geometry:null),be(s)];return n(),{visualElement:s,remove:()=>ge(r).remove()}}function Qc(t,e,i){const{graphic:a,view:s}=t,n=[],r=X(a),o=r.mode==="on-the-ground"||!r.offset&&r.mode!=="absolute-height",l=new co,d=new Vs({view:s,extensionType:y.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:D.OccludeAndTransparent});y.visualElements.pointGraphics.shadowStyle.apply(d);const p=rt(y.visualElements.heightPlaneAngleCutoff),g=new Ri({view:s,attached:!1,angleCutoff:p});y.visualElements.heightPlane.apply(g);let _=1,v=1;const f=()=>{if(l.update(t),!i.displaying||o&&(i.isDraped||!vs(a)||!a.geometry.hasZ))return e.laserlineEnabled=!1,d.attached=!1,void(g.attached=!1);e.laserlineEnabled=!0;{const x=l.grabbingState&Ge.XY?y.visualElements.laserlineAlphaMultiplier:1;x!==_&&(_=x,y.visualElements.lineGraphics.shadowStyle.apply(e,x),y.visualElements.pointGraphics.shadowStyle.apply(d,x))}{const x=l.grabbingState&Ge.Z?y.visualElements.laserlineAlphaMultiplier:1;x!==v&&(v=x,y.visualElements.heightPlane.apply(g,x))}Jc(d,l),Kc(t,e,g,l)};y.visualElements.zVerticalLine.apply(d),n.push(i.on("changed",f),L(()=>i.displaying,f),e.events.on("attachment-origin-changed",f),be(d),be(g));const S=[],w=()=>{ge(S).remove(),S.length=0,t.forEachManipulator(x=>S.push(x.events.on("grab-changed",f))),t.forEachManipulator(x=>S.push(x.events.on("select-changed",f))),f()};return w(),n.push(t.onManipulatorsChanged(w),xr(()=>ge(S))),ge(n)}function Jc(t,e){const i=e.numSelected===1?e.firstSelected:e.numSelected>1&&c(e.firstGrabbedXY)?e.firstGrabbedXY:null;c(i)?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}function Kc(t,e,i,a){if(a.numSelected>0){Z(Dt,0,0,0);let s=0;t.forEachManipulator((n,r)=>{r===C.TRANSLATE_XY&&n.selected&&n instanceof ce&&(z(Dt,Dt,n.renderLocation),s++)}),s>0?(i.heightManifoldTarget=Q(Dt,Dt,1/s),i.attached=!0):i.attached=!1}else{const s=e.attachmentOrigin;c(s)&&t.view.renderCoordsHelper.toRenderCoords(s,Dt)?(i.heightManifoldTarget=Dt,i.attached=!0):i.attached=!1}}function vs(t){return c(t.geometry)&&(t.geometry.type==="polygon"||t.geometry.type==="polyline")}const Dt=b();function ed(t){const{view:e,graphic:i}=t,a=new ye({graphic:i}),s=[],n=id(t,a,s);return td(t,a,s,n),s.push(e.trackGraphicState(a)),{visualElement:n,remove(){ge(s).remove()}}}function td(t,e,i,a){const{view:s,graphic:n}=t,r=new Vs({view:s,extensionType:y.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:D.OccludeAndTransparent});y.visualElements.zVerticalLine.apply(r);const o=new Ri({view:s,intersectsLineInfinite:!0,attached:!1});y.visualElements.pointGraphics.shadowStyle.apply(o);const l=rt(y.visualElements.heightPlaneAngleCutoff),d=new Ri({view:s,attached:!1,angleCutoff:l});y.visualElements.heightPlane.apply(d);const p=X(t.graphic),g=Bi.fromElevationInfo(p),_=p.mode==="on-the-ground"||!p.offset&&p.mode!=="absolute-height",v=new co;let f=1,S=1;const w=()=>{v.update(t);const x=zs(n),O=_&&(e.isDraped||m(x)||!x.hasZ);let j=!0;if(!O&&c(x)){const Y=$s(x,s.elevationProvider,g,s.renderCoordsHelper);Z(Ie,x.x,x.y,Y),ma(Ie,x.spatialReference,Ie,s.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(Ie),o.intersectsWorldUpAtLocation=Ie}else j=!1;const de=v.grabbingState&Ge.Z?y.visualElements.laserlineAlphaMultiplier:1;de!==f&&(f=de,y.visualElements.heightPlane.apply(d,de));const ct=Mr(rd);!O&&e.displaying&&a.calculateMapBounds(ct)&&ma(Qo(ct,Ie),s.spatialReference,Ie,s.renderCoordsHelper.spatialReference)?(d.heightManifoldTarget=Ie,d.attached=!0):d.attached=!1;const me=v.grabbingState&Ge.XY?y.visualElements.laserlineAlphaMultiplier:1;me!==S&&(S=me,y.visualElements.pointGraphics.shadowStyle.apply(o,me));const Ot=j&&e.displaying&&!O;o.attached=Ot,r.attached=Ot};i.push(L(()=>[e.displaying,e.isDraped],w),e.on("changed",w)),t.forEachManipulator(x=>{i.push(x.events.on("grab-changed",w))}),i.push(be(o)),i.push(be(r)),i.push(be(d)),w()}function id(t,e,i){const{view:a,graphic:s}=t,n=new _s({view:a,geometry:zs(s),elevationInfo:X(s),attached:!1});return ad(t,n,e,i),i.push(be(n)),n}function zs(t){const e=t.geometry;return m(e)?null:e.type==="point"?e:e.type==="mesh"?e.anchor.clone():null}function ad(t,e,i,a){const s=()=>e.attached=i.displaying;sd(t,e,i,a),y.visualElements.pointGraphics.outline.apply(e),a.push(L(()=>i.displaying,s,qe))}function sd(t,e,i,a){const{view:s,graphic:n}=t;let r=null;const o=d=>{c(r)&&(r.remove(),r=null),i.isDraped&&c(d)&&(r=nd(s,d,()=>{e.geometry=d}))},l=()=>{const d=zs(n);o(d),e.geometry=d};a.push(i.on("changed",l),xr(()=>r)),l()}function nd(t,e,i){const a=t.elevationProvider.spatialReference;Jo(e,Ie,a);const s=Ie[0],n=Ie[1];return t.elevationProvider.on("elevation-change",r=>{Er(r.extent,s,n)&&i()})}const Ie=b(),rd=br();function Ga(t){switch(R(t.graphic.geometry).type){case"point":case"mesh":return ed(t);case"polygon":case"polyline":return Zc(t);default:return null}}const od=[1,.5,0],po=128,Xe=70,ld=80,uo=.02,hd=54,cd=100,go=Math.ceil(Xe/3*2),Ct=160,Za=.5,Xa=24,Yt=9,dd=Ct+30,kn=Ct+53,pd=60,ud=23,gd=5*Math.PI/12,_d=1*Math.PI/3,jn=10,Bn=.2,qn=30,Yn=53,Wn=.2,Zn=.3,md=200,fd=3,vd=1e6;class Zi{constructor(){this._available=!0}set location(e){this._forEachManipulator3D(i=>i.location=e)}set elevationAlignedLocation(e){this._forEachManipulator3D(i=>i.elevationAlignedLocation=e)}set elevationInfo(e){this._forEachManipulator3D(i=>i.elevationInfo=e)}get renderLocation(){let e;return this._forEachManipulator3D(i=>{e||(e=i.renderLocation)}),e}get available(){return this._available}set available(e){this._available=e,this._forEachManipulator3D(i=>i.available=e)}get hovering(){return this.someManipulator(e=>e.hovering)}get grabbing(){return this.someManipulator(e=>e.grabbing)}get dragging(){return this.someManipulator(e=>e.dragging)}hasManipulator(e){return this.someManipulator(i=>i===e)}someManipulator(e){let i=!1;return this.forEachManipulator(a=>{!i&&e(a)&&(i=!0)}),i}_forEachManipulator3D(e){this.forEachManipulator((i,a)=>{i instanceof ce&&e(i,a)})}}function Ta(t,e){return _o(t,()=>e)}function yd(t){return _o(t,e=>e.plane)}function _o(t,e){const i=b(),a=b();let s=!1;return n=>{const r=e(n);if(n.action==="start"){const d=fa(n.screenStart,Xs(Mt.get())),p=ai(t.state.camera,d,Qn);c(p)&&(s=ni(r,p,i))}if(!s)return null;const o=fa(n.screenEnd,Xs(Mt.get())),l=ai(t.state.camera,o,Qn);return m(l)?null:ni(r,l,a)?{...n,renderStart:i,renderEnd:a,plane:r,ray:l}:null}}function bd(t,e,i,a=null,s=null){let n=null;return r=>{if(r.action==="start"&&(n=t.sceneIntersectionHelper.intersectElevationFromScreen(Me(r.screenStart.x,r.screenStart.y),e,i,s),c(n)&&c(a)&&!ns(n,n,a))||m(n))return null;const o=t.sceneIntersectionHelper.intersectElevationFromScreen(Me(r.screenEnd.x,r.screenEnd.y),e,i,s);return c(o)?c(a)&&!ns(o,o,a)?null:{...r,mapStart:n,mapEnd:o}:null}}function Va(t,e,i,a=null,s=null){return bd(t,i,Or(e,t,i),a,s)}function mo(t,e,i,a=null,s=null){return Va(t,i,X(e),a,s)}function Md(t,e,i,a){const s=e.toMap(t.screenStart,{include:[i]});return c(s)?mo(e,i,s,a):null}function Sd(t,e){const i=xd,a=Ed,s=hi();t.renderCoordsHelper.worldUpAtPosition(e,i);const n=Se(s,i,P(a,e,t.state.camera.eye));return Se(n,n,i),Ht(e,n,s)}function fo(t,e,i){let a=null;const s=new As;return s.next(Ta(t,Sd(t,e))).next(wd(t,e)).next(vo(t,i)).next(n=>{n.mapEnd.x=n.mapStart.x,n.mapEnd.y=n.mapStart.y,a=n}),n=>(a=null,s.execute(n),a)}function wd(t,e){const i=b(),a=Pe(e);t.renderCoordsHelper.worldUpAtPosition(e,i);const s=b(),n=b(),r=o=>(P(o,o,e),Fl(i,o,o),t.viewingMode==="global"&&Pe(o)*Math.sign(Ei(i,o))<.001-a&&P(o,Q(o,i,.001),e),z(o,o,e),o);return o=>(o.renderStart=r(B(s,o.renderStart)),o.renderEnd=r(B(n,o.renderEnd)),o)}function vo(t,e){const i=t.renderCoordsHelper;return a=>{const s=i.fromRenderCoords(a.renderStart,e),n=i.fromRenderCoords(a.renderEnd,e);return c(s)&&c(n)?{...a,mapStart:s,mapEnd:n}:null}}var Xn;(function(t){t[t.GROUND=0]="GROUND",t[t.OTHER=1]="OTHER"})(Xn||(Xn={}));const xd=b(),Ed=b(),Qn=Ni();function za(t,e,i,a){const s=t.graphic,n=(r,o)=>e({action:r,graphic:s,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY});return i((r,o,l)=>{const d=o.next(p=>(p.action==="start"&&n("start",p),p)).next(Ol(s,a)).next(p=>{switch(p.action){case"start":case"update":(p.translationX||p.translationY||p.translationZ)&&n("update",p);break;case"end":n("end",p)}return p});return l.next(Al(s)).next(()=>{n("end",{screenDeltaX:0,screenDeltaY:0})}),d})}function yo(t){if(m(t)||t.type!=="polyline"&&t.type!=="polygon")return 0;const e=(t.type==="polyline"?t.paths:t.rings)[0];if(!e||e.length<2)return 0;const i=e[0],a=e[1];return Math.atan2(a[1]-i[1],a[0]-i[0])}class Od extends Zi{constructor(e){super(),this._handles=new lt,this._arrowManipulatorInfos=new Array,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),this._angle=0,this._scale=1,this._radius=Xe,this._updateAfterDrag=!1,this.events=new Ue,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}set orthogonalAvailable(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._handles=U(this._handles),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(e){for(const{manipulator:i}of this._arrowManipulatorInfos)e(i,C.TRANSLATE_XY)}createGraphicDragPipeline(e,i,a){const s=i.graphic,n=X(s),r=R(s.geometry).spatialReference;return za(i,a,o=>this.createDragPipeline((l,d,p,g,_)=>o(l,e(l,d,p,g,_),p),n,r,s),this._view.state.viewingMode)}createDragPipeline(e,i,a,s){return ge(this._arrowManipulatorInfos.map(({manipulator:n},r)=>Ne(n,(o,l,d,p,g)=>{const _=l.next(v=>({...v,manipulatorType:C.TRANSLATE_XY})).next(Si(this._view,o.elevationAlignedLocation)).next(Va(this._view,o.elevationAlignedLocation,i,a,s)).next(Tl(o.location,this.angle+(r+1)*Math.PI*.5)).next(li());e(o,_,d,p,g)})))}get angle(){return this._angle}set angle(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}_updateManipulators(){for(let e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:e,transform:i},a){const s=this._radius/Xe,n=hd*s,r=n*Math.sqrt(3)/2,o=V.createExtrudedTriangle(r,n/2,n/2,uo);V.transformInPlace(o,ts(se.get(),Z(M.get(),0,-r/3,0))),e.renderObjects=[{geometry:o,material:this._opaqueMaterial,stateMask:E.Focused},{geometry:o,material:this._transparentMaterial,stateMask:E.Unfocused}],e.radius=r/3*2*1.2;const l=xs(se.get(),a*Math.PI/2),d=ts(se.get(),Z(M.get(),0,cd*s,0));Ze(i,l,d)}_createManipulators(){for(let e=0;e<4;e++){const i=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(i)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const e=this.angle,i=Ar(se.get(),e,N(0,0,1));if(m(i))return;const a=va(se.get(),Z(M.get(),this.displayScale,this.displayScale,this.displayScale)),s=Ze(se.get(),a,i);for(const n of this._arrowManipulatorInfos){const r=Ze(se.get(),s,n.transform);n.manipulator.modelTransform=r}}_createArrowManipulator(e){const i=new ce({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)}}),a={manipulator:i,transform:_e()};return this._updateArrowManipulator(a,e),this._handles.add(i.events.on("drag",s=>{this._updateAfterDrag&&s.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(e=1){const i=he.toUnitRGBA(T.main);return i[3]*=e,new Ye({color:i,transparent:e!==1,cullFace:K.Back,renderOccluded:D.Transparent})}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map(({manipulator:e})=>e)}}}class Ad{constructor(){this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new As,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this.lastDragEvent)){const i=this.lastDragEvent.mapEnd,a=this._snap(this.lastDragEvent.screenEnd);if(c(a)){const s={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:e===!0?a:i,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(s)}}this._enabled=e}_snap(e){const i=c(this.view)?this.view.toMap(e,{exclude:[]}):null;return c(i)&&c(this.view)&&(i.z=Or(i,this.view,this.elevationInfo)),i}createDragEventPipelineStep(e,i){return this.view=e,this.elevationInfo=i,this.lastDragEvent=null,a=>{if(this.lastDragEvent=a.action!=="end"?{...a}:null,this._enabled){const s=this._snap(a.screenEnd);return c(s)?{action:a.action,mapStart:a.mapStart,mapEnd:s,screenStart:a.screenStart,screenEnd:a.screenEnd}:null}return{action:a.action,mapStart:a.mapStart,mapEnd:a.mapEnd,screenStart:a.screenStart,screenEnd:a.screenEnd}}}}class Td extends Zi{constructor(e){super(),this._snapToScene=new Ad,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),this._scale=1,this._radius=Xe,this._view=e.view,this._tool=e.tool,e.snapToScene!=null&&(this.snapToScene=e.snapToScene),e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(e){e(this._manipulator,C.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(e){this._scale=e,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(e){this._snapToScene.enabled=e}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}createGraphicDragPipeline(e,i,a){const s=i.graphic,n=X(s),r=R(s.geometry).spatialReference;return za(i,a,o=>this.createDragPipeline((l,d,p,g,_)=>o(l,e(l,d,p,g,_),p),n,r,s),this._view.state.viewingMode)}createDragPipeline(e,i,a,s){const n=this._view;return Ne(this._manipulator,(r,o,l,d,p)=>{const g=o.next(Si(n,r.elevationAlignedLocation)).next(Va(n,r.elevationAlignedLocation,i,a,s)).next(this._snapToScene.createDragEventPipelineStep(n,i),this._snapToScene.next).next(_=>({..._,manipulatorType:C.TRANSLATE_XY})).next(li());e(r,g,l,d,p)})}_updateManipulatorTransform(){const e=va(se.get(),Z(M.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}_createManipulator(){const e=this._view;this._manipulator=new ce({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const e=V.createCylinderGeometry(uo,1,po,N(0,0,1),N(0,0,0)),i=va(_e(),N(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:i,stateMask:E.Focused},{geometry:e,material:this._discMaterialTransparent,transform:i,stateMask:E.Unfocused}],this._manipulator.radius=ld*(this._radius/Xe)}_createMaterial(e=1){const i=he.toUnitRGBA(T.main);return i[3]*=e,new Ye({color:i,transparent:e!==1,cullFace:K.Back,renderOccluded:D.Transparent})}get test(){return{discManipulator:this._manipulator}}}class Pd extends Zi{constructor(e){super(),this._radius=Xe,this.events=new Ue,this._tool=e.tool,this._view=e.view,e.radius!=null&&(this._radius=e.radius),this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()})}forEachManipulator(e){e(this._manipulator,C.TRANSLATE_Z)}createGraphicDragPipeline(e,i,a){const s=R(i.graphic.geometry).spatialReference;return za(i,a,n=>this.createDragPipeline((r,o,l,d,p)=>n(r,e(r,o,l,d,p),l),s),this._view.state.viewingMode)}createDragPipeline(e,i){const a=this._view;return Ne(this._manipulator,(s,n,r,o,l)=>{const d=n.next(p=>({...p,manipulatorType:C.TRANSLATE_Z})).next(fo(a,s.renderLocation,i)).next(li());e(s,d,r,o,l)})}get radius(){return this._radius}set radius(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}_updateManipulator(){const e=this._radius/Xe,i=y.zManipulator.height*e,a=y.zManipulator.coneHeight*e,s=y.zManipulator.coneWidth*e,n=y.zManipulator.width*e,r=[N(0,0,0),N(0,0,i)],o=V.createTubeGeometry(r,n/2,16,!1),l=V.createConeGeometry(a,s/2,16,!1),d=[N(0,0,0),N(0,0,i+a)],p=x=>{const O=_e();if(pa(O,O,[0,0,i]),Tr(O,O,Math.PI/2),x){const j=1+2*x/s;Vi(O,O,[j,j,j])}return O},g=p(0),_=(x,O)=>{const j=Uh(y.zManipulator.color,O);return[j.r/255,j.g/255,j.b/255,y.zManipulator.color.a*x]},v=nt(_(1,.25),D.Occlude),f=nt(_(1,0),D.Occlude),S=nt(_(.7,0),y.zManipulator.renderOccluded),w=nt(_(.85,0),y.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:l,transform:g,material:v,stateMask:E.Unfocused},{geometry:o,material:v,stateMask:E.Unfocused},{geometry:l,transform:g,material:f,stateMask:E.Focused},{geometry:o,material:f,stateMask:E.Focused},{geometry:l,transform:g,material:S,stateMask:E.Unfocused},{geometry:o,material:S,stateMask:E.Unfocused},{geometry:l,transform:g,material:w,stateMask:E.Focused},{geometry:o,material:w,stateMask:E.Focused}],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[d]}}_createManipulator(){const e=new ce({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=i=>{const a=this._view.state.camera,s=Jn;this._view.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,s);const n=Ko(a.eye,s),r=a.computeRenderPixelSizeAtDist(n),o=P(Wt,s,a.eye);re(o,o);const l=Rd;this._view.renderCoordsHelper.worldUpAtPosition(Jn,l);const d=Math.abs(Ei(o,l)),p=Se(Wt,o,l),g=Se(Wt,p,l),_=_a(d,.01,1),v=1-Math.sqrt(1-_*_)/_/a.fullWidth,f=this._radius/Xe,S=y.zManipulator.width*f;Q(g,re(g,g),(1/v-1)*n+r*S),i[12]-=Wt[0],i[13]-=Wt[1],i[14]-=Wt[2]},this._manipulator=e,this._updateManipulator()}get test(){return{manipulator:this._manipulator}}}const Jn=b(),Wt=b(),Rd=b();class Ft extends Zi{constructor(e){super(),this._handles=new lt,this._angleDeferred=null,this._interactive=!0;const{tool:i,view:a,snapToScene:s,radius:n}=e;this._view=a,this.xyManipulation=new Td({tool:i,view:a,snapToScene:s,radius:n}),this.xyAxisManipulation=new Od({tool:i,view:a,radius:n}),this.zManipulation=new Pd({tool:i,view:a,radius:n}),this.xyManipulation.available=e.xyAvailable,this.xyAxisManipulation.available=e.xyAxisAvailable,this.zManipulation.available=e.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(r=>{this._handles.add(r.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(e,i,a){return ge([this.xyManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(G.XY,s,n,r,o,l),i,a),this.xyAxisManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(G.XY_AXIS,s,n,r,o,l),i,a),this.zManipulation.createGraphicDragPipeline((s,n,r,o,l)=>e(G.Z,s,n,r,o,l),i,a)])}createDragPipeline(e,i,a,s){return ge([this.xyManipulation.createDragPipeline((n,r,o,l,d)=>e(G.XY,n,r,o,l,d),i,a,s),this.xyAxisManipulation.createDragPipeline((n,r,o,l,d)=>e(G.XY_AXIS,n,r,o,l,d),i,a,s),this.zManipulation.createDragPipeline((n,r,o,l,d)=>e(G.Z,n,r,o,l,d),a)])}set snapToScene(e){this.xyManipulation.snapToScene=e}set angle(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}set angleDeferred(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}set radius(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}set displayScale(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}forEachManipulator(e){this.xyManipulation.forEachManipulator(i=>e(i,C.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(i=>e(i,C.TRANSLATE_XY)),this.zManipulation.forEachManipulator(i=>e(i,C.TRANSLATE_Z))}get xyAxisVisible(){const e=this.xyManipulation.someManipulator(i=>i.focused)||this.xyAxisManipulation.someManipulator(i=>i.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||e}_autoHideXYAxis(){const e=this.xyAxisManipulation,i=this.xyManipulation;if(Pr("esri-mobile"))return;const a=[];i.forEachManipulator(n=>a.push(n)),e.forEachManipulator(n=>a.push(n));const s=()=>{const n=[];this.xyAxisVisible?c(this._angleDeferred)&&(this.angle=this._angleDeferred()):e.forEachManipulator(r=>n.push(r.disableDisplay())),this._handles.remove(Kn),this._handles.add(n,Kn)};for(const n of a)this._handles.add(n.events.on("focus-changed",s));this._view.inputManager&&this._handles.add(si(()=>{var n;return(n=this._view.inputManager)==null?void 0:n.latestPointerType},s)),s()}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator(i=>{i.interactive=!e&&this._interactive||i.grabbing})}static radiusForSymbol(e){const i=c(e)&&e.type==="point-3d"&&e.symbolLayers;return!!i&&i.length>0&&i.some(a=>a.type==="icon")?go:Xe}}const Kn="disable-xy-axis-display";var G;(function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"})(G||(G={}));class Ns extends Zi{constructor(e){super(),this._view=e.view,this._tool=e.tool,this._graphicState=e.graphicState,this._createManipulator(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(e){e(this._manipulator,C.TRANSLATE_XY)}createGraphicDragPipeline(e){return za(this._graphicState,e,i=>this.createDragPipeline(i),this._view.state.viewingMode)}createDragPipeline(e){const i=this._view,a=this._graphicState.graphic,s=c(a.geometry)?a.geometry.spatialReference:null;return Ne(this._manipulator,(n,r,o,l,d)=>{const p=r.next(Md(d,i,a,s)).next(Zt()).next(li());e(n,p,o,l,d)})}_createManipulator(){const e=this._view,i=this._graphicState.graphic;this._manipulator=new qh({graphic:i,view:e,selectable:!0,cursor:"move"})}}let Te=class extends ht{constructor(t){super(t),this.type="translate-graphic",this.distance=xt}};h([u()],Te.prototype,"type",void 0),h([u()],Te.prototype,"distance",void 0),Te=h([k("esri.views.interactive.tooltip.TranslateGraphicTooltipInfo")],Te);let Ve=class extends ht{constructor(t){super(t),this.type="translate-z",this.distance=xt}};h([u()],Ve.prototype,"type",void 0),h([u()],Ve.prototype,"distance",void 0),Ve=h([k("esri.views.interactive.tooltip.TranslateZTooltipInfo")],Ve);let ft=class extends ht{constructor(t){super(t),this.type="translate-vertex",this.distance=xt,this.elevation=null,this.area=null,this.totalLength=null}};h([u()],ft.prototype,"type",void 0),h([u()],ft.prototype,"distance",void 0),h([u()],ft.prototype,"elevation",void 0),h([u()],ft.prototype,"area",void 0),h([u()],ft.prototype,"totalLength",void 0),ft=h([k("esri.views.interactive.tooltip.TranslateVertexTooltipInfo")],ft);class Dd{constructor(e){this.allGraphics=e,this.type="graphic-move-start"}}class $d{constructor(e,i,a){this.dx=e,this.dy=i,this.allGraphics=a,this.type="graphic-move"}}class er{constructor(e){this.allGraphics=e,this.type="graphic-move-stop"}}let Be=class extends Rr(Ue.EventedMixin(Ra)){constructor(t){super(t),this.graphics=new el,this.enableZ=!0,this.tooltipOptions=new Je,this.type="move-3d",this._snappingPipeline=new ba,this._tooltip=null}initialize(){const{graphics:t,view:e}=this;this.own([t.on("change",()=>this._refreshManipulators()),L(()=>this.tooltipOptions.enabled,i=>{this._tooltip=i?new zi({view:e}):U(this._tooltip)},Es)]),this._refreshManipulators(),this.finishToolCreation()}destroy(){this._tooltip=U(this._tooltip),this.graphics.removeAll(),this._set("view",null)}get updating(){return this.updatingHandles.updating}reset(){}_refreshManipulators(){this.handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();const t=this.graphics.toArray().filter(e=>tl(e)===Dr.SUPPORTED).map(e=>new Cd(e));t.length&&(this._createManipulators(t),this._createVisualElements(t),this.handles.add(t.map(e=>this.view.trackGraphicState(e.state))),this._updateMoveManipulation(t))}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new Ns({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator(a=>this.handles.add([a.events.on("immediate-click",s=>{this.emit("immediate-click",{...s,graphic:i.graphic}),s.stopPropagation()}),a.events.on("grab-changed",({action:s})=>{const{tooltipOptions:n,_tooltip:r}=this;m(r)||(s==="focus"?r.info=new Te({tooltipOptions:n}):r.clear())})])),this.handles.add(e.manipulationXY.createDragPipeline((a,s,n,r)=>this._buildDragEventPipeline(t,G.XY,a,s,n,r)))}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new Ft({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:t.length===1?Ft.radiusForSymbol(t[0].graphic.symbol):Xe});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((s,n)=>{this.handles.add(s.events.on("immediate-click",r=>{e.zManipulation.hasManipulator(s)||this.graphics.length!==1||this.emit("immediate-click",{...r,graphic:this.graphics.getItemAt(0)}),r.stopPropagation()})),n===C.TRANSLATE_XY&&this.handles.add(s.events.on("focus-changed",({action:r})=>{const{tooltipOptions:o,_tooltip:l}=this;m(l)||(r==="focus"?l.info=new Te({tooltipOptions:o}):l.clear())})),n===C.TRANSLATE_Z&&this.handles.add(s.events.on("focus-changed",({action:r})=>{const{tooltipOptions:o,_tooltip:l}=this;m(l)||(r==="focus"?l.info=new Ve({tooltipOptions:o}):l.clear())}))});const i=()=>this._updateMoveManipulation(t);for(const s of t)this.handles.add([s.state.on("changed",i),L(()=>s.state.displaying,i)]);const a=t[t.length-1];this.handles.add(a.state.on("changed",()=>this._updateMoveManipulationAngle(a))),this.handles.add(e.createDragPipeline((s,n,r,o,l)=>this._buildDragEventPipeline(t,s,n,r,o,l),X(a.graphic),R(a.graphic.geometry).spatialReference,a.graphic)),this._updateMoveManipulationAngle(a)}_createVisualElements(t){for(const e of t){const i=e.graphic,a=Ga({view:this.view,graphic:i,forEachManipulator:s=>{e.manipulationXY.forEachManipulator(s),this._moveManipulation.forEachManipulator(s)},onManipulatorsChanged:()=>Vt()});m(a)||(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof jt&&this.handles.add([e.geometryRepresentation.events.on("attachment-origin-changed",()=>{e.state.isDraped||this._updateMoveManipulation(t)}),L(()=>e.state.isDraped,()=>this._updateMoveManipulation(t))]),this.handles.add(a))}}_updateMoveManipulationAngle(t){this._moveManipulation.angleDeferred=()=>yo(t.graphic.geometry)}_updateMoveManipulation(t){const e=Wi(0,0,0,this.view.spatialReference);let i=0,a=!1;const s=this._moveManipulation;for(const n of t){if(!n.state.displaying)continue;const r=n.state.graphic;this.enableZ&&Nt(r)&&(a=!0);const o=n.geometryRepresentation instanceof jt&&!n.state.isDraped?n.geometryRepresentation.attachmentOrigin:Aa(this.view,r);c(o)&&(e.x+=o.x,e.y+=o.y,e.z+=o.z,i++)}i>0?(e.x/=i,e.y/=i,e.z/=i,s.location=e,s.xyManipulation.available=!0,s.xyAxisManipulation.available=!0,s.zManipulation.available=a):s.available=!1}_buildDragEventPipeline(t,e,i,a,s,n){const r=[],o=[];let l=null,d=null;const p=()=>{for(const _ of r)_.dragging=!1;r.length=0,o.length=0,l=null,d=null,this._moveManipulation.interactive=!0};if(t.length===1&&e===G.XY){const _=t[0].graphic;a=this._buildSnappingPipelineSteps(_,X(_),a,s,n)}const g=a.next(_=>{if(_.action==="start"){r.length=0,o.length=0;for(const v of t)v.dragging||!v.manipulationXY.hasManipulator(i)&&v.manipulationXY.grabbing||(r.push(v),o.push(v.graphic),v.dragging=!0);if(o.length!==0&&(this._moveManipulation.interactive=!1,l=Pl(o,this.view.state.viewingMode),d=Rl(o),this.emit("graphic-move-start",new Dd(o)),this.destroyed))return null}return o.length!==0?_:null}).next(_=>l(_)).next(_=>this._updateMoveTooltip(_,e,t)).next(_=>{switch(_.action){case"start":case"update":if(_.translationX||_.translationY||_.translationZ){const v=this.view.toScreen(_.mapStart),f=this.view.toScreen(_.mapEnd),S=f.x-v.x,w=f.y-v.y;if(this.emit("graphic-move",new $d(S,w,o)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new er(o)),this.destroyed)return null;p()}});return s.next(_=>d(_)).next(()=>{if(this.emit("graphic-move-stop",new er(o)),this.destroyed)return null;p()}),g}_updateMoveTooltip(t,e,i){const{tooltipOptions:a,_tooltip:s}=this;if(m(s))return t;if(s.clear(),e===G.XY||e===G.XY_AXIS)if(t.action==="end")s.info=new Te({tooltipOptions:a});else{const n=i.length===0?"absolute-height":i[0].state.isDraped?"on-the-ground":"absolute-height",r=Ai(t.mapStart,t.mapEnd,n);c(r)&&(s.info=new Te({tooltipOptions:a,distance:r}))}return e===G.Z&&(t.action==="end"?s.info=new Ve({tooltipOptions:a}):da(Ma(t.mapStart,t.mapEnd),n=>{s.info=new Ve({tooltipOptions:a,distance:n})})),t}_buildSnappingPipelineSteps(t,e,i,a,s){const n=t.geometry;if(m(n)||n.type!=="point"&&n.type!=="mesh")return i;const r=(n.type==="point"?n:n.anchor).clone(),o=new xa({elevationInfo:e,pointer:s,editGeometryOperations:$a.fromGeometry(r,this.view.state.viewingMode),visualizer:new Di,excludeFeature:t}),l=this.snappingManager;return i.next(d=>(r.z=il(this.view,r,X(t),{mode:"absolute-height",offset:0}),{...d,snapOrigin:o.coordinateHelper.pointToVector(r)})).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:o,snappingManager:l,cancel:a,updatingHandles:this.updatingHandles}),this._snappingPipeline.next)}get test(){return{tooltip:this._tooltip}}};h([u({constructOnly:!0,nonNullable:!0})],Be.prototype,"view",void 0),h([u()],Be.prototype,"graphics",void 0),h([u({constructOnly:!0,nonNullable:!0})],Be.prototype,"enableZ",void 0),h([u({constructOnly:!0,type:Je})],Be.prototype,"tooltipOptions",void 0),h([u({constructOnly:!0})],Be.prototype,"snappingManager",void 0),h([u()],Be.prototype,"type",void 0),h([u()],Be.prototype,"updating",null),Be=h([k("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],Be);class Cd{constructor(e){this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new ye({graphic:e})}get graphic(){return this.state.graphic}}function tr(t,e,i){const a=i.mode==="on-the-ground"?mn.XY:mn.XYZ;return new Lh(t,a,e,0)}function ir(t,e,i){const a=b();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;const s=ar(t,e,Fi(i.plane)),n=ar(t,e,i.edgeDirection);if(m(s)||m(n))return null;const r=Se(b(),s,n);return Ht(a,r,hi())}function ar(t,e,i){const a=Wi(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),s=b(),n=b();return t.renderCoordsHelper.toRenderCoords(e,s)&&t.renderCoordsHelper.toRenderCoords(a,n)?$r(n,s,n):null}function Ld(t,e,i){const a=Fi(t),s=$r(b(),e,i),n=Se(b(),s,a),r=Se(b(),s,n);return rh(s[0],s[1],s[2],0,n[0],n[1],n[2],0,r[0],r[1],r[2],0,0,0,0,1)}function Id(t,e,i){const a=i.projectToRenderScreen(t,as()),s=i.projectToRenderScreen(e,as());return c(a)&&c(s)?al(P(a,a,s)):0}let Jt=class extends ht{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=xt}};h([u()],Jt.prototype,"type",void 0),h([u()],Jt.prototype,"distance",void 0),Jt=h([k("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Jt);let J=class extends Ue.EventedMixin(Os){constructor(t){super(t),this._vertexManipulatorMaterial=nt(y.colorToVec4(y.reshapeManipulators.vertex.color),y.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.vertex.outlineColor),y.reshapeManipulators.vertex.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.vertex.hoverOutlineColor),y.reshapeManipulators.vertex.renderOccluded),this._edgeManipulatorMaterial=nt(y.colorToVec4(y.reshapeManipulators.edge.color),y.reshapeManipulators.edge.renderOccluded),this._edgeManipulatorOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.edge.outlineColor),y.reshapeManipulators.edge.renderOccluded),this._edgeOffsetManipulatorMaterial=nt(y.colorToVec4(y.reshapeManipulators.edgeOffset.color),y.reshapeManipulators.edgeOffset.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=nt(y.colorToVec4(y.reshapeManipulators.edgeOffset.hoverColor),y.reshapeManipulators.edgeOffset.renderOccluded,!1),this._selectedManipulatorMaterial=nt(y.colorToVec4(y.reshapeManipulators.selected.color),y.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.selected.outlineColor),y.reshapeManipulators.selected.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=fi(y.colorToVec4(y.reshapeManipulators.selected.hoverOutlineColor),y.reshapeManipulators.selected.renderOccluded),this._selectedIndex=0,this._vertexManipulatorGeometry=null,this._vertexManipulatorOutlineGeometry=null,this._edgeManipulatorGeometry=null,this._edgeManipulatorOutlineGeometry=null,this._edgeOffsetManipulatorGeometryInside=null,this._edgeOffsetManipulatorGeometryOutside=null,this._manipulatorHandles=new lt,this._manipulatorInfos=[],this._editGeometryOperations=null,this._graphicMoveManipulation=null,this._moveManipulation=null,this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=F.NONE,this._outlineVisualElement=null,this._segmentLabels=null,this.outputGeometry=null,this._snappingPipeline=new ba,this._snappingPipelineHandle=new ba,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,i=this._graphicState=new ye({graphic:t});this._tooltip=new zi({view:e}),this.own([L(()=>i.displaying,a=>{for(const s of this._manipulatorInfos)s.manipulator.available=a}),L(()=>({labels:this._segmentLabels,enabled:this._labelOptions.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:a,enabled:s,edgeOffsetEnabled:n})=>{c(a)&&(a.visible=s,a.edgeDistance=n?"far":"default")},qe),si(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),qe),this.view.trackGraphicState(i)])}destroy(){this._segmentLabels=U(this._segmentLabels),this._tooltip=U(this._tooltip),this._editGeometryOperations=U(this._editGeometryOperations),this._moveManipulation=U(this._moveManipulation),this._graphicMoveManipulation=U(this._graphicMoveManipulation),this._manipulatorHandles=U(this._manipulatorHandles),this.manipulators.removeAll(),this._manipulatorInfos=[],this._resetGrabbingDragging()}get inputGeometry(){return c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this.updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _labelOptions(){return this.tool.labelOptions}get _tooltipOptions(){return this.tool.tooltipOptions}removeSelectedVertices(){const t=this._manipulatorInfos.filter(e=>e.manipulator.selected&&e.type==="vertex");this._removeVertices(t)}manipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._moveManipulation=U(this._moveManipulation),this._graphicMoveManipulation=U(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[]}_resetGrabbingDragging(){this._numGrabbing=0,this._numDragging=0}_createManipulators(){if(m(this._editGeometryOperations))return;const t=X(this.graphic);for(const e of this._editGeometryOperations.data.components){for(const i of e.vertices)this._createVertexOrEdgeManipulator(i,t);for(const i of e.edges)this._createVertexOrEdgeManipulator(i,t)}this._createGraphicMoveManipulators(t)}get canRedo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canRedo}get canUndo(){return c(this._editGeometryOperations)&&this._editGeometryOperations.canUndo}redo(){if(m(this._editGeometryOperations))return null;const t=this._editGeometryOperations.redo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(m(this._editGeometryOperations))return null;this.emit("undo");const t=this._editGeometryOperations.undo();return c(t)&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),this._createManipulators()}_recreateEditGeometryAndManipulators(t=this.inputGeometry){this._removeManipulators(),this._resetGrabbingDragging(),this._tooltip.clear(),m(t)||(U(this._editGeometryOperations),this._editGeometryOperations=$a.fromGeometry(t,this.view.state.viewingMode),this._createManipulators(),U(this._segmentLabels),this._segmentLabels=new Ea({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:X(this.graphic),labelOptions:this._labelOptions,graphic:this.graphic,graphicState:this._graphicState},visible:this._labelOptions.enabled}))}_perGraphicManipulatorDragAction(t,e){if(e.action==="end")return e;let i=0;const a=[],s=this._manipulatorInfos.some(r=>r.type==="vertex"&&r.manipulator.selected),n=t===Kt.SELECTED_OR_ALL&&s;for(const r of this._manipulatorInfos)r.type==="vertex"&&(r.manipulator.grabbing||n&&!r.manipulator.selected||a.push(r),i++);if(a.length===0)return e;if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(F.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(F.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){let t=0;for(const e of this._manipulatorInfos)e.type==="vertex"&&e.manipulator.selected&&t++;return t>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(F.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;const s=[];for(const n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.selected&&!n.manipulator.grabbing||n===t.info)&&s.push(n);this._moveVertices(s,t,st.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case F.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case F.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case F.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case F.MOVING:switch(this._reshapeEventState){case F.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case F.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case F.RESHAPING:switch(this._reshapeEventState){case F.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case F.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulators(t){const{graphic:e,handles:i,tool:a,view:s}=this,n=this._graphicState;if(this._graphicMoveManipulation=new Ns({tool:a,view:s,graphicState:n}),this.enableMoveGraphic){let l=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((d,p,g)=>{p.next(_=>this._trackNumDragging(_)).next(_=>(_.action==="start"&&(l=R(this._editGeometryOperations).createUndoGroup()),_)).next(_=>this._perGraphicManipulatorDragAction(Kt.ALL,_)).next(_=>(this._updateTranslateGraphicTooltip(G.XY,_),_)).next(_=>{_.action==="end"&&(this._tooltip.clear(),l=Tt(l))}),g.next(this._cancelDragOperation(()=>l=Tt(l)))}))}else this._graphicMoveManipulation.forEachManipulator(l=>{l.grabbable=!1,l.cursor=null});this._graphicMoveManipulation.forEachManipulator(l=>this._manipulatorHandles.add([this._watchAndUpdateGrabState(l,!1),l.events.on("immediate-click",d=>{this._manipulatorInfos.some(p=>p.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{...d,graphic:this.graphic}),d.stopPropagation()})])),this._moveManipulation=new Ft({tool:a,view:s,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Nt(e),snapToScene:!1,radius:Ft.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator((l,d)=>{i.add([this._watchAndUpdateGrabState(l,!1),l.events.on("immediate-click",p=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(g=>g.manipulator.selected)||this.emit("immediate-click",{...p,graphic:e}),p.stopPropagation()})]),i.add(l.events.on("focus-changed",({action:p})=>{p==="focus"&&this._tooltipOptions.enabled?this._updateTranslateTooltip(d===C.TRANSLATE_Z?G.Z:G.XY):this._tooltip.clear()}))}),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const r=R(e.geometry).spatialReference;i.add([this._moveManipulation.createDragPipeline((l,d,p,g,_)=>{const v=p.next(f=>this._trackNumDragging(f)).next(f=>{const S=this._manipulatorInfos.filter(w=>w.type==="vertex"&&w.manipulator.selected);return f.manipulatorType===C.TRANSLATE_XY&&S.length===1?{...f,info:S[0],snapOrigin:S[0].handle.pos}:{...f,info:null}}).next(this._snappingPipelineHandle.createSnapDragEventPipelineStep({predicate:f=>!!f.info,cancel:g,snappingManager:a.snappingManager,snappingContext:new xa({editGeometryOperations:R(this._editGeometryOperations),elevationInfo:t,pointer:_,excludeFeature:e,visualizer:new Di}),updatingHandles:this.updatingHandles}),this._snappingPipelineHandle.next).next(Zt()).next(f=>this._perGraphicManipulatorDragAction(Kt.SELECTED_OR_ALL,f)).next(f=>(this._updateTranslateTooltip(l,f),f));return g.next(this._cancelDragOperation()),v},t,r,e),L(()=>n==null?void 0:n.displaying,()=>{this._updateMoveManipulationPosition()},qe),n.on("changed",()=>this._updateMoveManipulationPosition()),L(()=>n==null?void 0:n.isDraped,l=>{const d="align-move-manipulation";l?i.add(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),d):i.remove(d)},qe)]),this._updateMoveManipulationPosition();const o=Ga({view:s,graphic:e,forEachManipulator:l=>{if(!this.destroyed){c(this._graphicMoveManipulation)&&this._graphicMoveManipulation.forEachManipulator(l);for(const d of this._manipulatorInfos)l(d.manipulator,C.TRANSLATE_XY);this._moveManipulation.forEachManipulator(l)}},onManipulatorsChanged:l=>this.on("manipulators-changed",l)});c(o)&&(this._outlineVisualElement=o.visualElement instanceof jt?o.visualElement:null),c(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",()=>{n.isDraped||this._updateMoveManipulationPosition()}),L(()=>n.isDraped,()=>this._updateMoveManipulationPosition())]),this._manipulatorHandles.add(o)}_createEdgeOffsetManipulator(t,e=X(this.graphic)){const i=y.reshapeManipulators.edgeOffset,a=i.size/2,s=a+i.collisionPadding;if(m(this._edgeOffsetManipulatorGeometryInside)||m(this._edgeOffsetManipulatorGeometryOutside)){const _=a/s,v=_*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside=V.createExtrudedTriangle(v,_/2,_/2,i.height,i.offset),this._edgeOffsetManipulatorGeometryOutside=V.createExtrudedTriangle(-v,_/2,_/2,i.height,-i.offset)}const n=[{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorMaterial,stateMask:E.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryInside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:E.Focused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorMaterial,stateMask:E.Unfocused},{geometry:this._edgeOffsetManipulatorGeometryOutside,material:this._edgeOffsetManipulatorHoverMaterial,stateMask:E.Focused}],r=new ce({view:this.view,renderObjects:n,elevationInfo:e.mode!=="on-the-ground"||Qs(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:s,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionType:{type:"disc",direction:N(0,0,1)},collisionPriority:1}),o=new ce({view:this.view,renderObjects:[],worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default"}),l={manipulator:r,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:o,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(l,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(l);const d=this._getManipulatorInfoFromHandle(l.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l)),p=this._getManipulatorInfoFromHandle(l.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(l));l.locationUpdateHandle=ge([d,p]),this._manipulatorHandles.add(l.locationUpdateHandle,r),this._manipulatorHandles.add([this._watchAndUpdateGrabState(r,!0),this._watchAndUpdateGrabState(o,!0)],r),this._manipulatorHandles.add(Ne(r,this._createEdgeOffsetPipeline(l,e)),r),this._manipulatorHandles.add(Ne(o,(_,v,f,S)=>{if(S==="touch")this._createEdgeOffsetPipeline(l,e)(_,v,f);else if(this.enableMoveGraphic){const w=this.graphic,x=c(w.geometry)?w.geometry.spatialReference:null;v.next(O=>this._trackNumDragging(O)).next(Si(this.view,_.elevationAlignedLocation)).next(Va(this.view,_.elevationAlignedLocation,e,x,w)).next(li()).next(Zt()).next(O=>this._perGraphicManipulatorDragAction(Kt.ALL,O)).next(O=>(this._updateTranslateGraphicTooltip(G.XY,O),O)).next(O=>{O.action==="end"&&this._tooltip.clear()}),f.next(this._cancelDragOperation())}}),r);const g=_=>{this._manipulatorInfos.some(v=>v.manipulator.selected)?this._clearSelection():this.emit("immediate-click",{..._,graphic:this.graphic}),_.stopPropagation()};return this._manipulatorHandles.add([r.events.on("immediate-click",g),o.events.on("immediate-click",g),r.events.on("focus-changed",({action:_})=>{const v=this._tooltipOptions;_==="focus"&&v.enabled?this._tooltip.info=new Jt({tooltipOptions:v}):this._tooltip.clear()})],r),this._manipulatorInfos.push(l),this.manipulators.add(r),this.manipulators.add(o),this.emit("manipulators-changed"),l}_autoHideEdgeOffsetManipulator(t,e){const i=t.manipulator,a=t.edgeManipulator,s=()=>{Tt(t.visibilityHandle);const n=Id(this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,this.view.state.camera)<e;(!i.focused&&!a.focused||n)&&(i.grabbable=!n,a.grabbable=!n,t.visibilityHandle=ge([i.disableDisplay(),{remove:()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}}]))};this._manipulatorHandles.add([i.events.on("focus-changed",s),a.events.on("focus-changed",s),{remove:()=>{Tt(t.visibilityHandle),this.manipulators.remove(a)}}],i),s()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const e=R(this._editGeometryOperations).data.coordinateHelper,i=ir(this.view,t.manipulator.elevationAlignedLocation,tr(e,t.handle,R(t.manipulator.elevationInfo))),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator.renderLocation,s=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator.renderLocation,n=c(i)?Ld(i,a,s):oh;t.manipulator.modelTransform=n,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=n;const r=Pe(P(sa,a,s))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-r,0,0],[r,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,a,s)=>{this._clearSelection();const{step:n,cleanup:r}=this._initializeEdgeOffset(t,e);a.next(o=>this._trackNumDragging(o)).next(Si(this.view,i.elevationAlignedLocation)).next(n).next(yd(this.view)).next(vo(this.view,R(this._editGeometryOperations).data.spatialReference)).next(Zt()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next(o=>{o.action==="end"&&r()}),s.next(o=>(r(),o)).next(o=>(this._tooltip.clear(),o)).next(this._cancelDragOperation())}}_initializeEdgeOffset(t,e){const i=R(this._editGeometryOperations),a=tr(i.data.coordinateHelper,t.handle,e),s=i.createUndoGroup(),n=ir(this.view,t.manipulator.elevationAlignedLocation,a);a.requiresSplitEdgeLeft&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge),1),a.requiresSplitEdgeRight&&this._splitEdgeManipulator(this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge),0);const r=()=>new sl({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:R(this._editGeometryOperations).data.spatialReference}),o=new jt({view:this.view,isDraped:this._graphicState.isDraped,geometry:r(),elevationInfo:t.elevationInfo,width:y.visualElements.lineGraphics.outline.width,color:y.colorToVec4(T.main),attached:!0});let l;const d=()=>{this._cleanEdgeOffsetCollapsedEdges(t),l=Tt(l)},p=this.on("undo",d);return l=ge([be(o),L(()=>this._graphicState.isDraped,g=>o.isDraped=g),this._graphicState.on("changed",()=>o.geometry=r()),s,p]),{step:g=>m(a)||m(n)?(d(),null):{...g,operation:a,plane:n},cleanup:d}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||m(e.operation))return e;this._updateEventState(F.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:s}=e;return(i||a||s)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:i}=t;if(m(e)||m(i))return t;const a=e.signedDistanceToPoint(i);return{...t,signedDistance:a}}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:i,operation:a}=t,s=this._tooltip,n=this._tooltipOptions;if(!n.enabled||m(i))return s.clear(),t;const r=Gd(this._graphicState.isDraped,-i,e,a.plane,R(this._editGeometryOperations).data.coordinateHelper);return m(s.info)||s.info.type!=="reshape-edge-offset"?s.info=new Jt({tooltipOptions:n,distance:r}):s.info.distance=r,t}}_cleanEdgeOffsetCollapsedEdges(t){var l,d;const e=(l=t.handle.leftVertex.leftEdge)==null?void 0:l.leftVertex,i=t.handle.leftVertex,a=(d=t.handle.rightVertex.rightEdge)==null?void 0:d.rightVertex,s=t.handle.rightVertex,n=R(this._editGeometryOperations).data.coordinateHelper,r=1e-6,o=[];e&&n.distance(e.pos,i.pos)<r&&o.push(this._getManipulatorInfoFromHandle(i)),(n.distance(i.pos,s.pos)<r||a&&n.distance(a.pos,s.pos)<r)&&o.push(this._getManipulatorInfoFromHandle(s)),o.length&&this._removeVertices(o)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=X(this.graphic)){if(t.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(m(this._vertexManipulatorGeometry)||m(this._vertexManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(y.reshapeManipulators.vertex);this._vertexManipulatorGeometry=V.createSphereGeometry(r,16,16),this._vertexManipulatorOutlineGeometry=V.createSphereGeometry(o,16,16)}if(m(this._edgeManipulatorGeometry)||m(this._edgeManipulatorOutlineGeometry)){const{size:r,outlineSize:o}=this._computeVertexManipulatorSizeAndOutline(y.reshapeManipulators.edge);this._edgeManipulatorGeometry=V.createSphereGeometry(r,16,16),this._edgeManipulatorOutlineGeometry=V.createSphereGeometry(o,16,16)}const i=c(this.graphic.geometry)&&this.graphic.geometry.type==="point"?[]:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Le.Vertex|E.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:Le.Vertex|E.Unfocused|E.Unselected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Le.Vertex|E.Focused|E.Unselected},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:E.Selected},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:E.Selected|E.Unfocused},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:E.Selected|E.Focused}];this.enableMidpoints&&i.push({geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:Le.Edge|E.Focused|E.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:Le.Edge|E.Focused|E.Unselected},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:Le.Edge|E.Unfocused|E.Unselected},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:Le.Edge|E.Unfocused|E.Unselected});const a=new ce({view:this.view,renderObjects:i,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(a,t,e);const s=t.type==="edge"?{manipulator:a,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:a,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(s),this.manipulators.add(a),this._updateManipulatorPosition(s),s.type==="edge"){const r=this._getManipulatorInfoFromHandle(s.handle.leftVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(s)),o=this._getManipulatorInfoFromHandle(s.handle.rightVertex).manipulator.events.on("location-update",()=>this._updateManipulatorPosition(s));s.locationUpdateHandle=ge([r,o]),this._manipulatorHandles.add(s.locationUpdateHandle,a)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(a,!0),a);const n=Ne(a,(r,o,l,d)=>{let p=null;o.next(g=>this._trackNumDragging(g)).next(g=>{if(g.action==="start"&&(p=R(this._editGeometryOperations).createUndoGroup()),s.type==="edge"){const _=this._splitEdgeManipulator(s);return{...g,info:_,snapOrigin:_.handle.pos}}return{...g,info:s,snapOrigin:s.handle.pos}}).next(Si(this.view,r.elevationAlignedLocation)).next(mo(this.view,this.graphic,r.elevationAlignedLocation,r.location.spatialReference,this.graphic)).next(this._snappingPipeline.createSnapDragEventPipelineStep({predicate:()=>!this._isMultiVertexSelection(),cancel:l,snappingManager:this.tool.snappingManager,snappingContext:new xa({editGeometryOperations:R(this._editGeometryOperations),elevationInfo:e,pointer:d,excludeFeature:this.graphic,visualizer:new Di}),updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(Zt()).next(g=>{this._perVertexManipulatorDragAction(g),g.action==="end"&&(p=Tt(p)),this._updateTranslateVertexTooltip(r,G.XY,g)}),l.next(this._cancelDragOperation(()=>p=Tt(p)))});return this._manipulatorHandles.add([n,a.events.on("immediate-click",r=>this._manipulatorClickCallback(r,s)),a.events.on("select-changed",()=>{s.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()}),a.events.on("focus-changed",({action:r})=>{r==="focus"&&s.type!=="edge"?this._updateTranslateVertexTooltip(a,G.XY):this._tooltip.clear()})],a),this.emit("manipulators-changed"),s}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_cancelDragOperation(t){return()=>{switch(this._numDragging--,this.undo(),this.outputGeometry=c(this._editGeometryOperations)?this._editGeometryOperations.data.geometry:null,c(this.tool.snappingManager)&&this.tool.snappingManager.doneSnapping(),this._tooltip.clear(),this._reshapeEventState){case F.NONE:break;case F.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case F.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}t&&t(),this.destroyed||this._updateEventState(F.NONE)}}_setTypeSpecificManipulatorSettings(t,e,i){switch(e.type){case"vertex":t.state=Le.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2,t.radius=y.reshapeManipulators.vertex.size/2+y.reshapeManipulators.vertex.collisionPadding,t.elevationInfo=i,t.interactive=c(this.graphic.geometry)&&this.graphic.geometry.type!=="point";break;case"edge":t.state=Le.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1,t.radius=y.reshapeManipulators.edge.size/2+y.reshapeManipulators.edge.collisionPadding,t.elevationInfo=i.mode!=="on-the-ground"||Qs(this.graphic.symbol)?{mode:"absolute-height",offset:0}:i}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",i=>this._onGrabStateChanged(t,e,i.action,i.pointerType))}_onGrabStateChanged(t,e,i,a="mouse"){if(i==="start")e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(F.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(s=>{s.manipulator.interactive=!this._numGrabbing&&c(this.graphic.geometry)&&this.graphic.geometry.type!=="point","edgeManipulator"in s&&(s.edgeManipulator.interactive=!this._numGrabbing)}),R(this._graphicMoveManipulation).forEachManipulator(s=>s.interactive=!this._numGrabbing))}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){t&&(t.manipulator.grabbing&&this._onGrabStateChanged(t.manipulator,!1,"end"),this._manipulatorHandles.remove(t.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(t),1),this.manipulators.remove(t.manipulator),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t){for(const e of this._manipulatorInfos)if(t===e.handle)return e}return null}_updateManipulatorPosition(t){if(!t)return;const e=R(this._editGeometryOperations);if(t.type==="vertex")t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,vi),t.manipulator.grabbing&&c(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if(t.type==="edge"){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex).manipulator,a=this._getManipulatorInfoFromHandle(t.handle.rightVertex).manipulator;if(c(t.manipulator.elevationInfo)&&t.manipulator.elevationInfo.mode==="on-the-ground"){const s=i.location,n=a.location,r=.5,o=s.x+r*(n.x-s.x),l=s.y+r*(n.y-s.y),d=s.hasZ&&n.hasZ?0:void 0;t.manipulator.location=Wi(o,l,d,e.data.spatialReference)}else bt(sa,i.renderLocation,a.renderLocation,.5),t.manipulator.renderLocation=sa}}_splitEdgeManipulator(t,e=.5){const i=R(this._editGeometryOperations),a=R(i.splitEdge(t.handle,e).createdVertex);t.locationUpdateHandle.remove(),t.locationUpdateHandle=void 0;const s=X(this.graphic);let n;this.enableEdgeOffset?(this._removeManipulator(t),n=this._createVertexOrEdgeManipulator(a)):(n=t,n.handle=a,n.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,s)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(n),this.enableEdgeOffset||this._updateTranslateVertexTooltip(n.manipulator,G.XY),this._updateSelection(t.manipulator);const r=this._updateEventState(F.RESHAPING),o=i.data.coordinateHelper.vectorToArray(n.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:o,componentIndex:l,vertexIndex:R(a.index)}],added:o}),r&&this._updateEventState(F.NONE),n}_updateMoveManipulationPosition(){const t=Z(sa,0,0,0);let e=0,i=!1,a=null,s=null;for(const n of this._manipulatorInfos)n.type==="vertex"&&(n.manipulator.selected?(e++,z(t,t,n.manipulator.renderLocation),m(a)||n.selectedIndex>a.selectedIndex?(s=a,a=n):(m(s)||n.selectedIndex>s.selectedIndex)&&(s=n)):i=!0);if(e!==0){const n=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.zManipulation.available=n&&this.enableZVertex&&Nt(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n&&e!==1}else{const n=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=n,this._moveManipulation.xyAxisManipulation.available=n,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=n,this._moveManipulation.zManipulation.available=n&&this.enableZShape&&Nt(this.graphic)}if(e!==0){let n=0;if(c(a)){const r=a.handle.pos,o=c(s)?s.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,l=m(s)&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;o&&l?this._moveManipulation.xyAxisManipulation.available=!1:o?n=sr(o,r):l&&(n=sr(r,l))}this._moveManipulation.angle=n,this._moveManipulation.radius=go}else this._moveManipulation.angleDeferred=()=>yo(R(this.graphic.geometry)),this._moveManipulation.radius=Ft.radiusForSymbol(this.graphic.symbol);e!==0&&i?(Q(t,t,1/e),vi.spatialReference=R(this._editGeometryOperations).data.spatialReference,vi.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,vi),this._moveManipulation.elevationAlignedLocation=vi):c(this._outlineVisualElement)&&!this._graphicState.isDraped&&c(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:ho(this.view,this._moveManipulation,this.graphic)}_removeVertices(t){const e=[],i=R(this._editGeometryOperations);for(const a of t)if(a.type==="vertex"&&i.canRemoveVertex()){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const s=R(i.removeVertices([a.handle]).removedVertices[0].createdEdge);s&&this._createVertexOrEdgeManipulator(s)}if(e.length>0){const a=e.map(n=>{const r=i.data.components.indexOf(n.component);return{coordinates:i.data.coordinateHelper.vectorToArray(n.pos),componentIndex:r,vertexIndex:R(n.index)}});this.outputGeometry=i.data.geometry;const s=this._updateEventState(F.RESHAPING);if(this.destroyed||(this.emit("vertex-remove",{type:"vertex-remove",removed:a.map(n=>n.coordinates),vertices:a}),this.destroyed)||s&&(this._updateEventState(F.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=e.action==="start"?st.NEW_STEP:st.ACCUMULATE_STEPS){const a=R(this._editGeometryOperations);a.moveVertices(t.map(s=>s.handle),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const s of t)this._updateManipulatorPosition(s)}_offsetEdge(t,e){if(m(e.operation)||m(e.signedDistance))return;const i=R(this._editGeometryOperations),a=e.operation.clone();a.distance=e.signedDistance,i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),e.type==="vertex"&&(e.manipulator.selected=!e.manipulator.selected,t.button===Js.Right&&this._removeVertices([e])),e.type==="edge"&&t.button===Js.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const i=this._manipulatorInfos.filter(a=>a.type==="vertex"&&a.manipulator.selected);i.length===1?this._updateTranslateVertexTooltip(i[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const i=this._tooltipOptions;if(!i.enabled)return;const a=t===G.Z,s=a?new Ve({tooltipOptions:i}):new Te({tooltipOptions:i});if(c(e)&&e.action!=="end"){const{mapStart:n,mapEnd:r}=e,o=a?Ma(n,r):Ai(n,r,this._graphicState.isDraped?"on-the-ground":"absolute-height");s.distance=c(o)?o:xt}this._tooltip.info=s}_updateTranslateVertexTooltip(t,e,i){const a=this._tooltipOptions;if(!a.enabled)return;const s=e===G.Z,n=new ft({tooltipOptions:a});if(c(i)&&i.action!=="end"){const{mapStart:l,mapEnd:d}=i,p=s?Ma(l,d):Ai(l,d,this._graphicState.isDraped?"on-the-ground":"absolute-height");n.distance=c(p)?p:xt}const r=Dl(t.elevationAlignedLocation);c(r)&&(n.elevation={mode:"absolute-height",...r});const{geometry:o}=this.graphic;c(o)&&!s&&(n.area=o.type==="polygon"?$l(o,this._graphicState.isDraped):null,n.totalLength=o.type==="polyline"?Cl(o,this._graphicState.isDraped?"on-the-ground":"absolute-height"):null),this._tooltip.info=n}get test(){return{segmentLabels:this._segmentLabels,tooltip:this._tooltip}}};function sr(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}function Gd(t,e,i,a,s){if(t){const n=s.toXYZ(s.pointToVector(i)),r=Hl(a,n,M.get()),o=Ll(r,n,s.spatialReference);if(c(o))return Ti(o.value*Math.sign(e),o.unit)}return Ti(e*os(i.spatialReference),"meters")}h([u()],J.prototype,"_segmentLabels",void 0),h([u({constructOnly:!0})],J.prototype,"tool",void 0),h([u()],J.prototype,"_tooltip",void 0),h([u()],J.prototype,"inputGeometry",null),h([u()],J.prototype,"outputGeometry",void 0),h([u({readOnly:!0})],J.prototype,"updating",null),h([u()],J.prototype,"manipulators",null),h([u()],J.prototype,"view",null),h([u()],J.prototype,"graphic",null),h([u()],J.prototype,"enableZShape",null),h([u()],J.prototype,"enableZVertex",null),h([u()],J.prototype,"enableMoveGraphic",null),h([u()],J.prototype,"enableMidpoints",null),h([u()],J.prototype,"enableEdgeOffset",null),h([u()],J.prototype,"_labelOptions",null),h([u()],J.prototype,"_tooltipOptions",null),J=h([k("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],J);const vi=Wi(0,0,null,null),sa=b();var Le,F,Kt;(function(t){t.Vertex=ae.Custom1,t.Edge=ae.Custom2})(Le||(Le={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(F||(F={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(Kt||(Kt={}));let ie=class extends Ue.EventedMixin(Ra){constructor(t){super(t),this._handles=new lt,this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.labelOptions=new Pa,this.tooltipOptions=new Je,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new J({tool:this});this.own([t.on("reshape",e=>{e.type==="reshape"&&this._onReshapeGeometryChanged(),this.emit("reshape",e)}),t.on("move",e=>{e.type==="move"&&this._onReshapeGeometryChanged(),this.emit("move",e)}),t.on("vertex-add",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",e)}),t.on("vertex-remove",e=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",e)}),t.on("immediate-click",e=>this.emit("immediate-click",e)),this.view.on("pointer-down",["Shift"],e=>{e.stopPropagation()}),L(()=>this.graphic,()=>this._updateGraphic(),Es)]),this.finishToolCreation()}destroy(){this._handles=U(this._handles),this._reshapeOperation=U(this._reshapeOperation)}get updating(){var t,e;return(e=(t=this._reshapeOperation)==null?void 0:t.updating)!=null?e:!1}_updateGeometry(){const t=nl(this.graphic);this._reshapeOperation.inputGeometry=c(t)?t.clone():null}_updateGraphic(){if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),rl(this.graphic)!==Dr.SUPPORTED)return;const t=L(()=>{var e;return(e=this.graphic)==null?void 0:e.geometry},()=>{this._internalGeometryUpdate===!1&&this._updateGeometry()},ya);this._handles.add(t,"onGraphicGeometryChange")}manipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0,this.graphic.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){m(this.graphic)||this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canUndo(){var t;return(t=this._reshapeOperation.canUndo)!=null?t:!1}undo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.undo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}get canRedo(){var t;return(t=this._reshapeOperation.canRedo)!=null?t:!1}redo(){c(this.snappingManager)&&this.snappingManager.doneSnapping(),c(this._reshapeOperation.redo())&&this._updateGeometryInternally(this._reshapeOperation.outputGeometry.clone())}onInputEvent(t){t.type!=="key-down"||t.key!=="Delete"&&t.key!=="Backspace"||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};h([u()],ie.prototype,"_reshapeOperation",void 0),h([u({constructOnly:!0,nonNullable:!0})],ie.prototype,"view",void 0),h([u({constructOnly:!0})],ie.prototype,"graphic",void 0),h([u({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableZShape",void 0),h([u({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableZVertex",void 0),h([u({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableMoveGraphic",void 0),h([u({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableMidpoints",void 0),h([u({constructOnly:!0,nonNullable:!0})],ie.prototype,"enableEdgeOffset",void 0),h([u()],ie.prototype,"type",void 0),h([u({constructOnly:!0,type:Pa})],ie.prototype,"labelOptions",void 0),h([u({constructOnly:!0,type:Je})],ie.prototype,"tooltipOptions",void 0),h([u({constructOnly:!0})],ie.prototype,"snappingManager",void 0),h([u()],ie.prototype,"updating",null),h([u()],ie.prototype,"automaticManipulatorSelection",void 0),ie=h([k("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],ie);let et=class extends ht{constructor(t){super(t),this.type="transform-rotate",this.rotationType="geographic"}};h([u()],et.prototype,"type",void 0),h([u()],et.prototype,"rotation",void 0),h([u()],et.prototype,"rotationPrecision",void 0),h([u()],et.prototype,"orientation",void 0),h([u()],et.prototype,"orientationPrecision",void 0),h([u()],et.prototype,"rotationType",void 0),et=h([k("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],et);let vt=class extends ht{constructor(t){super(t),this.type="transform-scale",this.sizeUnit=null,this.sizePrecision=null}};h([u()],vt.prototype,"type",void 0),h([u()],vt.prototype,"scale",void 0),h([u()],vt.prototype,"size",void 0),h([u()],vt.prototype,"sizeUnit",void 0),h([u()],vt.prototype,"sizePrecision",void 0),vt=h([k("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],vt);let we=class extends ht{constructor(t){super(t),this.type="transform-absolute",this.orientationEnabled=!0,this.orientationPrecision=null,this.rotationType="geographic",this.sizeUnit=null,this.sizeEnabled=!0,this.sizePrecision=null}};h([u()],we.prototype,"type",void 0),h([u()],we.prototype,"orientation",void 0),h([u()],we.prototype,"orientationEnabled",void 0),h([u()],we.prototype,"orientationPrecision",void 0),h([u()],we.prototype,"rotationType",void 0),h([u()],we.prototype,"size",void 0),h([u()],we.prototype,"sizeUnit",void 0),h([u()],we.prototype,"sizeEnabled",void 0),h([u()],we.prototype,"sizePrecision",void 0),we=h([k("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],we);var I,oi;(function(t){t.ScaleIn=ae.Custom2,t.ScaleOut=ae.Custom3,t.RotateLeft=ae.Custom4,t.RotateRight=ae.Custom5,t.Unlocked=ae.Custom7,t.DelayedFocused=ae.Custom8,t.TouchInput=ae.Custom12})(I||(I={}));class Vd{constructor({adapter:e,tooltipOptions:i,mode:a,tool:s}){this.mode=null,this._handles=new lt,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new Ue,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode==="scale"?this.adapter.scale:1,this.tool=s,this.mode=a,this.adapter=e,this._tooltipOptions=i,this._tooltip=new zi({view:s.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(si(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),qe))}get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(e){this._ringManipulator.location=e}set elevationAlignedLocation(e){this._ringManipulator.elevationAlignedLocation=e}get grabbing(){return this._ringManipulator.grabbing}set interactive(e){this._ringManipulator.interactive=e}destroy(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles=U(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=U(this._tooltip)}startAnimation(e){this.cancelActiveAnimation(),e.start();const i=ol({update:({deltaTime:a})=>{e.update(a)&&this.cancelActiveAnimation()}});this._activeAnimation={...e,frameTask:i}}cancelActiveAnimation(){c(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=U(this._activeAnimation))}forEachManipulator(e){e(this._ringManipulator,C.SCALE_ROTATE)}_createManipulator(){const e=this._createRingManipulator();this._ringManipulator=e,this.tool.manipulators.add(e);const i=this.tool.graphicState.graphic,a=Ne(e,(s,n,r)=>{this._scaleRotateDragData=null;const o=this.adapter.startInteraction(),l={mode:"none",origin:ua(s.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const d=M.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(s.renderLocation,d),n.next(Ta(this.tool.view,Ht(s.renderLocation,d,hi()))).next(p=>{const g=Fi(p.plane),_=oo(p.renderStart,p.renderEnd,l.origin,g),v=ll.shortestSignedDiff(l.angle,_);l.angleDir=_a(l.angleDir+v,-Zn,Zn),l.angle=_;const f=zd(l,p),S=f-this.adapter.scale;if(l.scaleDir=_a(l.scaleDir+S,-Wn,Wn),this._onScaleChanged(),l.mode==="none"){const w=this.mode||Nd(p,p.plane,l.origin,this.tool.view.state.camera);if(c(w)){switch(w){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:i,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:i,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}l.mode=w}}switch(l.mode){case"rotate":o.state.angle=l.initialAngle+_;break;case"scale":o.state.scale=f,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),p.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:i,angle:Oi(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:i,xScale:f,yScale:f})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:Oi(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:f,yScale:f})}}return p.action==="end"&&(this.startAnimation(nr(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),o.done()),p}).next(this._updateTooltipPipelineStep(l)),r.next(()=>{if(o.cancel(),c(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:i,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:i,xScale:1,yScale:1})}this.startAnimation(nr(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([a,e.events.on("focus-changed",s=>{s.action==="focus"?this.startAnimation(Fd(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),e.events.on("immediate-click",s=>{s.stopPropagation()}),L(()=>{var s;return(s=this.tool.graphicState)==null?void 0:s.displaying},s=>this._ringManipulator.available=s,qe)])}_updateTooltipPipelineStep(e){return i=>{const a=this._tooltipOptions;if(!a.enabled)return i;if(i.action==="end")return this._updateFocusTooltip(),i;const s=this._tooltip,n=this._tooltipOptions.visualVariables,r=c(n)?n.size:null,o=c(n)?n.rotation:null;switch(e.mode){case"scale":s.info=new vt({tooltipOptions:a,scale:{value:this.adapter.scale},size:Ti(W(this.adapter.size,-1),"meters"),sizeUnit:c(r)?r.unit:null,sizePrecision:c(r)?ra(r.valueType):null});break;case"rotate":{const l=c(o)?ra(o.valueType):null,d=c(o)?o.rotationType:"geographic";s.info=new et({tooltipOptions:a,rotation:ka(W(-this.adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:l,orientation:ka(-this.adapter.angle,"radians","geographic"),orientationPrecision:l,rotationType:d})}}return i}}_updateFocusTooltip(){if(!!this._tooltipOptions.enabled)if(this.getFocused()){const e=this._tooltipOptions.visualVariables,i=c(e)?e.rotation:null,a=c(e)?e.size:null;this._tooltip.info=new we({tooltipOptions:this._tooltipOptions,orientation:ka(-this.adapter.angle,"radians","geographic"),orientationEnabled:this.mode==null||this.mode==="rotate",orientationPrecision:c(i)?ra(i.valueType):null,rotationType:c(i)?i.rotationType:"geographic",size:Ti(W(this.adapter.size,-1),"meters"),sizeUnit:c(a)?a.unit:null,sizeEnabled:this.mode==null||this.mode==="scale",sizePrecision:c(a)?ra(a.valueType):null})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(I.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(I.Unlocked,!(c(this._scaleRotateDragData)&&this._scaleRotateDragData.mode!=="none")),c(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(I.ScaleIn|I.ScaleOut,!1),this._ringManipulator.updateStateEnabled(I.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(I.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(I.RotateLeft|I.RotateRight,!1),this._ringManipulator.updateStateEnabled(I.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(I.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(I.ScaleIn|I.ScaleOut|I.RotateLeft|I.RotateRight,!1)}_updateManipulatorTransform(){const e=Ar(se.get(),this.adapter.angle,N(0,0,1));if(m(e))return;const i=this.getScale(),a=va(se.get(),Z(M.get(),i,i,i));this._ringManipulator.modelTransform=Ze(se.get(),a,e)}_createRingManipulator(){const e=(Y,He,dt)=>{const pt=[],ut=Math.ceil(po*(He-Y)/(2*Math.PI));for(let oe=0;oe<ut+1;oe++){const di=Y+oe*(He-Y)/ut;pt.push(N(dt*Math.cos(di),dt*Math.sin(di),0))}return pt},i=Y=>e(0,2*Math.PI,Y),a=Y=>[[-Y/2,0],[Y/2,0],[Y/2,Za/2],[-Y/2,Za/2]],s=(Y,He)=>V.createPathExtrusionGeometry(a(He),Y,[],[],!1),n=i(Ct),r=s(n,Xa),o={left:[],right:[]},l=[];for(let Y=0;Y<2;Y++){const He=Y*Math.PI-Math.PI/4,dt=Math.PI/2-gd,pt=He+dt,ut=He+Math.PI/2-dt,oe=e(pt,ut,dd),di=s(oe,Yt);l.push(oe),l.push(e(pt,ut,kn-Xa/2)),o.left.push(di),o.right.push(di);for(let Ua=0;Ua<2;Ua++){const Us=Ua===0,fe=_e();if(Us){Vi(fe,fe,[1,-1,1]),Ks(fe,fe,-pt,[0,0,1]);const At=Math.round(Bn*(oe.length-1));fe[12]=oe[At][0],fe[13]=oe[At][1],fe[14]=oe[At][2]}else{Ks(fe,fe,ut,[0,0,1]);const At=Math.round((1-Bn)*(oe.length-1));fe[12]=oe[At][0],fe[13]=oe[At][1],fe[14]=oe[At][2]}const Hs=V.createExtrudedTriangle(pd,0,ud,Za);V.transformInPlace(Hs,fe),(Us?o.left:o.right).push(Hs)}}const d=[];for(let Y=0;Y<2;Y++){const He=Y*Math.PI-Math.PI/4,dt=Math.PI/2-_d,pt=He+dt,ut=He+Math.PI/2-dt,oe=e(pt,ut,kn);d.push(s(oe,Yt))}const p=i(Ct+qn),g=i(Ct+Yn),_=s(p,Yt),v=s(g,Yt),f=i(Ct-qn),S=i(Ct-Yn),w=s(f,Yt),x=s(S,Yt),O=this._createMaterial(),j=this._createMaterial(.66),de=this._createMaterial(.5),ct=this._createMaterial(.33);let me=[{geometry:r,material:O,stateMask:I.DelayedFocused},{geometry:r,material:de,stateMask:E.None}];this.mode&&this.mode!=="scale"||(me=me.concat([{geometry:d,material:O,stateMask:I.DelayedFocused|I.Unlocked},{geometry:_,material:j,stateMask:I.DelayedFocused|I.ScaleIn},{geometry:v,material:ct,stateMask:I.DelayedFocused|I.ScaleIn},{geometry:w,material:j,stateMask:I.DelayedFocused|I.ScaleOut},{geometry:x,material:ct,stateMask:I.DelayedFocused|I.ScaleOut}])),this.mode&&this.mode!=="rotate"||(me=me.concat([{geometry:o.right,material:O,stateMask:I.DelayedFocused|I.Unlocked},{geometry:o.left,material:O,stateMask:I.DelayedFocused|I.RotateLeft},{geometry:o.right,material:O,stateMask:I.DelayedFocused|I.RotateRight}]));const Ot=[n,...l];return new ce({view:this.tool.view,renderObjects:me,autoScaleRenderObjects:!1,worldOriented:!0,radius:Xa,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:X(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:Ot,direction:N(0,0,1)}})}_createMaterial(e=1){const i=Et([...od,e]);return new Ye({color:i,transparent:e!==1,cullFace:K.Back,renderOccluded:D.Transparent})}get test(){return{ringManipulator:this._ringManipulator,tooltip:this._tooltip}}}function zd(t,e){const i=P(M.get(),e.renderStart,t.origin),a=P(M.get(),e.renderEnd,t.origin),s=Pe(i),n=Pe(a);return s===0?0:n/s}function Nd(t,e,i,a){const{renderStart:s,renderEnd:n}=t,r=na(s,a,M.get()),o=na(n,a,M.get());if(wr(r,o)<jn*jn)return null;const l=P(M.get(),s,i),d=Se(M.get(),l,Fi(e)),p=s,g=z(M.get(),p,d),_=na(i,a,M.get()),v=r,f=na(g,a,M.get()),S=P(M.get(),f,v),w=P(M.get(),r,_),x=hs(v,S),O=hs(_,w);return hn(x,o)<hn(O,o)?"rotate":"scale"}function na(t,e,i){return e.projectToScreen(t,Qa),Z(i,Qa[0],Qa[1],0)}function nr(t,e){let i=null,a=1;const s=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=s,e()},update:n=>(a+=((a+1)/2-a)*Math.min(n*fd,1),e(),Math.abs(a-1)<.01?oi.STOP:oi.CONTINUE),destroy:()=>{t.getScale=i,e()}}}function Fd(t,e){let i=0,a=null;const s=()=>!1;return{start:()=>{a=t.getFocused,t.getFocused=s,i=0,e()},update:n=>(i+=n,!a()||i>md?oi.STOP:oi.CONTINUE),destroy:()=>{t.getFocused=a,e()}}}function ra(t){switch(t){case"integer":case"long":return 0;default:return null}}(function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"})(oi||(oi={}));const Qa=Me();function bo(t){return c(t.geometry)&&t.geometry.type==="mesh"?Ud(t.geometry):Hd(t)}function Ud(t){return c(t.transform)?kd(t,t.transform):jd(t)}function Hd(t){let e=t.geometry,i=hl;return{undo(a){i=a.geometry,a.geometry=e},redo(a){e=a.geometry,a.geometry=i}}}function kd(t,e){let i=e.clone(),a=null;return{undo:s=>{a=c(t.transform)?t.transform.clone():null,t.transform=i,s.notifyGeometryChanged()},redo:s=>{i=c(t.transform)?t.transform.clone():null,t.transform=a,s.notifyGeometryChanged()}}}function jd(t){let e,i=t.vertexAttributes.clonePositional();return{undo:a=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,a.notifyGeometryChanged()}}}let tt=class extends Os{constructor(t){super(t),this.interactionState=null}initialize(){this.own([si(()=>c(this.interactionState)&&this.interactionState.angle!==this.interactionState.previousAngle?{interactionState:this.interactionState,angle:this.interactionState.state.angle}:null,({interactionState:t})=>{this._updateMeshRotation(t)},ya),si(()=>c(this.interactionState)&&this.interactionState.scale!==this.interactionState.previousScale?{interactionState:this.interactionState,scale:this.interactionState.state.scale}:null,({interactionState:t})=>{this._updateMeshSize(t)},ya)])}get angle(){const t=this.geometry.transform;if(m(t))return 0;const e=Yh(t.rotation)[2];return Math.abs(e)>.999999?rt(Wh(t.rotation))*Math.sign(e):0}get scale(){return c(this.interactionState)?this.interactionState.scale:1}startInteraction(){const t=new it({angle:this.angle});this.interactionState=t;const e=()=>this.interactionState=null;return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return bo(this.graphic)}_updateMeshRotation(t){const e=this.geometry.anchor,i=this.viewingMode===ls.Global,{angle:a,previousAngle:s}=t;this.geometry.rotate(0,0,Oi(a-s),{origin:e,geographic:i}),t.previousAngle=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}_updateMeshSize(t){const e=this.geometry.anchor,i=this.viewingMode===ls.Global,{scale:a,previousScale:s}=t;this.geometry.scale(a/s,{origin:e,geographic:i}),t.previousScale=a,c(this.geometry.transform)&&this.graphic.notifyMeshTransformChanged(),this.graphic.notifyGeometryChanged()}};h([u({constructOnly:!0})],tt.prototype,"graphic",void 0),h([u({constructOnly:!0})],tt.prototype,"geometry",void 0),h([u({constructOnly:!0})],tt.prototype,"viewingMode",void 0),h([u()],tt.prototype,"angle",null),h([u()],tt.prototype,"scale",null),h([u()],tt.prototype,"interactionState",void 0),tt=h([k("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],tt);let it=class extends Ii{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}cancel(){this.angle=this.initialAngle,this.scale=1}};h([u()],it.prototype,"angle",void 0),h([u()],it.prototype,"initialAngle",void 0),h([u()],it.prototype,"previousAngle",void 0),h([u()],it.prototype,"previousScale",void 0),h([u()],it.prototype,"scale",void 0),h([u()],it.prototype,"state",null),it=h([k("InteractionState")],it);let le=class extends Os{constructor(t){super(t),this.sizeAxis=null,this.interactionState=null}initialize(){this.own(si(()=>c(this.interactionState)?this.interactionState.state:null,t=>{this._updateSymbol(t)},ya))}get angle(){return c(this.interactionState)?this.interactionState.angle:c(this._orientationReferenceSymbolLayer)?Bd(this._orientationReferenceSymbolLayer.heading):0}get scale(){return c(this.interactionState)?this.interactionState.scale:1}get relativeAngle(){return this.angle-this.initialAngle}get initialAngle(){return c(this.interactionState)?this.interactionState.initialAngle:0}get size(){const t=this._sizeReferenceSymbolLayer;if(m(t))return null;const e=this.findLayerView(),i=this._graphicSymbol;if(m(e)||m(i)||i.type!=="point-3d")return null;const a=e.getSymbolLayerSize(i,t);if("size"in a&&c(a.size))return a.size;const s=this.sizeAxis;return"width"in a&&c(a.width)&&(m(s)||s==="width"||s==="all"||s==="width-and-depth")?a.width:"depth"in a&&c(t.depth)&&(m(s)||s==="depth"||s==="all"||s==="width-and-depth")?a.depth:"height"in a&&c(t.height)&&(m(s)||s==="height"||s==="all")?a.height:null}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return m(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object")}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return m(t)||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object"&&c(e.heading))}get _graphicSymbol(){return c(this.graphic)&&c(this.graphic.symbol)&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(c(this.interactionState)||m(t)||m(e))return qd;const i=t.symbolLayers.map(o=>o.type==="object"?e.getSymbolLayerSize(t,o):null).toArray(),a=t.clone(),s=this.angle,n=new at({originalSymbol:a,angle:s,initialSizes:i});this.interactionState=n;const r=()=>this.interactionState=null;return{state:n,done:r,cancel:()=>{this._graphicSymbol=a,r()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:a}){const s=this._graphicSymbol;if(m(s)||s.type!=="point-3d")return;const n=s.clone(),r=-Oi(e-this.initialAngle);let o=!1;this._forEachObjectSymbolLayerPair(i,n,(l,d,p)=>{const g=W(l.heading,0)+r;d.heading!==g&&(d.heading=g,o=!0);const _=a[p];if(c(_)&&"width"in _){_.width=this.sizeFilter(_.width),_.height=this.sizeFilter(_.height),_.depth=this.sizeFilter(_.depth);const v=_.width*t;d.width!==v&&(d.width=v,o=!0);const f=_.depth*t;d.depth!==f&&(d.depth=f,o=!0);const S=_.height*t;d.height!==S&&(d.height=S,o=!0)}}),o&&(this._graphicSymbol=n)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach((a,s)=>{const n=e.symbolLayers.getItemAt(s);a.type==="object"&&n.type==="object"&&i(a,n,s)})}};function Bd(t){return-rt(t)}h([u()],le.prototype,"angle",null),h([u()],le.prototype,"scale",null),h([u()],le.prototype,"relativeAngle",null),h([u()],le.prototype,"initialAngle",null),h([u()],le.prototype,"size",null),h([u()],le.prototype,"sizeAxis",void 0),h([u({constructOnly:!0})],le.prototype,"graphic",void 0),h([u()],le.prototype,"interactionState",void 0),h([u({constructOnly:!0})],le.prototype,"findLayerView",void 0),h([u({constructOnly:!0})],le.prototype,"sizeFilter",void 0),h([u()],le.prototype,"_sizeReferenceSymbolLayer",null),h([u()],le.prototype,"_orientationReferenceSymbolLayer",null),h([u()],le.prototype,"_graphicSymbol",null),le=h([k("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],le);const qd={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let at=class extends Ii{constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:s}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:s}}};h([u()],at.prototype,"originalSymbol",void 0),h([u()],at.prototype,"angle",void 0),h([u()],at.prototype,"initialAngle",void 0),h([u()],at.prototype,"initialSizes",void 0),h([u()],at.prototype,"scale",void 0),h([u()],at.prototype,"state",null),at=h([k("InteractionState")],at);let pe=class extends Rr(Ue.EventedMixin(Ra)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Je,this.type="transform-3d",this._scaleRotate=null,this._snappingPipeline=new ba,this._tooltip=null}initialize(){const{graphic:t,view:e}=this;this.graphicState=new ye({graphic:t}),this.own(L(()=>this.tooltipOptions.enabled,a=>{this._tooltip=a?new zi({view:e}):U(this._tooltip)},Es)),this._moveManipulation=new Ft({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Nt(t),radius:Ft.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((a,s)=>this.handles.add([a.events.on("immediate-click",n=>{this.emit("immediate-click",{...n,graphic:t}),n.stopPropagation()}),a.events.on("focus-changed",({action:n})=>{const{tooltipOptions:r,_tooltip:o}=this;if(!m(o)&&(o.clear(),n==="focus")){const l=s===C.TRANSLATE_Z?Ve:Te;o.info=new l({tooltipOptions:r})}})])),this._moveManipulation.elevationInfo=X(t);const i=t.geometry;if(this._moveManipulation.createGraphicDragPipeline((a,s,n,r,o)=>(c(i)&&a===G.XY&&(n=n.next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:new xa({elevationInfo:X(t),pointer:o,editGeometryOperations:$a.fromGeometry(new ti({spatialReference:i.spatialReference}),e.state.viewingMode),visualizer:new Di,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this.updatingHandles,cancel:r}),this._snappingPipeline.next)),n=n.next(l=>{const{tooltipOptions:d,_tooltip:p}=this;if(m(p))return l;const{mapStart:g,mapEnd:_}=l;p.clear();const v=a===G.Z?Ve:Te;if(l.action==="end")p.info=new v({tooltipOptions:d});else{const f=a===G.Z?Ma(g,_):Ai(g,_,this.graphicState.isDraped?"on-the-ground":"absolute-height");c(f)&&(p.info=new v({tooltipOptions:d,distance:f}))}return l})),this.graphicState,a=>{const{action:s,graphic:n,dxScreen:r,dyScreen:o}=a,l={graphic:n,dxScreen:r,dyScreen:o};switch(s){case"start":this.emit("graphic-translate-start",l),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",l);break;case"end":this.emit("graphic-translate-stop",l)}}),this._moveManipulation.angle=c(this._scaleRotate)?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.handles.add(L(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const a=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Vd({tool:this,mode:a,adapter:this._scaleRotateAdapter,tooltipOptions:this.tooltipOptions}),this.handles.add(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.handles.add([Ga({view:this.view,graphic:this.graphic,forEachManipulator:a=>this._forEachManipulator(a),onManipulatorsChanged:()=>Vt()}),this.graphicState.on("changed",()=>this._onGeometryChanged()),this._hideManipulatorsForGraphicState(),L(()=>e.scale,()=>this._updateMoveAngle())]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(a=>{a instanceof ce&&this.handles.add(a.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))}),this.finishToolCreation()}destroy(){this._tooltip=U(this._tooltip),this._moveManipulation.destroy(),this._scaleRotate=U(this._scaleRotate),this._scaleRotateAdapter=U(this._scaleRotateAdapter),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){m(this._scaleRotate)||(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return c(this.graphic.geometry)&&this.graphic.geometry.type==="mesh"?new tt({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new le({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find(t=>t.layer===this.graphic.layer),sizeAxis:c(this.tooltipOptions.visualVariables)&&c(this.tooltipOptions.visualVariables.size)?this.tooltipOptions.visualVariables.size.axis:null})}_forEachManipulator(t){this._moveManipulation.forEachManipulator(t),c(this._scaleRotate)&&this._scaleRotate.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return L(()=>this.graphicState.displaying,t=>{this._forEachManipulator(e=>e.available=t),this._moveManipulation.zManipulation.available=t&&this.enableZ&&Nt(this.graphic)})}_createGeometryUndoRecord(){return bo(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this.updatingHandles.updating}set location(t){this._moveManipulation.location=t,c(this._scaleRotate)&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,c(this._scaleRotate)&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){c(this._scaleRotate)&&this._scaleRotate.cancelActiveAnimation()}_onScaleChanged(){if(m(this._scaleRotate))return;const t=this._scaleRotate.getScale();this._moveManipulation.displayScale=t}_updateMoveAngle(){this.view.state.viewingMode===ls.Local||this.view.scale<vd?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){ho(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:c(this._scaleRotate)?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate,tooltip:this._tooltip}}};h([u({constructOnly:!0,nonNullable:!0})],pe.prototype,"view",void 0),h([u({constructOnly:!0,nonNullable:!0})],pe.prototype,"graphic",void 0),h([u({constructOnly:!0,nonNullable:!0})],pe.prototype,"enableZ",void 0),h([u()],pe.prototype,"enableRotation",void 0),h([u()],pe.prototype,"enableScaling",void 0),h([u({constructOnly:!0,type:Je})],pe.prototype,"tooltipOptions",void 0),h([u()],pe.prototype,"graphicState",void 0),h([u({value:!1})],pe.prototype,"snapToScene",null),h([u({constructOnly:!0})],pe.prototype,"snappingManager",void 0),h([u({readOnly:!0})],pe.prototype,"type",void 0),h([u({readOnly:!0})],pe.prototype,"updating",null),pe=h([k("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],pe);let mt=class extends cl(pl){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&dl(this.position,t.position)&&this.width===t.width&&this.height===t.height}};h([u({readOnly:!0,json:{read:!1,write:!0}})],mt.prototype,"type",void 0),h([u({type:ti}),ui()],mt.prototype,"position",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:360}}),ui(),en(t=>tn.normalize(an(t),0,!0))],mt.prototype,"heading",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:360}}),ui(),en(t=>tn.normalize(an(t),0,!0))],mt.prototype,"tilt",void 0),h([u({type:Number,nonNullable:!0}),ui()],mt.prototype,"width",void 0),h([u({type:Number,nonNullable:!0}),ui()],mt.prototype,"height",void 0),mt=h([k("esri.analysis.SlicePlane")],mt);Pr("mac");const Yd=2,Wd=1.15,Zd=1.15,Xd=1.1,Qd=.7,ci=N(1,.5,0);Et([...ci,Qd]);Et([...ci,.5]);const Jd=Et([...ci,1]),Kd=ot(1,1,1,1),ep=ot(1,.8,.6,1),tp=ot(1,.93,.86,1),ip=Et([...ci,1]),ap=Et([...ci,1]),sp=3,rr=11,np=22.5,Ja=40,or=48,rp=2.25,op=Et([...ci,1]),lp=4,lr=1,hp=.3,cp=6,dp=4,hr=12,pp=40,up=27;function gp(t){const e=new Ui;return e.extensions.add("GL_OES_standard_derivatives"),Ps(e,t),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UV0,"vec2"),e.varyings.add("vUV","vec2"),e.vertex.code.add($`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),e.fragment.uniforms.add([new wa("backgroundColor",i=>i.backgroundColor),new wa("gridColor",i=>i.gridColor),new Oe("gridWidth",i=>i.gridWidth)]),e.fragment.code.add($`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),e}const _p=Object.freeze(Object.defineProperty({__proto__:null,build:gp},Symbol.toStringTag,{value:"Module"}));class Fs extends Hi{initializeProgram(e){const i=Fs.shader.get().build(this.configuration);return new ki(e.rctx,i,Ts)}initializePipeline(){return qi({blending:Ah(We.ONE,We.ONE,We.ONE_MINUS_SRC_ALPHA,We.ONE_MINUS_SRC_ALPHA),depthTest:{func:la.LESS},colorWrite:Yi})}}Fs.shader=new ji(_p,()=>Gi(()=>import("./SlicePlaneMaterial.glsl.7fb0ca60.js"),["assets/SlicePlaneMaterial.glsl.7fb0ca60.js","assets/Matrix4Uniform.b7dc351c.js","assets/index.9da382e4.js","assets/index.313b6d72.css","assets/enums.de935fa5.js","assets/Texture.599541db.js","assets/requestImageUtils.4ea1aefd.js","assets/geometryDataUtils.337d3a34.js","assets/triangle.70405bec.js","assets/vectorStacks.f85d4a03.js","assets/quatf64.ddec7ef6.js","assets/mat4f64.84d5c445.js","assets/lineSegment.901d4e43.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.4198c73f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.9de22bcf.js","assets/quat.2f83a288.js","assets/vec3f32.0772c8d8.js","assets/sphere.f1597b20.js","assets/drawSurfaces.e22da837.js","assets/SnappingContext.24f379b6.js","assets/PointSnappingHint.427009a4.js","assets/plane.f3b639d8.js","assets/drawUtils.fc519f2d.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.98692fb8.js","assets/vec4f32.8f10672a.js","assets/Octree.5f16cd20.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.e9290885.js","assets/types.28f12cac.js","assets/NativeLineMaterial.2ca4252c.js","assets/floatRGBA.b2358e75.js","assets/triangulationUtils.27ba054b.js","assets/deduplicate.c1f3fafb.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.2500e48f.js","assets/colorUtils.9445c15b.js","assets/GraphicManipulator.81a13ed3.js","assets/drapedUtils.765e9a9c.js","assets/axisAngleDegrees.16b78055.js","assets/persistable.1aa521e0.js"]));function mp(t){const e=new Ui;Ps(e,t),e.include(kr),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UV0,"vec2"),e.varyings.add("vpos","vec3"),t.hasMultipassTerrain&&e.varyings.add("depth","float");const{vertex:i,fragment:a}=e;return i.uniforms.add(new It("textureCoordinateScaleFactor",s=>c(s.texture)&&c(s.texture.descriptor.textureCoordinateScaleFactor)?s.texture.descriptor.textureCoordinateScaleFactor:ul)),i.code.add($`
    void main(void) {
      vpos = position;
      ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0 * textureCoordinateScaleFactor;
      gl_Position = transformPosition(proj, view, vpos);
    }
  `),e.include(jr,t),e.include(qr,t),a.uniforms.add([new Fr("tex",s=>s.texture),new Oe("opacity",s=>s.opacity)]),e.varyings.add("vTexCoord","vec2"),t.output===q.Alpha?a.code.add($`
    void main() {
      discardBySlice(vpos);
      ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

      float alpha = texture2D(tex, vTexCoord).a * opacity;
      if (alpha  < ${$.float(cn)}) {
        discard;
      }

      gl_FragColor = vec4(alpha);
    }
    `):(a.include(Br),a.code.add($`
    void main() {
      discardBySlice(vpos);
      ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
      gl_FragColor = texture2D(tex, vTexCoord) * opacity;

      if (gl_FragColor.a < ${$.float(cn)}) {
        discard;
      }

      gl_FragColor = highlightSlice(gl_FragColor, vpos);
      ${t.transparencyPassType===Qe.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    }
    `)),e}const fp=Object.freeze(Object.defineProperty({__proto__:null,build:mp},Symbol.toStringTag,{value:"Module"}));class Na extends Hi{initializeProgram(e){const i=Na.shader.get().build(this.configuration);return new ki(e.rctx,i,Ts)}_setPipelineState(e,i){const a=this.configuration,s=e===Qe.NONE,n=e===Qe.FrontFace;return qi({blending:a.output!==q.Color&&a.output!==q.Alpha||!a.transparent?null:s?vp:Jr(e),culling:Kr(a.cullFace),depthTest:{func:Th(e)},depthWrite:s?a.writeDepth&&eo:to(e),colorWrite:Yi,stencilWrite:a.hasOccludees?ih:null,stencilTest:a.hasOccludees?i?ah:sh:null,polygonOffset:s||n?null:Ph(a.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,i){return i?this._occludeePipelineState:super.getPipelineState(e,i)}}Na.shader=new ji(fp,()=>Gi(()=>import("./ImageMaterial.glsl.dc43b538.js"),["assets/ImageMaterial.glsl.dc43b538.js","assets/index.9da382e4.js","assets/index.313b6d72.css","assets/Matrix4Uniform.b7dc351c.js","assets/enums.de935fa5.js","assets/Texture.599541db.js","assets/requestImageUtils.4ea1aefd.js","assets/geometryDataUtils.337d3a34.js","assets/triangle.70405bec.js","assets/vectorStacks.f85d4a03.js","assets/quatf64.ddec7ef6.js","assets/mat4f64.84d5c445.js","assets/lineSegment.901d4e43.js","assets/VertexAttribute.5551e0d8.js","assets/VertexArrayObject.4198c73f.js","assets/VertexElementDescriptor.d386088d.js","assets/BufferView.9de22bcf.js","assets/quat.2f83a288.js","assets/vec3f32.0772c8d8.js","assets/sphere.f1597b20.js","assets/drawSurfaces.e22da837.js","assets/SnappingContext.24f379b6.js","assets/PointSnappingHint.427009a4.js","assets/plane.f3b639d8.js","assets/drawUtils.fc519f2d.js","assets/earcut.d30cbec0.js","assets/dehydratedFeatures.98692fb8.js","assets/vec4f32.8f10672a.js","assets/Octree.5f16cd20.js","assets/glUtil.345a77b1.js","assets/InterleavedLayout.e9290885.js","assets/types.28f12cac.js","assets/NativeLineMaterial.2ca4252c.js","assets/floatRGBA.b2358e75.js","assets/triangulationUtils.27ba054b.js","assets/deduplicate.c1f3fafb.js","assets/NestedMap.21c7ee53.js","assets/boundedPlane.2500e48f.js","assets/colorUtils.9445c15b.js","assets/GraphicManipulator.81a13ed3.js","assets/drapedUtils.765e9a9c.js","assets/axisAngleDegrees.16b78055.js","assets/persistable.1aa521e0.js"]));const vp=Ls(We.ONE,We.ONE_MINUS_SRC_ALPHA);class Ce extends Yr{constructor(){super(...arguments),this.output=q.Color,this.cullFace=K.None,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=Qe.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}h([H({count:q.COUNT})],Ce.prototype,"output",void 0),h([H({count:K.COUNT})],Ce.prototype,"cullFace",void 0),h([H()],Ce.prototype,"hasSlicePlane",void 0),h([H()],Ce.prototype,"transparent",void 0),h([H()],Ce.prototype,"enableOffset",void 0),h([H()],Ce.prototype,"writeDepth",void 0),h([H()],Ce.prototype,"hasOccludees",void 0),h([H({count:Qe.COUNT})],Ce.prototype,"transparencyPassType",void 0),h([H()],Ce.prototype,"hasMultipassTerrain",void 0),h([H()],Ce.prototype,"cullAboveGround",void 0);class yp extends Wr{constructor(e){super(e,new Mp),this.supportsEdges=!0,this.techniqueConfig=new Ce}getConfiguration(e,i){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.hasOccludees=this.parameters.hasOccludees,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<Rh,this.techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this.techniqueConfig}intersect(e,i,a,s,n,r,o){ps(e,i,s,n,r,void 0,o)}requiresSlot(e,i){return e===Ae.DRAPED_MATERIAL?!0:Xr(i)===q.Highlight?e===Ae.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?Ae.TRANSPARENT_MATERIAL:Ae.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Ae.OPAQUE_MATERIAL)}createGLMaterial(e){return e.output===q.Color||e.output===q.Alpha||e.output===q.Highlight?new bp(e):void 0}createBufferWriter(){return new Sh(wh)}}class bp extends nh{constructor(e){super({...e,...e.material.parameters})}_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(Na,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&(this._material.setParameters({hasOccludees:e.hasOccludees}),this._updateParameters(e))}beginSlot(e){return this._output!==q.Color&&this._output!==q.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class Mp extends Zr{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=K.None,this.hasOccludees=!1,this.opacity=1,this.textureId=null,this.initTextureTransparent=!0}}gl.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function Sp(t,e){return lo(t.basis1,t.basis2,t.origin,e)}function wp(t,e,i,a){const s=e.worldUpAtPosition(t.origin,M.get()),n=M.get();switch(i){case Ci.HEADING:B(n,s);break;case Ci.TILT:B(n,t.basis1)}return Ht(t.origin,n,a)}function xp(t,e,i,a){const s=Pe(a.basis1),n=Pe(a.basis2),r=Mo(a),o=ys(a),l=Z(M.get(),0,0,0);z(l,Q(M.get(),a.basis1,e.direction[0]),Q(M.get(),a.basis2,e.direction[1])),z(l,a.origin,l);let d=0,p=1;if(Fa(e))e.direction[0]===1&&e.direction[1]===-1?d=Ms:e.direction[0]===1&&e.direction[1]===1?d=Math.PI:e.direction[0]===-1&&e.direction[1]===1&&(d=3*Math.PI/2),p=o;else{const _=e.direction[0]!==0?1:2;d=_===1?Ms:0,p=(_===1?n:s)-r}const g=xs(se.get(),d);Vi(g,g,Z(M.get(),p,p,p)),Ze(g,i,g),g[12]=0,g[13]=0,g[14]=0,t.modelTransform=g,t.renderLocation=l}function Ep(t,e,i,a){const s=a.worldUpAtPosition(i.origin,M.get()),n=Op(i,Gt.POSITIVE_X),r=xs(se.get(),n.edge*Math.PI/2);Tr(r,r,-Cp(i,s)),Ze(r,e,r),r[12]=0,r[13]=0,r[14]=0,t.modelTransform=r,t.renderLocation=n.position}var Gt;function Op(t,e){switch(e){case Gt.POSITIVE_X:return{basis:t.basis1,direction:1,position:z(M.get(),t.origin,t.basis1),edge:e};case Gt.POSITIVE_Y:return{basis:t.basis2,direction:1,position:z(M.get(),t.origin,t.basis2),edge:e};case Gt.NEGATIVE_X:return{basis:t.basis1,direction:-1,position:P(M.get(),t.origin,t.basis1),edge:e};case Gt.NEGATIVE_Y:return{basis:t.basis2,direction:-1,position:P(M.get(),t.origin,t.basis2),edge:e}}}function Mo(t){const e=Pe(t.basis1),i=Pe(t.basis2);return hp*Math.min(e,i)}function ys(t){return Mo(t)}function Fa(t){return t.direction[0]!==0&&t.direction[1]!==0}function Ap(t,e=Li.CENTER_ON_ARROW){const i=e===Li.CENTER_ON_CALLOUT?Ja:0,a=[N(i,0,-or/2),N(i,0,or/2)],s=$p(a,!0),n=(S,w)=>Rp(a,a,{tubeRadius:sp,tipRadius:rr,tipLength:np,tubeFocusMultiplier:Wd,tipFocusMultiplier:Zd,padding:S,bothEnds:!0,flat:null,focusTipLength:!0,addCap:w}),r=n(0,!1),o=n(rp,!0),l=new Ye({color:Kd,cullFace:K.Back,renderOccluded:D.Opaque}),d=new Ye({color:ep,cullFace:K.Back,renderOccluded:D.Opaque}),p=new Ye({color:tp,cullFace:K.Back,renderOccluded:D.Opaque}),g=new Ye({color:ap,transparent:!0,writeDepth:!1,cullFace:K.Front,renderOccluded:D.Transparent}),_=V.createPolylineGeometry([[i,0,0],[i-Ja,0,0]]),v=V.createPolylineGeometry([[i,0,0],[i-Ja,0,0]]),f=new Cs({color:ip,renderOccluded:D.OccludeAndTransparent});return new ce({view:t,renderObjects:[...r.normal.map(({part:S,geometry:w,transform:x})=>({geometry:w,material:S==="tip"?l:S==="cap"?d:p,transform:x,stateMask:E.Unfocused|xe})),...o.normal.map(({geometry:S,transform:w})=>({geometry:S,material:g,transform:w,stateMask:E.Unfocused|xe})),{geometry:_,material:f,stateMask:E.Unfocused|xe|bs},...r.focused.map(({part:S,geometry:w,transform:x})=>({geometry:w,material:S==="tip"?l:S==="cap"?d:p,transform:x,stateMask:E.Focused|xe})),...o.focused.map(({geometry:S,transform:w})=>({geometry:S,material:g,transform:w,stateMask:E.Focused|xe})),{geometry:v,material:f,stateMask:E.Focused|xe|bs}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:rr,state:xe})}function Tp(t,e){const i=new yp({transparent:!0,writeDepth:!1,textureId:e.id,renderOccluded:D.Opaque}),a=pp,s=up,n=s*Xd,r=g=>{const _=new Uint32Array([0,1,2,2,3,0]);return new Hr([[A.POSITION,{size:3,data:[a-g,-g,0,a+g,-g,0,a+g,g,0,a-g,g,0],exclusive:!0}],[A.UV0,{size:2,data:[0,0,1,0,1,1,0,1]}]],[[A.POSITION,_],[A.UV0,_]])},o=V.createPolylineGeometry([[0,0,0],[a-s,0,0]]),l=V.createPolylineGeometry([[0,0,0],[a-n,0,0]]),d=new Cs({color:Jd,renderOccluded:D.OccludeAndTransparent}),p=[{geometry:r(s),material:i,stateMask:E.Unfocused|xe},{geometry:o,material:d,stateMask:E.Unfocused|xe},{geometry:r(n),material:i,stateMask:E.Focused|xe},{geometry:l,material:d,stateMask:E.Focused|xe}];return new ce({view:t,renderObjects:p,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},collisionPriority:1,radius:s/2,state:xe})}function Pp(t,e){const i=Fa(e),a=i?[N(1,0,0),N(0,0,0),N(0,1,0)]:[N(1,0,0),N(-1,0,0)],s=V.createPolylineGeometry(a),n=op,r=f=>new ri({color:n,width:f,renderOccluded:D.OccludeAndTransparent}),o=()=>new Cs({color:n,renderOccluded:D.OccludeAndTransparent}),l=i?lp:lr,d=l*Yd,p=lr,g=f=>f>1?r(f):o(),_=[{geometry:s,material:g(l),stateMask:E.Unfocused|ha},{geometry:s,material:g(d),stateMask:E.Focused|ha},{geometry:s,material:g(p),stateMask:So}],v=new ce({view:t,renderObjects:_,collisionType:{type:"line",paths:[a]},autoScaleRenderObjects:!1,worldSized:!0,radius:i?cp:dp});return v.state=ha,v}function Rp(t,e,i){const a=s=>{const n=(s?e:t).slice(0),r=P(M.get(),n[0],n[1]);re(r,r);const o=P(M.get(),n[n.length-1],n[n.length-2]);if(re(o,o),i.padding>0){const O=Q(b(),o,-i.padding);if(n[n.length-1]=z(O,O,n[n.length-1]),i.bothEnds){const j=Q(b(),r,-i.padding);n[0]=z(j,j,n[0])}}const l=s?i.tipFocusMultiplier:1,d=i.tipLength*(i.focusTipLength?l:1),p=i.tipRadius*l,g=rs(se.get());if(i.padding>0){const O=d/4,j=Z(M.get(),0,O,0),de=1+i.padding/O;pa(g,g,j),Vi(g,g,Z(M.get(),de,de,de)),pa(g,g,Q(j,j,-1/de))}const _=rs(_e()),v=N(0,1,0),f=sn(_e(),vn(_n.get(),v,o));f[12]=n[n.length-1][0],f[13]=n[n.length-1][1],f[14]=n[n.length-1][2],Ze(f,f,g);const S=[{part:"tube",geometry:Dp(i.tubeRadius*(s?i.tubeFocusMultiplier:1)+i.padding,i.flat,n),transform:_}];let w,x;if(c(i.flat)?w=V.createExtrudedTriangle(d,p,p,i.flat.thickness):(w=V.createConeGeometry(d,p,24,!1,!1,!0),x=V.createConeGeometry(d,p,24,!1,!0,!1)),S.push({part:"tip",geometry:w,transform:f}),x&&S.push({part:"cap",geometry:x,transform:f}),i.bothEnds){const O=sn(_e(),vn(_n.get(),v,r));O[12]=n[0][0],O[13]=n[0][1],O[14]=n[0][2],Ze(O,O,g),S.push({part:"tip",geometry:w,transform:O}),x&&S.push({part:"cap",geometry:x,transform:O})}return S};return{normal:a(!1),focused:a(!0)}}function Dp(t,e,i){const a=[];if(c(e))a.push([t,e.thickness/2],[-t,e.thickness/2],[-t,-e.thickness/2],[t,-e.thickness/2]);else for(let n=0;n<12;n++){const r=n/12*2*Math.PI;a.push([Math.cos(r)*t,Math.sin(r)*t])}return V.createPathExtrusionGeometry(a,i,[],[],!1)}function $p(t,e){const i=P(b(),t[t.length-1],t[t.length-2]);if(re(i,i),Q(i,i,hr),z(i,i,t[t.length-1]),e){const a=P(b(),t[0],t[1]);return re(a,a),Q(a,a,hr),z(a,a,t[0]),[a,...t,i]}return[...t,i]}function Cp(t,e){return Ul(e,t.basis2,t.basis1)+Ms}(function(t){t[t.POSITIVE_X=0]="POSITIVE_X",t[t.POSITIVE_Y=1]="POSITIVE_Y",t[t.NEGATIVE_X=2]="NEGATIVE_X",t[t.NEGATIVE_Y=3]="NEGATIVE_Y"})(Gt||(Gt={}));const xe=ae.Custom1;var Ci,cr;(function(t){t[t.HEADING=1]="HEADING",t[t.TILT=2]="TILT"})(Ci||(Ci={})),function(t){t[t.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.TILTED=3]="TILTED"}(cr||(cr={}));const bs=ae.Custom2;Ni();const Ms=Math.PI/2,ha=ae.Custom1,So=ae.Custom2;var Li;(function(t){t[t.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",t[t.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(Li||(Li={}));const dr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAnFBMVEUAAAD/gAD/gAD/cAD/gAD/eAD/gAD/eQD/gAD/egD/gAD/ewD/gAD/fAD/gAD/fAD/gAD/fAD/fQD/fQD/fQD/fQD/fQD/fgD/jR7/mjn/mjf/p1H/plH/smf/sWb/vHr/u3n/xYz/xIv/zZz/zJv/zJr/1Kv/1Kr/06r/06n/27n/27f/4cX/4cT/59D/7dr/8uX/9u7/+/f////u2EN0AAAAM3RSTlMACBAQICAoKDAwODhAQEhIUFBYYGhweICIkJCXmJ+gp6ivsLe4uL+/wMDHx8/P19/n7/cWvjXwAAACeUlEQVR42tWX3XqiMBCGY2pbtbrUnzhhdak/lHWliJD7v7fdJ+KG5AMhh30P8zCTmS+TycDaeBoHi5Wgf4jVYvbKmRfPgSAHMX9mPRnM1tSIGHM/c2QddLp4c8wxCvYIvqROBPfbHlm/sRYC6smMNTKn3sxZAyvyYNW1v38MM/IkcPQnZHPMLtciz9P9hhqwzoLD+cnfpTIUaYinyZlBkE2YKZcMXCyN/YhsPkuFlMfWJLiwo89VMxfpJDForMCwuG+Zx7ttGO2S/w4LJ42ZURDty5M0a4dqsZAQAihQfXqWdlhnpcmdEPAI0tv2EbnsbsKmdgi6/1GN7T1XJLx5sF0P9SWABMC+co5JBE4Ge/1NTM3EGIJgjFONXCdAbeQYwhN7pRrRV20LJNIhWOczdu+xPFzIBiQ62iIsyIOTvlZUY+HXySLQaMUEeSC1CPYxENIlwk+q8e0clFAIfiKG+qpaIvod4wfU8sqvkDLda+xCCqgDaAk7uyeNqD+feFlfGCcg3Hzsk+xS7Nz1Aq4CcauhhMc0uxaqIgcFsF0J+1WQyoCN7Y9ezeCVH5LhSxmyRvsihKbK1m7LafpSpkpj6yJgtsiVBh6AX5UyCVmMbrNpcwj5/h6DPN79JjAiQAhXVeN6SZI0q5bQnn4wBiHEqpUybp1ZJzWxStVCHhKhAhVLp/Emh6trHpGLaB6yZHk7wu3Z+ChOxhwUNEmYYjpUvqJDksSHraQmJm2DdqQK6sGUObybYtpSN+8Phm3pN2xjDH33R6b0CKxAZNLvl8foD3BBnSw5e8RI+G2P8GD9wHw6YN3wkfA0R4Zz8CGCIfOCv8zM738walXuLw6nXBvPr8wvAAAAAElFTkSuQmCC",Lp={mipmap:!0,preMultiplyAlpha:!0,width:64,height:64};function Ip(t){return t.fromData(dr,()=>new Ur(dr,Lp))}class Gp{constructor(){this.lastDragEvent=null,this.next=new As,this._enabled=!1}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==e&&c(this.lastDragEvent)){const i={...this.lastDragEvent,action:"update"};e&&this._adjustScaleFactors(i),this.next.execute(i)}this._enabled=e}createDragEventPipelineStep(){return this.lastDragEvent=null,e=>(this.lastDragEvent=e.action!=="end"?{...e}:null,this._enabled&&this._adjustScaleFactors(e),e)}_adjustScaleFactors(e){const i=Fa(e.handle)?Math.max(Math.abs(e.factor1),Math.abs(e.factor2)):e.handle.direction[0]===0?Math.abs(e.factor2):Math.abs(e.factor1);e.factor1=e.factor1<0?-i:i,e.factor2=e.factor2<0?-i:i}get test(){return{_adjustScaleFactors:e=>this._adjustScaleFactors(e)}}}function oa(t,e){return wo(t,e,!1)}function pr(t,e){return wo(t,e,!0)}function wo(t,e,i){if(t instanceof Ih){if(t.operation instanceof Gh)return Vp(t.operation,e,i),!0;if(t.operation instanceof Vh)return zp(t.operation,e,i),!0;if(t.operation instanceof zh)return Np(t.operation,e,i),!0}return!1}function Vp(t,e,i=!1){const a=i?-1:1,s=N(a*t.dx,a*t.dy,a*t.dz);z(e.origin,e.origin,s)}function zp(t,e,i=!1){const a=i?-t.angle:t.angle;nn(e.basis1,e.basis1,ss,a),nn(e.basis2,e.basis2,ss,a)}function Np(t,e,i=!1){const a=i?1/t.factor1:t.factor1,s=i?1/t.factor2:t.factor2;Q(e.basis1,e.basis1,a),Q(e.basis2,e.basis2,s),rn(e.origin,e.origin,t.origin,t.axis1,a),rn(e.origin,e.origin,t.origin,t.axis2,s)}function Fp(t,e,i,a){a||(a=Xt());const s=ne(Mt.get(),t[1],-t[0]),n=ne(Mt.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r=ne(Mt.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),o=Mt.get();e.components.forEach(p=>p.vertices.forEach(g=>{const _=g.pos;ne(o,on(t,_),on(s,_)),_l(n,n,o),ml(r,r,o)}));const l=1e-6,d=ne(Mt.get(),r[0]-n[0]<l?i/2:0,r[1]-n[1]<l?i/2:0);return ws(n,n,d),St(r,r,d),ei(a.basis1,t,(r[0]-n[0])/2),ei(a.basis2,s,(r[1]-n[1])/2),ne(a.origin,n[0]*t[0]+n[1]*s[0],n[0]*t[1]+n[1]*s[1]),St(a.origin,a.origin,a.basis1),St(a.origin,a.origin,a.basis2),a}function Up(t,e,i,a=0,s){s||(s=Xt()),e.toRenderCoords(t.origin,i,s.origin);const n=M.get();z(n,t.origin,t.basis1),z(n,n,t.basis2),e.toRenderCoords(n,i,n);const r=M.get();z(r,t.origin,t.basis1),P(r,r,t.basis2),e.toRenderCoords(r,i,r);const o=M.get();P(o,t.origin,t.basis1),P(o,o,t.basis2),e.toRenderCoords(o,i,o);const l=M.get();P(l,t.origin,t.basis1),z(l,l,t.basis2),e.toRenderCoords(l,i,l);const d=bt(M.get(),n,r,.5);P(d,d,s.origin);const p=bt(M.get(),o,l,.5);P(p,s.origin,p),bt(s.basis1,d,p,.5);const g=bt(M.get(),l,n,.5);P(g,g,s.origin);const _=bt(M.get(),r,o,.5);P(_,s.origin,_),bt(s.basis2,g,_,.5);const v=Se(M.get(),s.basis1,s.basis2),f=Se(v,v,s.basis1);return re(f,f),Q(s.basis2,f,Ei(s.basis2,f)),Q(s.basis1,s.basis1,1+a/Pe(s.basis1)),Q(s.basis2,s.basis2,1+a/Pe(s.basis2)),Bh(s),s}function ur(t,e,i,a){const s=M.get();P(s,P(s,t.origin,t.basis1),t.basis2);const n=M.get();Lt(n,s,t.basis1,2);const r=M.get();Lt(r,n,t.basis2,2);const o=M.get();Lt(o,s,t.basis2,2),s[2]=n[2]=r[2]=o[2]=e;const l=a?"on-the-ground":"absolute-height",d=ln(Xi(s,n,i,l),Xi(o,r,i,l)),p=ln(Xi(n,r,i,l),Xi(s,o,i,l));return m(p)||m(d)?null:[d,p]}let Mi=class extends ht{constructor(t){super(t),this.type="extent-rotate",this.angle=0}};h([u()],Mi.prototype,"type",void 0),h([u()],Mi.prototype,"angle",void 0),Mi=h([k("esri.views.interactive.tooltip.ExtentRotateTooltipInfo")],Mi);let yt=class extends ht{constructor(t){super(t),this.type="extent-scale",this.xScale=0,this.yScale=0,this.xSize=xt,this.ySize=xt}};h([u()],yt.prototype,"type",void 0),h([u()],yt.prototype,"xScale",void 0),h([u()],yt.prototype,"yScale",void 0),h([u()],yt.prototype,"xSize",void 0),h([u()],yt.prototype,"ySize",void 0),yt=h([k("esri.views.interactive.tooltip.ExtentScaleTooltipInfo")],yt);let ue=class extends Ue.EventedMixin(Ra){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.tooltipOptions=new Je,this._preserveAspectRatio=new Gp,this.grabbing=!1,this.inputState=null,this.type="transform-3d",this.handles=new lt,this.moveZManipulator=null,this.resizeManipulators=null,this.rotateManipulator=null,this.attachmentOrigin=null,this.outlineVisualElement=null,this.mapBounds=Xt(),this.mapBoundsStart=Xt(),this.zmax=0,this.sizeStart=null,this.displayBounds=Xt(),this.displayBoundsStart=Xt(),this.displayBoundsMarginStart=0,this.resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._rotateTooltipInfo=null,this._scaleTooltipInfo=null,this._startAngle=0,this._endAngle=0,this._startScale=zt(),this._endScale=zt()}initialize(){const{view:t,graphic:e,manipulators:i,handles:a}=this,s=this.graphicState=new ye({graphic:e}),n=e.geometry;this.editGeometryOperations=$a.fromGeometry(n,t.state.viewingMode),this.graphicMoveManipulation=new Ns({tool:this,view:t,graphicState:s}),this.moveZManipulator=Ap(t,Li.CENTER_ON_CALLOUT),this.moveZManipulator.state|=bs,a.add([this._createMoveXYGraphicDragPipeline(),L(()=>this.enableZ,()=>this._updateManipulatorAvailability(this.moveZManipulator,C.TRANSLATE_Z)),this._createMoveZDragPipeline()]),i.add(this.moveZManipulator),this.resizeManipulators=this.resizeHandles.map(p=>{const g=Pp(t,p);return a.add([L(()=>this.enableScaling,()=>this._updateManipulatorAvailability(g,C.SCALE)),g.events.on("grab-changed",_=>this._onResizeGrab(_)),this._createResizeDragPipeline(g,p)]),g}),i.addMany(this.resizeManipulators),this.rotateManipulatorTexture=Ip(t.toolViewManager.textures),this.rotateManipulator=Tp(t,this.rotateManipulatorTexture.texture),a.add([L(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this.rotateManipulator,C.ROTATE)),this.rotateManipulator.events.on("grab-changed",p=>{this._onRotateGrab(p)}),this._createRotateDragPipeline(this.rotateManipulator)]),i.add(this.rotateManipulator),this._calculateMapBounds(),this._updateDisplayBounds();const r=Ga({view:t,graphic:e,forEachManipulator:p=>this._forEachManipulator(p),onManipulatorsChanged:()=>Vt()});c(r)&&(this.outlineVisualElement=r.visualElement instanceof jt?r.visualElement:null),c(this.outlineVisualElement)&&a.add(this.outlineVisualElement.events.on("attachment-origin-changed",()=>this._updateDisplayBounds())),a.add(r),a.add([s.on("changed",()=>this._onGeometryChanged()),L(()=>s.displaying,()=>this._updateAllManipulatorAvailability()),L(()=>s.isDraped,()=>this._graphicDrapedChanged(),qe),t.trackGraphicState(s)]);const o=t.pointsOfInterest;o&&a.add(L(()=>o.centerOnSurfaceFrequent.location,()=>this._updateDisplayBounds()));const l=p=>{a.add(p.events.on("grab-changed",()=>{this.grabbing=p.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(l);const d=(p,g)=>{a.add(p.events.on("immediate-click",_=>{g===C.TRANSLATE_XY&&this.emit("immediate-click",{..._,graphic:e}),_.stopPropagation()}))};this._forEachManipulator(d),this._onGeometryChanged(),this._updateAllManipulatorAvailability(),this._initializeTooltip(),this.finishToolCreation()}destroy(){this.mapBounds=null,this.displayBounds=null,this.rotateManipulatorTexture.release(),this.handles.destroy(),this.graphicMoveManipulation.destroy(),this.editGeometryOperations.destroy(),this._tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{handles:t,view:e}=this,i=this._tooltip=new zi({view:e}),a=()=>{i.info=this._getUpdatedTooltipInfo()};t.add([this.on("graphic-translate-start",a),this.on("graphic-translate",a),this.on("graphic-translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null,this._tooltip.clear()}),this.on("graphic-rotate-start",s=>{this._startAngle=s.angle,a()}),this.on("graphic-rotate",s=>{this._endAngle=s.angle,a()}),this.on("graphic-rotate-stop",()=>{this._startAngle=0,this._endAngle=0,a()}),this.on("graphic-scale-start",s=>{ne(this._startScale,s.xScale,s.yScale),ne(this._endScale,s.xScale,s.yScale),a()}),this.on("graphic-scale",s=>{ne(this._endScale,s.xScale,s.yScale),a()}),this.on("graphic-scale-stop",()=>{ne(this._startScale,0,0),ne(this._endScale,0,0),a()})]),this._forEachManipulator(s=>{t.add([s.events.on("focus-changed",a),s.events.on("grab-changed",a),s.events.on("drag",n=>{n.action==="cancel"?this._tooltip.clear():a()})])})}_getUpdatedTooltipInfo(){return this.tooltipOptions.enabled?this.graphicMoveManipulation.grabbing||this.graphicMoveManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():this.rotateManipulator.focused?this._computeRotateTooltipInfo():this.resizeManipulators.some(t=>t.focused)?this._computeScaleTooltipInfo():null:null}_computeMoveXYTooltipInfo(){return this._moveXYTooltipInfo=W(this._moveXYTooltipInfo,()=>new Te({tooltipOptions:this.tooltipOptions}))}_computeMoveZTooltipInfo(){const t=this._moveZTooltipInfo=W(this._moveZTooltipInfo,()=>new Ve({tooltipOptions:this.tooltipOptions})),e=this._moveUnit;if(this.moveZManipulator.dragging){const i=this.mapBoundsStart.origin,a=this.mapBounds.origin,s=Il(i,a,this.view.spatialReference);if(m(s))return null;t.distance=s}else t.distance=Ti(0,e);return t}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo=W(this._rotateTooltipInfo,()=>new Mi({tooltipOptions:this.tooltipOptions}));return t.angle=this._startAngle-this._endAngle,t}_computeScaleTooltipInfo(){const t=this.graphic.geometry;if(m(t))return null;const e=this._scaleTooltipInfo=W(this._scaleTooltipInfo,()=>new yt({tooltipOptions:this.tooltipOptions})),i=ur(this.mapBounds,this.zmax,t.spatialReference,this.graphicState.isDraped);return m(i)?null:(e.xSize=i[0],e.ySize=i[1],c(this.sizeStart)&&this.resizeManipulators.some(a=>a.dragging)?(e.xScale=i[0].value/this.sizeStart[0].value,e.yScale=i[1].value/this.sizeStart[1].value):(e.xScale=1,e.yScale=1),e)}_graphicDrapedChanged(){this.handles.remove(gr),this._updateDisplayBounds(),this.graphicState.isDraped&&this.handles.add(this.view.elevationProvider.on("elevation-change",t=>{c(this.attachmentOrigin)&&Er(t.extent,this.attachmentOrigin.x,this.attachmentOrigin.y)&&this._updateDisplayBounds()}),gr)}_updateAllManipulatorAvailability(){this._forEachManipulator((t,e)=>this._updateManipulatorAvailability(t,e))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof ce){const a=this.graphicState.displaying,s=this.enableZ&&Nt(this.graphic);switch(e){case C.ROTATE:t.available=a&&this.enableRotation;break;case C.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||s),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?ha:So;break;case C.TRANSLATE_Z:t.available=a&&s;break;default:t.available=a}}}_forEachManipulator(t){this.graphicMoveManipulation.forEachManipulator(t),this.resizeManipulators.forEach(e=>t(e,C.SCALE)),t(this.rotateManipulator,C.ROTATE),t(this.moveZManipulator,C.TRANSLATE_Z)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get _moveUnit(){return W(fl(this.view.spatialReference),"meters")}reset(){}_onGeometryChanged(){this._updateDisplayBounds()}_calculateMapBounds(){const t=this.graphic.geometry,e=this.editGeometryOperations.data,i=e.components[0].edges[0],a=ws(Mt.get(),i.leftVertex.pos,i.rightVertex.pos);ca(a,a);const s=W(Aa(this.view,this.graphic),()=>t.extent.center);let n=kp*this.view.pixelSizeAt(s);const r=this.view.spatialReference,o=t.spatialReference;r.equals(o)||(n*=os(r)/os(o)),Fp(a,e,n,this.mapBounds),this._calculateZMax()}_calculateZMax(){const t=this.editGeometryOperations.data;if(!t.geometry.hasZ)return void(this.zmax=0);const e=t.coordinateHelper;let i=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const s of a.vertices){const n=e.getZ(s.pos);i=Math.max(n,i)}this.zmax=i}_updateDisplayBounds(){const t=this.graphic.geometry;if(m(t))return;const e=c(this.outlineVisualElement)&&!this.graphicState.isDraped&&c(this.outlineVisualElement.attachmentOrigin)?this.outlineVisualElement.attachmentOrigin:Aa(this.view,this.graphic);this.attachmentOrigin=W(e,t.extent.center);const i=c(e)?e.z:$s(this.mapBounds.origin,this.view.elevationProvider,Bi.fromElevationInfo(X(this.graphic)),this.view.renderCoordsHelper),a=gt(this.mapBounds);a.origin[2]=i,Up(a,this.view.renderCoordsHelper,t.spatialReference,this.displayBoundsMargin,this.displayBounds),this._updateManipulators()}get displayBoundsMargin(){const t=this.view.pointsOfInterest,e=t?t.centerOnSurfaceFrequent.location:this.editGeometryOperations.data.geometry.extent.center;return Hp*this.view.pixelSizeAt(e)}_createMoveXYGraphicDragPipeline(){return this.graphicMoveManipulation.createDragPipeline((t,e,i)=>this._applyGraphicMoveSteps(e,i,G.XY))}_createMoveZDragPipeline(){const t=this.view,e=this.editGeometryOperations.data.spatialReference;return Ne(this.moveZManipulator,(i,a,s)=>{const n=ua(i.renderLocation),r=a.next(fo(t,n,e)).next(li());this._applyGraphicMoveSteps(r,s,G.Z)})}_applyGraphicMoveSteps(t,e,i){const a=t.next(s=>(s.action==="start"&&(this.inputState={type:"move"},gt(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.emit("graphic-translate-start",{graphic:this.graphic,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY})),s)).next(Zt()).next(this._moveDragUpdateGeometry()).next(s=>{const n={graphic:this.graphic,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY};switch(s.action){case"start":case"update":(s.mapEnd.x-s.mapStart.x||s.mapEnd.y-s.mapStart.y||s.mapEnd.z-s.mapStart.z)&&this.emit("graphic-translate",n);break;case"end":this.inputState=null,this.emit("graphic-translate-stop",n)}return s}).next(s=>this._updateMoveTooltip(s,i));return e.next(()=>{c(this.inputState)&&this.emit("graphic-translate-stop",{graphic:this.graphic,dxScreen:0,dyScreen:0}),this._cancel()}),a}_calculateSizeStart(){m(this.graphic.geometry)?this.sizeStart=null:this.sizeStart=ur(this.mapBoundsStart,this.zmax,this.graphic.geometry.spatialReference,this.graphicState.isDraped)}_moveDragUpdateGeometry(){return t=>{if(m(this.inputState)||this.inputState.type!=="move")return t;const e=[];for(const s of this.editGeometryOperations.data.components)e.push(...s.vertices);const i=t.action==="start"?st.NEW_STEP:st.ACCUMULATE_STEPS,a=this.editGeometryOperations.moveVertices(e,t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,i);return oa(a,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_updateMoveTooltip(t,e){if(e===G.XY||e===G.XY_AXIS){const i=Ai(t.mapStart,t.mapEnd,this.graphicState.isDraped?"on-the-ground":"absolute-height");c(i)&&c(this._moveXYTooltipInfo)&&(this._moveXYTooltipInfo.distance=i)}return t}_onResizeGrab(t){if(t.action!=="start")return;const e=this._calculatePickRay(t.screenPoint);ni(this.displayBounds.plane,e,M.get())&&(gt(this.displayBounds,this.displayBoundsStart),gt(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.displayBoundsMarginStart=this.displayBoundsMargin,this.inputState={type:"resize"})}_createResizeDragPipeline(t,e){return Ne(t,(i,a,s)=>{m(this.inputState)||(a.next(n=>(n.action==="start"&&this.emit("graphic-scale-start",{graphic:this.graphic,xScale:1,yScale:1}),n)).next(Ta(this.view,this.displayBoundsStart.plane)).next(n=>({...n,handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(this._preserveAspectRatio.createDragEventPipelineStep(),this._preserveAspectRatio.next).next(this._resizeDragUpdateGeometry()).next(n=>{const r={graphic:this.graphic,xScale:n.factor1,yScale:n.factor2};switch(n.action){case"start":case"update":this.emit("graphic-scale",r);break;case"end":this.inputState=null,this.emit("graphic-scale-stop",r)}return n}),s.next(()=>{c(this.inputState)&&this.emit("graphic-scale-stop",{graphic:this.graphic,xScale:1,yScale:1}),this._cancel()}))})}_resizeDragRenderPlaneToFactors(){return t=>{const e=this.displayBoundsStart,i=t.handle.direction,a=this.displayBoundsMargin,s=this.displayBoundsMarginStart,n=B(M.get(),e.origin);Lt(n,n,e.basis1,-i[0]),Lt(n,n,e.basis2,-i[1]);const r=P(M.get(),t.renderEnd,n),o=P(M.get(),t.renderStart,n),l=Fa(t.handle),d=ys(e),p=ys(this.displayBounds)/d,g=(_,v)=>{if(_===0)return 1;let f=Pe(v),S=.5*_*Ei(v,r)/f;const w=S<0?-1:1;l&&(S+=(f-.5*_*Ei(v,o)/f)*w*p);const x=f<1.5*s?1:_r;return f=Math.max(f-s,_r),w>0&&(S-=a),w*Math.max(w*(S/f),x)};return{...t,factor1:g(i[0],e.basis1),factor2:g(i[1],e.basis2)}}}_resizeDragUpdateGeometry(){return t=>{const e=B(b(),this.mapBoundsStart.origin);Lt(e,e,this.mapBoundsStart.basis1,-t.handle.direction[0]),Lt(e,e,this.mapBoundsStart.basis2,-t.handle.direction[1]);const i=ne(zt(),this.mapBoundsStart.basis1[0],this.mapBoundsStart.basis1[1]);ca(i,i);const a=[];for(const r of this.editGeometryOperations.data.components)a.push(...r.vertices);const s=t.action==="start"?st.NEW_STEP:st.ACCUMULATE_STEPS,n=this.editGeometryOperations.scaleVertices(a,e,i,t.factor1,t.factor2,s,fn.REPLACE);return gt(this.mapBoundsStart,this.mapBounds),oa(n,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_onRotateGrab(t){if(t.action!=="start")return;const e=wp(this.displayBounds,this.view.renderCoordsHelper,Ci.HEADING,hi()),i=this._calculatePickRay(t.screenPoint);ni(e,i,M.get())&&(gt(this.displayBounds,this.displayBoundsStart),gt(this.mapBounds,this.mapBoundsStart),this._calculateSizeStart(),this.inputState={type:"rotate",rotatePlane:e})}_createRotateDragPipeline(t){return Ne(t,(e,i,a)=>{const s=this.inputState;m(s)||(i.next(n=>(n.action==="start"&&this.emit("graphic-rotate-start",{graphic:this.graphic,angle:0}),n)).next(Ta(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdateGeometry()).next(n=>{const r={graphic:this.graphic,angle:Oi(n.rotateAngle)};switch(n.action){case"start":case"update":this.emit("graphic-rotate",r);break;case"end":this.inputState=null,this.emit("graphic-rotate-stop",r)}return n}),a.next(()=>{c(this.inputState)&&this.emit("graphic-rotate-stop",{graphic:this.graphic,angle:0}),this._cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const i=Fi(t.rotatePlane),a=oo(e.renderStart,e.renderEnd,this.displayBounds.origin,i);return{...e,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){return t=>{const e=B(b(),this.mapBoundsStart.origin),i=[];for(const n of this.editGeometryOperations.data.components)i.push(...n.vertices);const a=t.action==="start"?st.NEW_STEP:st.ACCUMULATE_STEPS,s=this.editGeometryOperations.rotateVertices(i,e,t.rotateAngle,a,fn.REPLACE);return gt(this.mapBoundsStart,this.mapBounds),oa(s,this.mapBounds),this.graphic.geometry=this.editGeometryOperations.data.geometry,t}}_calculatePickRay(t){const e=Ni(),i=fa(t);return ai(this.view.state.camera,i,e),re(e.direction,e.direction),e}_updateManipulators(){if(!this.visible)return;const t=Sp(this.displayBounds,se.get());Ep(this.rotateManipulator,t,this.displayBounds,this.view.renderCoordsHelper),this._updateZMoveHandle(this.moveZManipulator,t),this.resizeManipulators.forEach((e,i)=>{xp(e,this.resizeHandles[i],t,this.displayBounds)})}_updateZMoveHandle(t,e){const i=this.displayBounds,a={basis:i.basis1,direction:-1,position:P(M.get(),i.origin,i.basis1),edge:2},s=se.get();vl(s,e,a.edge*Math.PI/2),s[12]=0,s[13]=0,s[14]=0,t.modelTransform=s,t.renderLocation=a.position}_cancel(){const t=this.editGeometryOperations.lastOperation;m(t)||(this.editGeometryOperations.undo(),this.graphic.geometry=this.editGeometryOperations.data.geometry,pr(t,this.mapBounds),this._updateDisplayBounds(),this.inputState=null)}get canUndo(){return this.editGeometryOperations.canUndo}undo(){if(c(this.inputState))this.view.activeTool=null;else if(this.canUndo){const t=this.editGeometryOperations.undo();this.graphic.geometry=this.editGeometryOperations.data.geometry,pr(R(t),this.mapBounds),this._updateDisplayBounds()}}get canRedo(){return this.editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this.editGeometryOperations.redo();this.graphic.geometry=this.editGeometryOperations.data.geometry,oa(R(t),this.mapBounds),this._updateDisplayBounds()}}get test(){return{resizeManipulators:this.resizeManipulators,rotateManipulator:this.rotateManipulator,moveZManipulator:this.moveZManipulator,tooltip:this._tooltip}}};h([u({constructOnly:!0,nonNullable:!0})],ue.prototype,"view",void 0),h([u({constructOnly:!0,nonNullable:!0})],ue.prototype,"graphic",void 0),h([u({constructOnly:!0,nonNullable:!0})],ue.prototype,"enableZ",void 0),h([u()],ue.prototype,"enableRotation",void 0),h([u()],ue.prototype,"enableScaling",void 0),h([u({constructOnly:!0,type:Je})],ue.prototype,"tooltipOptions",void 0),h([u()],ue.prototype,"preserveAspectRatio",null),h([u()],ue.prototype,"grabbing",void 0),h([u()],ue.prototype,"inputState",void 0),h([u({readOnly:!0})],ue.prototype,"type",void 0),h([u()],ue.prototype,"_moveUnit",null),ue=h([k("esri.views.3d.interactive.editingTools.graphicTransform3D.ExtentTransformTool")],ue);const gr="draped-elevation-changes",Hp=10,kp=80,_r=1e-6,vu=Object.freeze(Object.defineProperty({__proto__:null,get DrawGraphicTool3D(){return Ke},get GraphicMoveTool(){return Be},get GraphicReshapeTool(){return ie},get GraphicTransformTool(){return pe},get ExtentTransformTool(){return ue}},Symbol.toStringTag,{value:"Module"}));export{mp as a,vu as e,Ic as f,Gs as h,lc as m,gp as t,ac as v};
